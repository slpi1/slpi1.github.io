<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="PHP,Laravel,thinkPHP,javascript,css">
<meta property="og:type" content="website">
<meta property="og:title" content="easy note">
<meta property="og:url" content="http://blog.slpi1.com/page/2/index.html">
<meta property="og:site_name" content="easy note">
<meta property="og:description" content="PHP,Laravel,thinkPHP,javascript,css">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="easy note">
<meta name="twitter:description" content="PHP,Laravel,thinkPHP,javascript,css">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"right","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.slpi1.com/page/2/"/>





  <title>easy note</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">easy note</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">easy note</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.slpi1.com/20210219/laravel/queue.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="slpi1">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="easy note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/20210219/laravel/queue.html" itemprop="url">未命名</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-02-19T15:44:38+08:00">
                2021-02-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="laravel-队列部分源码阅读"><a href="#laravel-队列部分源码阅读" class="headerlink" title="laravel 队列部分源码阅读"></a>laravel 队列部分源码阅读</h1><h1 id="一、-依赖的服务"><a href="#一、-依赖的服务" class="headerlink" title="一、 依赖的服务"></a>一、 依赖的服务</h1><h2 id="Illuminate-Queue-QueueServiceProvider"><a href="#Illuminate-Queue-QueueServiceProvider" class="headerlink" title="Illuminate\Queue\QueueServiceProvider"></a>Illuminate\Queue\QueueServiceProvider</h2><p>队列服务由服务提供者QueueServiceProvider注册。</p>
<ul>
<li>registerManager() 注册队列管理器，同时添加 Null/Sync/Database/Redis/Beanstalkd/Sqs 连接驱动<ul>
<li>Null：不启动队列，生产者产生的任务被丢弃</li>
<li>Sync：同步队列，生产者产生的任务直接执行</li>
<li>Database：数据库队列驱动，生产者产生的任务放入数据库</li>
<li>Redis：Redis队列驱动，生产者产生的任务放入Redis</li>
<li>Beanstalkd：略过</li>
<li>Sqs：略过</li>
</ul>
</li>
<li>registerConnection() 注册队列连接获取闭包，当需要用到队列驱动连接时，实例化连接</li>
<li>registerWorker() 注册队列消费者</li>
<li>registerListener() Listen模式注册队列消费者</li>
<li>registerFailedJobServices() 注册失败任务服务</li>
</ul>
<table>
<thead>
<tr>
<th>注册方法</th>
<th>对象</th>
<th>别名</th>
</tr>
</thead>
<tbody>
<tr>
<td>QueueServiceProvider::registerManager()</td>
<td>\Illuminate\Queue\QueueManager::class</td>
<td>queue</td>
</tr>
<tr>
<td>QueueServiceProvider::registerConnection()</td>
<td>\Illuminate\Queue\Queue::class</td>
<td>queue.connection</td>
</tr>
<tr>
<td>QueueServiceProvider::registerWorker()</td>
<td>\Illuminate\Queue\Worker::class</td>
<td>queue.worker</td>
</tr>
<tr>
<td>QueueServiceProvider::registerListener()</td>
<td>\Illuminate\Queue\Listener::class</td>
<td>queue.listener</td>
</tr>
<tr>
<td>QueueServiceProvider::registerFailedJobServices()</td>
<td>\Illuminate\Queue\Failed\FailedJobProviderInterface::class</td>
<td>queue.failer</td>
</tr>
</tbody>
</table>
<h2 id="Illuminate-Bus-BusServiceProvider"><a href="#Illuminate-Bus-BusServiceProvider" class="headerlink" title="Illuminate\Bus\BusServiceProvider"></a>Illuminate\Bus\BusServiceProvider</h2><p>这个服务提供者注册了Dispatcher这个服务，可以将具体的任务派发到队列。</p>
<h1 id="二、-任务机制"><a href="#二、-任务机制" class="headerlink" title="二、 任务机制"></a>二、 任务机制</h1><p>一个可放入队列的任务类：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Bus</span>\<span class="title">Queueable</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Queue</span>\<span class="title">SerializesModels</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Queue</span>\<span class="title">InteractsWithQueue</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Queue</span>\<span class="title">ShouldQueue</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Bus</span>\<span class="title">Dispatchable</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Job</span> <span class="keyword">implements</span> <span class="title">ShouldQueue</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Dispatchable</span>, <span class="title">InteractsWithQueue</span>, <span class="title">Queueable</span>, <span class="title">SerializesModels</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>任务在队列中需要经过两个过程：一个是任务入队，就是将要执行的任务，放到队列中去的过程，所有会发生这一过程的业务、对象、调用等等，可以统称为生产者；与之对应的，将任务从队列中取出，并执行的过程，叫做任务出队，所有会发生这一过程的业务、对象、调用等等，可以统称为消费者。</p>
<h2 id="2-1-任务的要素"><a href="#2-1-任务的要素" class="headerlink" title="2.1 任务的要素"></a>2.1 任务的要素</h2><h3 id="2-1-1-Illuminate-Foundation-Bus-Dispatchable"><a href="#2-1-1-Illuminate-Foundation-Bus-Dispatchable" class="headerlink" title="2.1.1 Illuminate\Foundation\Bus\Dispatchable"></a>2.1.1 Illuminate\Foundation\Bus\Dispatchable</h3><p>这个trait给任务添加了两个静态方法<code>dispatch/withChain</code>，赋予了任务派发的接口。</p>
<ol>
<li><code>dispatch</code></li>
</ol>
<p>dispatch方法触发任务指派动作。当执行 <code>Job::dispatch()</code>时，会实例化一个<code>Illuminate\Foundation\Bus\PendingDispatch</code>对象<code>PendingDispatch</code>，并且将任务调用类实例化后的对象<code>job</code>当作构造函数的参数：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Illuminate\Foundation\Bus\Dispatchable::trait</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 这里的static转发到实际执行dispath的类 Job::dispatch，也就是Job类</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PendingDispatch(<span class="keyword">new</span> <span class="keyword">static</span>(...func_get_args()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>PendingDispatch</code>对象接下来可以通过链式调用来指定队列相关信息 <code>onConnection/onQueue/allOnConnection/allOnQueue/delay/chain</code>，然后在析构函数中，做实际的派发动作：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Illuminate\Foundation\Bus\PendingDispatch::class</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Illuminate\Contracts\Bus\Dispatcher</span></span><br><span class="line">    <span class="comment">// 这个服务由Illuminate\Bus\BusServiceProvider注册</span></span><br><span class="line">    app(Dispatcher::class)-&gt;dispatch(<span class="keyword">$this</span>-&gt;job);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>PendingDispath</code>这个中间指派者的作用，就是引出这里从容器中解析出来的服务<code>Dispatcher::class</code>，真正的任务指派者<code>Dispatcher</code>。</p>
<ol>
<li><code>withChain</code></li>
</ol>
<p>withChain用于指定应该按顺序运行的队列列表。它只是一个语法糖，实际上的效果等同于：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. withChain的用法</span></span><br><span class="line">Job::withChain([</span><br><span class="line">    <span class="keyword">new</span> OptimizePodcast,</span><br><span class="line">    <span class="keyword">new</span> ReleasePodcast</span><br><span class="line">])-&gt;dispatch();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 等同于dispatch的用法</span></span><br><span class="line">Job::dispatch()-&gt;chain([</span><br><span class="line">    <span class="keyword">new</span> OptimizePodcast,</span><br><span class="line">    <span class="keyword">new</span> ReleasePodcast</span><br><span class="line">])</span><br></pre></td></tr></table></figure></p>
<h3 id="2-1-2-Illuminate-Bus-Queueable"><a href="#2-1-2-Illuminate-Bus-Queueable" class="headerlink" title="2.1.2 Illuminate\Bus\Queueable"></a>2.1.2 Illuminate\Bus\Queueable</h3><p>上文提到的<code>PendingDispath</code>，可以指定队列信息的方法，都是转发到任务对应的方法进行调用，Queueable就是实现了这部分的功能。这部分包括以下接口：</p>
<table>
<thead>
<tr>
<th>方法名</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>onConnection</td>
<td>指定连接名</td>
</tr>
<tr>
<td>onQueue</td>
<td>指定队列名</td>
</tr>
<tr>
<td>allOnConnection</td>
<td>指定工作链的连接名</td>
</tr>
<tr>
<td>allOnQueue</td>
<td>指定工作链的队列名</td>
</tr>
<tr>
<td>delay</td>
<td>设置延迟执行时间</td>
</tr>
<tr>
<td>chain</td>
<td>指定工作链</td>
</tr>
</tbody>
</table>
<p>以及最后一个方法<code>dispatchNextJobInChain</code>。上述方法都是在任务执行前调用，设置任务相关参数。<code>dispatchNextJobInChain</code>是在任务执行期间，如果检查到任务定义了工作链，就会派发工作链上面的任务到队列中。</p>
<h3 id="2-1-3-Illuminate-Queue-SerializesModels"><a href="#2-1-3-Illuminate-Queue-SerializesModels" class="headerlink" title="2.1.3 Illuminate\Queue\SerializesModels"></a>2.1.3 Illuminate\Queue\SerializesModels</h3><p>这个trait的作用是字符串化任务信息，方便将任务信息保存到数据库或Redis等存储器中，然后在队列的消费端取出任务信息，并据此重新实例化为任务对象，便于执行任务。</p>
<h3 id="2-1-4-Illuminate-Queue-InteractsWithQueue"><a href="#2-1-4-Illuminate-Queue-InteractsWithQueue" class="headerlink" title="2.1.4 Illuminate\Queue\InteractsWithQueue"></a>2.1.4 Illuminate\Queue\InteractsWithQueue</h3><p>这个trait赋予了任务与队列进行数据交互的能力。InteractsWithQueue是任务的必要组成，如果一个任务只能被执行，而不能与队列进行交互，那么这个任务在队列中的状态就是未知的，必然会造成混乱。InteractsWithQueue与队列的交互能力来源于$job属性，它是一个QueueJob实例，需要与任务的概念进行区别：任务是泛指可执行的对象，而这个$job，是在任务出队以后，解析出来的QueueJob对象。</p>
<p>即时一个任务类实现了InteractsWithQueue，它在实例化的时候并没有$job这个属性。需要等到出队后的执行过程中，这个$job才被手动设置给任务。</p>
<h3 id="2-1-5-Illuminate-Contracts-Queue-ShouldQueue"><a href="#2-1-5-Illuminate-Contracts-Queue-ShouldQueue" class="headerlink" title="2.1.5 Illuminate\Contracts\Queue\ShouldQueue"></a>2.1.5 Illuminate\Contracts\Queue\ShouldQueue</h3><p>ShouldQueue也是是任务的必要实现的接口。只有实现了ShouldQueue接口的任务，才可以被放入队列。上文所提到的真正的任务指派者<code>Dispatcher</code>，它在<code>PendingDispath</code>销毁时所执行的<code>dispatch</code>方法代码如下：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Illuminate\Bus\Dispatcher::class</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span><span class="params">($command)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 检查任务指派者是否注入了队列服务</span></span><br><span class="line">    <span class="comment">// 并且当前任务需要方法队列</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;queueResolver &amp;&amp; <span class="keyword">$this</span>-&gt;commandShouldBeQueued($command)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;dispatchToQueue($command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;dispatchNow($command);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>commandShouldBeQueued</code>方法的作用就是检查任务对象是否实现了ShouldQueue接口。如果是，就是执行dispatchToQueue方法，将任务放入队列之中；否则执行dispatchNow，放入队列执行栈（pipeline），进行同步执行。</p>
<h2 id="2-2-任务入队"><a href="#2-2-任务入队" class="headerlink" title="2.2 任务入队"></a>2.2 任务入队</h2><p>任务是如何被放入队列中的呢？这就引出了payload这个概念。当Dispatcher这个服务通过dispatch方法派发任务时，会通过队列服务，将任务push到队列中，在push的过程中会执行createPayloadArray方法：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Illuminate\Queue\Queue</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">createPayloadArray</span><span class="params">($job, $data = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 如果我们文中所提到的“任务”，是一个对象的话，会调用createObjectPayload方法</span></span><br><span class="line">    <span class="comment">// 进行一次封装，将封装后的数据Payload存入队列，如果不是一个对象的话，调用</span></span><br><span class="line">    <span class="comment">// createStringPayload进行一次封装，然后存入队列</span></span><br><span class="line">    <span class="keyword">return</span> is_object($job)</span><br><span class="line">                ? <span class="keyword">$this</span>-&gt;createObjectPayload($job)</span><br><span class="line">                : <span class="keyword">$this</span>-&gt;createStringPayload($job, $data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">createObjectPayload</span><span class="params">($job)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="string">'displayName'</span> =&gt; <span class="keyword">$this</span>-&gt;getDisplayName($job),</span><br><span class="line">        <span class="string">'job'</span> =&gt; <span class="string">'Illuminate\Queue\CallQueuedHandler@call'</span>,</span><br><span class="line">        <span class="string">'maxTries'</span> =&gt; $job-&gt;tries ?? <span class="keyword">null</span>,</span><br><span class="line">        <span class="string">'timeout'</span> =&gt; $job-&gt;timeout ?? <span class="keyword">null</span>,</span><br><span class="line">        <span class="string">'timeoutAt'</span> =&gt; <span class="keyword">$this</span>-&gt;getJobExpiration($job),</span><br><span class="line">        <span class="string">'data'</span> =&gt; [</span><br><span class="line">            <span class="string">'commandName'</span> =&gt; get_class($job),</span><br><span class="line">            <span class="string">'command'</span> =&gt; serialize(<span class="keyword">clone</span> $job),</span><br><span class="line">        ],</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">createStringPayload</span><span class="params">($job, $data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="string">'displayName'</span> =&gt; is_string($job) ? explode(<span class="string">'@'</span>, $job)[<span class="number">0</span>] : <span class="keyword">null</span>,</span><br><span class="line">        <span class="string">'job'</span> =&gt; $job, <span class="string">'maxTries'</span> =&gt; <span class="keyword">null</span>,</span><br><span class="line">        <span class="string">'timeout'</span> =&gt; <span class="keyword">null</span>, <span class="string">'data'</span> =&gt; $data,</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>createObjectPayload/createStringPayload</code> 这两个方法return的数组就是payload，是便于存储的一种格式。请特别注意 <code>Illuminate\Queue\CallQueuedHandler@call</code> 这部分出现的CallQueuedHandler这个对象，他是任务机制中的重要一环。</p>
<h2 id="2-3-任务出队"><a href="#2-3-任务出队" class="headerlink" title="2.3 任务出队"></a>2.3 任务出队</h2><p>任务出队是建立在消费者开始工作的基础之上的。在laravel的应用中，一类消费者就是Worker，队列处理器。通过命令行<code>php artisan queue:work</code>来启动一个Worker。Worker在daemon模式下，会不断的尝试从队列中取出任务并执行，这一过程有以下执行环节：</p>
<ul>
<li>第一步：检查是否要暂停队列，是则暂停一段时间，否则经行下一步</li>
<li>第二步：取出当前要执行的任务，并给任务设置一个超时进程，</li>
<li>第三步：执行任务，如果当前没有任务，暂停一段时间</li>
<li>第四步：检查是否要停止队列</li>
</ul>
<p>遇到三种情况会停止队列：</p>
<ul>
<li>Worker进程收到SIGTERM信号</li>
<li>使用内存超过限制</li>
<li>收到重启命令</li>
</ul>
<p>第二步就是任务出队的过程。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 该方法表示，从连接$connection中，名称为$queue的队列中取出下一个任务。</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getNextJob</span><span class="params">($connection, $queue)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (explode(<span class="string">','</span>, $queue) <span class="keyword">as</span> $queue) &#123;</span><br><span class="line">            <span class="keyword">if</span> (! is_null($job = $connection-&gt;pop($queue))) &#123;</span><br><span class="line">                <span class="keyword">return</span> $job;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;exceptions-&gt;report($e);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;stopWorkerIfLostConnection($e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable $e) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;exceptions-&gt;report($e = <span class="keyword">new</span> FatalThrowableError($e));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;stopWorkerIfLostConnection($e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果队列驱动使用的时Database，那么$connection指的就是Illuminate\Queue\DatabaseQueue的实例，如果队列驱动使用的时Redis，那么$connection指的就是Illuminate\Queue\RedisQueue的实例。</p>
<p>$connection的pop方法会从队列存储中取出下一个payload，经过队列驱动的转化，得到不同的QueueJob实例，也就是上文提到的$job对象，调用$job的fire方法，任务就开始执行。</p>
<h2 id="2-4-任务执行-CallQueuedHandler"><a href="#2-4-任务执行-CallQueuedHandler" class="headerlink" title="2.4 任务执行 - CallQueuedHandler"></a>2.4 任务执行 - CallQueuedHandler</h2><p>CallQueuedHandler就像是队列这个轨道上的一辆车，是任务机制中的重要环节。</p>
<p>我们可以把入队与出队称为队列的“内部操作”，他们是属于Queue这个概念之内的问题。而CallQueuedHandler可以看成Queue与外部任务对接的“标准接口”，如果把所有要执行的任务称为“可执行对象”，那么，只需要用CallQueueHandle这个对象来装载“可执行对象”，就可以让这个“可执行对象”利用队列的机制来执行。</p>
<p>在入队时，CallQueueHandle与“可执行对象”组合成为payload。在出队时，payload重放成为QueueJob，QueueJob调用fire的下一个环节，就是CallQueueHandle。</p>
<h3 id="2-4-1-CallQueuedHandler的作用"><a href="#2-4-1-CallQueuedHandler的作用" class="headerlink" title="2.4.1 CallQueuedHandler的作用"></a>2.4.1 CallQueuedHandler的作用</h3><p>在入队与出队的过程中，CallQueuedHandler并不发生任何作用，他只是随payload在队列的存储中流转进出。当任务被取出执行时，CallQueuedHandler就开始发挥作用。CallQueuedHandler的作用可以归纳为两点：</p>
<ul>
<li>继承QueueJob调用的fire方法，转发到CallQueuedHandler的handle方法，然后启动任务的执行方法。</li>
<li>处理任务执行结果与队列中数据（payload）的去留关系</li>
</ul>
<h3 id="2-4-2-任务执行的调用栈"><a href="#2-4-2-任务执行的调用栈" class="headerlink" title="2.4.2 任务执行的调用栈"></a>2.4.2 任务执行的调用栈</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">QueueJob::fire() -&gt;  CallQueuedHandler::handle() -&gt;  [任务或其他可执行对象调用]</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// worker-&gt;process()  消费者执行一个任务</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span><span class="params">($connectionName, $job, WorkerOptions $options)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;raiseBeforeJobEvent($connectionName, $job);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;markJobAsFailedIfAlreadyExceedsMaxAttempts(</span><br><span class="line">            $connectionName, $job, (int) $options-&gt;maxTries</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        $job-&gt;fire();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;raiseAfterJobEvent($connectionName, $job);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;handleJobException($connectionName, $job, $options, $e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable $e) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;handleJobException(</span><br><span class="line">            $connectionName, $job, $options, <span class="keyword">new</span> FatalThrowableError($e)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Job-&gt;fire()</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fire</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $payload = <span class="keyword">$this</span>-&gt;payload();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析队列任务信息，查看上文中的createPayload方法：  $payload = ['job' =&gt; 'Illuminate\Queue\CallQueuedHandler@call']</span></span><br><span class="line">    <span class="comment">// 所以这里$class = Illuminate\Queue\CallQueuedHandler, $method = call</span></span><br><span class="line">    <span class="keyword">list</span>($class, $method) = JobName::parse($payload[<span class="string">'job'</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果payload是通过CallQueuedHandler进行包装的，那么此时instance就是CallQueuedHandler的实例，method就是call方法</span></span><br><span class="line">    <span class="comment">// 如果payload是通过字符串进行包装的，那么此时的instance就是制定的任务对象，method就是制定的调用方法</span></span><br><span class="line">    (<span class="keyword">$this</span>-&gt;instance = <span class="keyword">$this</span>-&gt;resolve($class))-&gt;&#123;$method&#125;(<span class="keyword">$this</span>, $payload[<span class="string">'data'</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-5-小结"><a href="#2-5-小结" class="headerlink" title="2.5 小结"></a>2.5 小结</h2><p>laravel提供的队里机制的执行调用栈，就是上述过程。当我们指队列的任务机制时，包含的内容有以下两点：</p>
<ul>
<li>队列底层提供的入队与出队机制</li>
<li>任务出队后的执行调用栈</li>
</ul>
<h1 id="三、-事件机制"><a href="#三、-事件机制" class="headerlink" title="三、 事件机制"></a>三、 事件机制</h1><p>在充分理解任务机制的前提下，事件机制就很好理解了。事件监听器的原理是，通过Illuminate\Events\CallQueuedListener 来作为一个特殊的“任务”，将事件绑定与监听信息保存到这个“任务”中，当事件被触发时，通过事件解析出与之对应的“任务”，然后对这个“任务”进行派发，执行这个“任务”时，再去执行事件监听器。所以，这个环节的重点其实是，事件、监听器、CallQueuedListener三者之间是如何进行关联的，也就是事件监听机制。所以我们后面在分析laravel事件机制相关源码时，遇到CallQueuedListener这个对象时就知道，这是要开始与队列进行对接了。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 触发一个事件</span></span><br><span class="line">event(<span class="keyword">new</span> Event);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 从触发事件到进入队列的过程形容如下</span></span><br><span class="line">$eventCommand = <span class="keyword">new</span> \Illuminate\Events\CallQueuedListener(<span class="keyword">new</span> Event);</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> PendingDispatch($eventCommand);</span><br></pre></td></tr></table></figure>
<h1 id="四、-消息机制-Notification"><a href="#四、-消息机制-Notification" class="headerlink" title="四、 消息机制 Notification"></a>四、 消息机制 Notification</h1><p>消息机制的实现与事件机制类似。通过Illuminate\Notifications\SendQueuedNotifications 来作为一个特殊的“任务”，与消息相关信息进行关联，通过SendQueuedNotifications对象来完成入队与出队相关过程，然后在执行“任务”SendQueuedNotifications的时候解析出关联的notifiables和notification，然后据此执行消息相关逻辑。</p>
<h1 id="五、-手动入队"><a href="#五、-手动入队" class="headerlink" title="五、 手动入队"></a>五、 手动入队</h1><p>上面提到的都是系统提供的队列机制，除此之外，你还可以手动推送任务到队列，即通过Queue Facade来指派任务。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MyTask</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTask</span> <span class="keyword">implements</span> <span class="title">ShouldQueue</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Dispatchable</span>, <span class="title">InteractsWithQueue</span>, <span class="title">Queueable</span>, <span class="title">SerializesModels</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($job, $args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"MyTask"</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 推送至队列</span></span><br><span class="line">Queue::push(<span class="string">'MyTask@handle'</span>, $args, $queueName);</span><br><span class="line"></span><br><span class="line"><span class="comment">// MyAnotherTask</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyAnotherTask</span> <span class="keyword">implements</span> <span class="title">ShouldQueue</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Dispatchable</span>, <span class="title">InteractsWithQueue</span>, <span class="title">Queueable</span>, <span class="title">SerializesModels</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"MyTask"</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 推送至队列</span></span><br><span class="line">Queue::push(<span class="keyword">new</span> MyAnotherTask, $args, $queueName);</span><br></pre></td></tr></table></figure></p>
<h2 id="5-1-入队对象是一个实例"><a href="#5-1-入队对象是一个实例" class="headerlink" title="5.1 入队对象是一个实例"></a>5.1 入队对象是一个实例</h2><p>通过实例的方式，将任务推送到队列中，在createPayload的环节，执行的是createObjectPayload方法，这时可以利用系统提供的队列机制，实例只需要有一个handle方法作为执行方法，来承接CallQueuedHandler::handle()传递的调用栈。此时，handle方法只需要业务本身涉及到的数据作为参数。</p>
<h2 id="5-2-入队对象是一个字符串"><a href="#5-2-入队对象是一个字符串" class="headerlink" title="5.2 入队对象是一个字符串"></a>5.2 入队对象是一个字符串</h2><p>通过字符串的方式，将任务推送到队列中，在createPayload的环节，执行的是createStringPayload方法，这时无法利用系统体统的队列机制中的第二层内容：执行调用栈，在QueueJob::fire()之后会调用字符串指定的对象及方法。此时，方法除了需要业务本身涉及的数据作为参数外，还需要任务重放得到的QueueJob对象，作为第一个参数，所以上面代码中两个自定义任务的函数签名是不同的。</p>
<p>如果仅仅通过上述代码来执行的话，<code>MyAnotherTask</code>这个任务可能会一直执行下去，原因是缺少对执行任务后的处理：如果任务执行成功，因该从队列中删除掉；如果执行失败，也要有对应的处理措施。也就是CallQueuedHandler的第二个作用。我们不妨来看看CallQueuedHandler，是如何来处理这个问题的。</p>
<p>无论是系统的任务机制，或是事件机制，消费端从队列中取出任务信息后，还原出一个Job对象（RedisJob/DatabaseJob），然后执行这个Job的fire方法时，都会借助CallQueuedHandler这个对象来执行任务的具体内容：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CallQueuedHandler-&gt;call()</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">call</span><span class="params">(Job $job, array $data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 预处理任务信息</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $command = <span class="keyword">$this</span>-&gt;setJobInstanceIfNecessary(</span><br><span class="line">            $job, unserialize($data[<span class="string">'command'</span>])</span><br><span class="line">        );</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ModelNotFoundException $e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;handleModelNotFound($job, $e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过dispatcher同步执行任务</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;dispatcher-&gt;dispatchNow(</span><br><span class="line">        $command, <span class="keyword">$this</span>-&gt;resolveHandler($job, $command)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果任务未失败，且未释放，确保工作链上的任务都已派发</span></span><br><span class="line">    <span class="keyword">if</span> (!$job-&gt;hasFailed() &amp;&amp; !$job-&gt;isReleased()) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ensureNextJobInChainIsDispatched($command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果任务未删除或未释放，删除任务</span></span><br><span class="line">    <span class="keyword">if</span> (!$job-&gt;isDeletedOrReleased()) &#123;</span><br><span class="line">        $job-&gt;delete();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>也就是说，如果通过字符串的方式，手动派发任务到队列，需要自己手动进行像CallQueuedHandler::call()方法中那样的收尾工作，使任务执行完毕后，清除任务存储在队列中的信息，避免任务被重新执行。</p>
<h1 id="六、-payload的存储"><a href="#六、-payload的存储" class="headerlink" title="六、 payload的存储"></a>六、 payload的存储</h1><p>常用的数据存储驱动是Database与Redis，我们以Redis作为例子来做说明。</p>
<h2 id="6-1-Redis"><a href="#6-1-Redis" class="headerlink" title="6.1 Redis"></a>6.1 Redis</h2><p>假设我们现在设置有一个名叫queue的队列，那么，在队列执行的过程中，会有下列几个key被redis用到：</p>
<ul>
<li>queue 任务信息默认存储的key</li>
<li>queue:reserved 任务执行过程中，临时存储的key</li>
<li>queue:delayed 任务执行失败，被重新发布到的key，或者延迟执行的任务被发布到的key</li>
</ul>
<h3 id="6-1-1-入队"><a href="#6-1-1-入队" class="headerlink" title="6.1.1 入队"></a>6.1.1 入队</h3><p>任务信息被推入队列时，调用RedisQueue的push方法，将任务信息的载体payload，rpush到键名为queue的lists中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Push a new job onto the queue.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  object|string  $job</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  mixed   $data</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string  $queue</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">push</span><span class="params">($job, $data = <span class="string">''</span>, $queue = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;pushRaw(<span class="keyword">$this</span>-&gt;createPayload($job, $data), $queue);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Push a raw payload onto the queue.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string  $payload</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string  $queue</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  array   $options</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">pushRaw</span><span class="params">($payload, $queue = null, array $options = [])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;getConnection()-&gt;rpush(<span class="keyword">$this</span>-&gt;getQueue($queue), $payload);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> json_decode($payload, <span class="keyword">true</span>)[<span class="string">'id'</span>] ?? <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果是将一个任务推入队列中延迟执行，调用的是RedisQueue的later方法，zadd到键名为queue:delayed的zset中，延迟时长作为排序的依据：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Push a new job onto the queue after a delay.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  \DateTimeInterface|\DateInterval|int  $delay</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  object|string  $job</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  mixed   $data</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string  $queue</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">later</span><span class="params">($delay, $job, $data = <span class="string">''</span>, $queue = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;laterRaw($delay, <span class="keyword">$this</span>-&gt;createPayload($job, $data), $queue);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Push a raw job onto the queue after a delay.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  \DateTimeInterface|\DateInterval|int  $delay</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string  $payload</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string  $queue</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">laterRaw</span><span class="params">($delay, $payload, $queue = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;getConnection()-&gt;zadd(</span><br><span class="line">        <span class="keyword">$this</span>-&gt;getQueue($queue).<span class="string">':delayed'</span>, <span class="keyword">$this</span>-&gt;availableAt($delay), $payload</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> json_decode($payload, <span class="keyword">true</span>)[<span class="string">'id'</span>] ?? <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="6-1-2-出队"><a href="#6-1-2-出队" class="headerlink" title="6.1.2 出队"></a>6.1.2 出队</h3><p>出队的方法只有一个，就是RedisQueue的pop方法。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Pop the next job off of the queue.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string  $queue</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> \Illuminate\Contracts\Queue\Job|null</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">pop</span><span class="params">($queue = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;migrate($prefixed = <span class="keyword">$this</span>-&gt;getQueue($queue));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">list</span>($job, $reserved) = <span class="keyword">$this</span>-&gt;retrieveNextJob($prefixed);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($reserved) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RedisJob(</span><br><span class="line">            <span class="keyword">$this</span>-&gt;container, <span class="keyword">$this</span>, $job,</span><br><span class="line">            $reserved, <span class="keyword">$this</span>-&gt;connectionName, $queue ?: <span class="keyword">$this</span>-&gt;default</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Migrate any delayed or expired jobs onto the primary queue.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string  $queue</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">migrate</span><span class="params">($queue)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;migrateExpiredJobs($queue.<span class="string">':delayed'</span>, $queue);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (! is_null(<span class="keyword">$this</span>-&gt;retryAfter)) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;migrateExpiredJobs($queue.<span class="string">':reserved'</span>, $queue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Migrate the delayed jobs that are ready to the regular queue.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string  $from</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string  $to</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">migrateExpiredJobs</span><span class="params">($from, $to)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getConnection()-&gt;eval(</span><br><span class="line">        LuaScripts::migrateExpiredJobs(), <span class="number">2</span>, $from, $to, <span class="keyword">$this</span>-&gt;currentTime()</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在出队之前，先检查queue:delayed上是否有到期的任务，有的话，先将这部分任务的信息转移到queue上，如果设置有超时时间，还会检查queue:reserved上是否有到期的任务，将这部分的任务信息也转移到queue上。</p>
<p>接着通过retrieveNextJob方法获取下一个要执行的任务信息：从queue中取出第一个任务，将他的attempt值加一后放入到queue:reserved中。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Retrieve the next job from the queue.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $queue</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">retrieveNextJob</span><span class="params">($queue)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getConnection()-&gt;eval(</span><br><span class="line">            LuaScripts::pop(), <span class="number">2</span>, $queue, $queue.<span class="string">':reserved'</span>,</span><br><span class="line">            <span class="keyword">$this</span>-&gt;availableAt(<span class="keyword">$this</span>-&gt;retryAfter)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// LuaScripts::pop</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the Lua script for popping the next job off of the queue.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * KEYS[1] - The queue to pop jobs from, for example: queues:foo</span></span><br><span class="line"><span class="comment">     * KEYS[2] - The queue to place reserved jobs on, for example: queues:foo:reserved</span></span><br><span class="line"><span class="comment">     * ARGV[1] - The time at which the reserved job will expire</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">pop</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&lt;&lt;&lt;'LUA'</span></span><br><span class="line"><span class="string">-- Pop the first job off of the queue...</span></span><br><span class="line"><span class="string">local job = redis.call('lpop', KEYS[1])</span></span><br><span class="line"><span class="string">local reserved = false</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">if(job ~= false) then</span></span><br><span class="line"><span class="string">    -- Increment the attempt count and place job on the reserved queue...</span></span><br><span class="line"><span class="string">    reserved = cjson.decode(job)</span></span><br><span class="line"><span class="string">    reserved['attempts'] = reserved['attempts'] + 1</span></span><br><span class="line"><span class="string">    reserved = cjson.encode(reserved)</span></span><br><span class="line"><span class="string">    redis.call('zadd', KEYS[2], ARGV[1], reserved)</span></span><br><span class="line"><span class="string">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &#123;job, reserved&#125;</span><br><span class="line">LUA;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="6-1-3-执行结果"><a href="#6-1-3-执行结果" class="headerlink" title="6.1.3 执行结果"></a>6.1.3 执行结果</h3><p>在任务执行成功时，检查任务是否被删除或Release，如果没有的话，就从queue:reserved中删除任务信息；如果执行失败的话，检查是否超过最大执行次数，超过则删除任务信息，否则标记为已删除，从queue:reserved中删除任务信息，并重新发布任务到queue:delayed中。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Delete a reserved job from the reserved queue and release it.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $queue</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Queue\Jobs\RedisJob  $job</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  int  $delay</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">deleteAndRelease</span><span class="params">($queue, $job, $delay)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $queue = <span class="keyword">$this</span>-&gt;getQueue($queue);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;getConnection()-&gt;eval(</span><br><span class="line">            LuaScripts::release(), <span class="number">2</span>, $queue.<span class="string">':delayed'</span>, $queue.<span class="string">':reserved'</span>,</span><br><span class="line">            $job-&gt;getReservedJob(), <span class="keyword">$this</span>-&gt;availableAt($delay)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// LuaScripts::release()</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the Lua script for releasing reserved jobs.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * KEYS[1] - The "delayed" queue we release jobs onto, for example: queues:foo:delayed</span></span><br><span class="line"><span class="comment">     * KEYS[2] - The queue the jobs are currently on, for example: queues:foo:reserved</span></span><br><span class="line"><span class="comment">     * ARGV[1] - The raw payload of the job to add to the "delayed" queue</span></span><br><span class="line"><span class="comment">     * ARGV[2] - The UNIX timestamp at which the job should become available</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">release</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&lt;&lt;&lt;'LUA'</span></span><br><span class="line"><span class="string">-- Remove the job from the current queue...</span></span><br><span class="line"><span class="string">redis.call('zrem', KEYS[2], ARGV[1])</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-- Add the job onto the "delayed" queue...</span></span><br><span class="line"><span class="string">redis.call('zadd', KEYS[1], ARGV[2], ARGV[1])</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">return true</span></span><br><span class="line"><span class="string">LUA;</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="6-2-Database"><a href="#6-2-Database" class="headerlink" title="6.2 Database"></a>6.2 Database</h2><p>如果队列驱动是数据库，这个过程也基本一致，不过只需要用一张数据表来保存任务信息，用reserved_at，available_at两个字段来表示不同的任务状态，在取出任务及任务失败等复杂情况下，通过事务来保证任务执行的结果与数据的一致性。：</p>
<ul>
<li>给reserved_at字段赋值，对应Redis中push到queue:reserved</li>
<li>给available_at字段赋值，对应Redis中push到queue:delayed</li>
<li>Redis中LuaScripts脚本部分的执行，对应数据库中的事务</li>
</ul>
<h1 id="七、-总结"><a href="#七、-总结" class="headerlink" title="七、 总结"></a>七、 总结</h1><p>关于laravel的队列就是这些了，具体的细节部分，有大家去针对性的查看对应源码。这里对整体的逻辑做一个总结，如图:<br><img src="/images/queue.png" alt="queue"><br>具体payload在Redis中的流转过程如图：<br><img src="/images/queue-redis.jpg" alt="queue-redis"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.slpi1.com/20210219/laravel/progress.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="slpi1">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="easy note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/20210219/laravel/progress.html" itemprop="url">laravel 主流程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-02-19T15:44:38+08:00">
                2021-02-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">st=&gt;start: index.php入口</span><br><span class="line">e=&gt;end: 结束</span><br><span class="line">define_start_time=&gt;operation: 定义开始运行时间LARAVEL_START</span><br><span class="line">autoload=&gt;operation: composer自动加载</span><br><span class="line">load_app=&gt;condition: 框架载入</span><br><span class="line">instance_application=&gt;condition: 实例化容器</span><br><span class="line">Application::__construct</span><br><span class="line"></span><br><span class="line">app_base_binding=&gt;operation: 容器自绑定</span><br><span class="line">app_base_provider=&gt;operation: 容器基础provider注册</span><br><span class="line">Route/Log/Event</span><br><span class="line">app_base_alias=&gt;operation: 容器核心别名定义</span><br><span class="line"></span><br><span class="line">bind_base_kernel=&gt;operation: 单例绑定容器核心服务</span><br><span class="line">HttpKernel</span><br><span class="line">ConsoleKernel</span><br><span class="line">ExceptionsHandler</span><br><span class="line"></span><br><span class="line">make_http_kernel=&gt;operation: 实例化http处理器</span><br><span class="line">capture_http=&gt;operation: 捕获http请求</span><br><span class="line">kernel_handle_request=&gt;condition: http处理器处理请求</span><br><span class="line">bootstrap=&gt;condition: 容器启动</span><br><span class="line">bootstrap_app=&gt;operation: 加载环境变量配置</span><br><span class="line">加载配置文件</span><br><span class="line">注册异常handler</span><br><span class="line">注册Facades</span><br><span class="line">注册应用providers</span><br><span class="line">启动应用proveider</span><br><span class="line"></span><br><span class="line">common_middleware=&gt;condition: 全局中间件过滤</span><br><span class="line">dispatch_route=&gt;operation: 解析路由</span><br><span class="line">match_route=&gt;operation: 匹配路由</span><br><span class="line">instance_controller=&gt;operation: 实例化控制器</span><br><span class="line">route_middleware=&gt;condition: 路由中间件过滤</span><br><span class="line">call_action=&gt;operation: callAction引导执行控制器方法</span><br><span class="line">run_action=&gt;operation: 执行控制器</span><br><span class="line"></span><br><span class="line">common_middleware_item=&gt;operation: 全局中间件详情</span><br><span class="line">up&amp;down检查</span><br><span class="line">post包大小检查</span><br><span class="line">空格过滤</span><br><span class="line">空数据转化为null</span><br><span class="line">代理设置</span><br><span class="line"></span><br><span class="line">web_route_middleware_item=&gt;operation: 路由中间件详情</span><br><span class="line">cookie加密解密</span><br><span class="line">cookie设置</span><br><span class="line">start session</span><br><span class="line">Error闪存至session</span><br><span class="line">csrf验证</span><br><span class="line">路由模型绑定监听</span><br><span class="line"></span><br><span class="line">send_response=&gt;operation: 发送响应</span><br><span class="line">kernel_terminate=&gt;operation: http处理器运行后台任务</span><br><span class="line"></span><br><span class="line">st-&gt;define_start_time-&gt;autoload-&gt;load_app</span><br><span class="line">load_app(yes,right)-&gt;instance_application</span><br><span class="line">load_app(no,)-&gt;make_http_kernel-&gt;capture_http-&gt;kernel_handle_request</span><br><span class="line">instance_application(no)-&gt;bind_base_kernel(left)-&gt;make_http_kernel</span><br><span class="line">instance_application(yes, right)-&gt;app_base_binding-&gt;app_base_provider-&gt;app_base_alias(left)-&gt;bind_base_kernel</span><br><span class="line">kernel_handle_request(no)-&gt;send_response-&gt;kernel_terminate-&gt;e</span><br><span class="line">kernel_handle_request(yes, right)-&gt;bootstrap</span><br><span class="line">bootstrap(no)-&gt;common_middleware</span><br><span class="line">bootstrap(yes, right)-&gt;bootstrap_app</span><br><span class="line">common_middleware(no)-&gt;dispatch_route-&gt;match_route-&gt;instance_controller-&gt;route_middleware</span><br><span class="line">common_middleware(yes, right)-&gt;common_middleware_item</span><br><span class="line">route_middleware(no)-&gt;call_action-&gt;run_action(left)-&gt;send_response</span><br><span class="line">route_middleware(yes, right)-&gt;web_route_middleware_item</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.slpi1.com/20210219/laravel/progress-doc.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="slpi1">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="easy note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/20210219/laravel/progress-doc.html" itemprop="url">未命名</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-02-19T15:44:38+08:00">
                2021-02-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="laravel应用执行流程"><a href="#laravel应用执行流程" class="headerlink" title="laravel应用执行流程"></a>laravel应用执行流程</h1><h1 id="Index"><a href="#Index" class="headerlink" title="Index"></a>Index</h1><ul>
<li><a href="#应用入口">应用入口</a><ul>
<li><a href="#第一阶段：容器准备阶段">第一阶段：容器准备阶段</a><ul>
<li><a href="#$app对象实例化">$app对象实例化</a></li>
<li><a href="#Illuminate\Contracts\Http\Kernel::class">Illuminate\Contracts\Http\Kernel::class</a></li>
<li><a href="#Illuminate\Contracts\Console\Kernel::class">Illuminate\Contracts\Console\Kernel::class</a></li>
<li><a href="#Illuminate\Contracts\Debug\ExceptionHandler::class">Illuminate\Contracts\Debug\ExceptionHandler::class</a></li>
</ul>
</li>
<li><a href="#第二阶段：容器启动阶段">第二阶段：容器启动阶段</a><ul>
<li><a href="#Http处理器捕获请求">Http处理器捕获请求</a></li>
<li><a href="#启动容器">启动容器</a></li>
<li><a href="#启动服务提供者">启动服务提供者</a></li>
</ul>
</li>
<li><a href="#第三阶段：请求处理阶段">第三阶段：请求处理阶段</a><ul>
<li><a href="#路由解析">路由解析</a></li>
<li><a href="#全局中间件过滤">全局中间件过滤</a></li>
<li><a href="#控制器实例化">控制器实例化</a></li>
<li><a href="#路由中间件过滤">路由中间件过滤</a></li>
<li><a href="#运行路由方法并响应">运行路由方法并响应</a></li>
</ul>
</li>
<li><a href="#第四阶段：terminate">第四阶段：terminate</a></li>
</ul>
</li>
</ul>
<h2 id="应用入口"><a href="#应用入口" class="headerlink" title="应用入口"></a>应用入口</h2><p>请求经过web服务器，路由到index.php入口文件。在入口文件中引入<code>vendor/autoload.php</code>和<code>bootstrap/app.php</code>文件。其中，前者是文件自动加载规则，后者是应用启动文件。</p>
<h3 id="第一阶段：容器准备阶段"><a href="#第一阶段：容器准备阶段" class="headerlink" title="第一阶段：容器准备阶段"></a>第一阶段：容器准备阶段</h3><p>在该文件中，首先实例化应用核心容器<code>Illuminate\Foundation\Application</code>，即<code>$app</code>对象，然后单例绑定容器核心服务：</p>
<ul>
<li><code>Illuminate\Contracts\Http\Kernel::class</code></li>
<li><code>Illuminate\Contracts\Console\Kernel::class</code></li>
<li><code>Illuminate\Contracts\Debug\ExceptionHandler::class</code></li>
</ul>
<h4 id="app对象实例化"><a href="#app对象实例化" class="headerlink" title="$app对象实例化"></a>$app对象实例化</h4><ul>
<li>实例化应用核心容器时，传入应用根目录作为参数。以此目录分别衍生出<code>base/lang/config/public/storage/database/resources/bootstrap</code>等应用目录</li>
<li>然后将应用对象绑定到自身<code>app</code>别名与<code>Illuminate\Container\Container::class</code>接口，同时绑定<code>PackageManifest::class</code>对象，后续用于对<code>composer.json</code>文件的解析</li>
<li>接下来注册基础服务提供者<code>EventServiceProvider/LogServiceProvider/RoutingServiceProvider</code></li>
<li>最后进行核心别名的定义，</li>
</ul>
<h4 id="Illuminate-Contracts-Http-Kernel-class"><a href="#Illuminate-Contracts-Http-Kernel-class" class="headerlink" title="Illuminate\Contracts\Http\Kernel::class"></a>Illuminate\Contracts\Http\Kernel::class</h4><p>该接口绑定http请求处理器。用于接收并处理来自web的请求</p>
<h4 id="Illuminate-Contracts-Console-Kernel-class"><a href="#Illuminate-Contracts-Console-Kernel-class" class="headerlink" title="Illuminate\Contracts\Console\Kernel::class"></a>Illuminate\Contracts\Console\Kernel::class</h4><p>该接口绑定Console处理器。用于接收来自CLI的命令。</p>
<h4 id="Illuminate-Contracts-Debug-ExceptionHandler-class"><a href="#Illuminate-Contracts-Debug-ExceptionHandler-class" class="headerlink" title="Illuminate\Contracts\Debug\ExceptionHandler::class"></a>Illuminate\Contracts\Debug\ExceptionHandler::class</h4><p>该接口绑定异常处理器。用于在应用中出现异常时，做出对应的响应。</p>
<h3 id="第二阶段：容器启动阶段"><a href="#第二阶段：容器启动阶段" class="headerlink" title="第二阶段：容器启动阶段"></a>第二阶段：容器启动阶段</h3><p>在做完第一阶段的准备工作后，从容器中解析出Http处理器，Http处理器捕获到请求，开始启动容器。</p>
<h4 id="Http处理器捕获请求"><a href="#Http处理器捕获请求" class="headerlink" title="Http处理器捕获请求"></a>Http处理器捕获请求</h4><p>捕获请求也就是<code>$request</code> 对象的初始化。</p>
<h4 id="启动容器"><a href="#启动容器" class="headerlink" title="启动容器"></a>启动容器</h4><p>在捕获到请求后，需要先启动容器，容器启动的动作由Http处理器触发，并启动由Http处理器定义的启动文件，启动文件列表如下：</p>
<ul>
<li><code>\Illuminate\Foundation\Bootstrap\LoadEnvironmentVariables::class</code>: 加载环境变量配置.env文件</li>
<li><code>\Illuminate\Foundation\Bootstrap\LoadConfiguration::class</code>: 加载配置目录配置文件</li>
<li><code>\Illuminate\Foundation\Bootstrap\HandleExceptions::class</code>: 注册异常处理函数</li>
<li><code>\Illuminate\Foundation\Bootstrap\RegisterFacades::class</code>: 注册Facade，由<code>config/app.php</code>中定义的aliases和从composer.json中解析出的Facade组成</li>
<li><code>\Illuminate\Foundation\Bootstrap\RegisterProviders::class</code>: 注册服务提供者，由<code>config/app.php</code>中定义的providers和从composer.json中解析出的providers组成</li>
<li><code>\Illuminate\Foundation\Bootstrap\BootProviders::class</code>: 启动服务提供者。</li>
</ul>
<h4 id="启动服务提供者"><a href="#启动服务提供者" class="headerlink" title="启动服务提供者"></a>启动服务提供者</h4><p>在启动服务提供者后，容器就算是完全准备就绪了：容器准备阶段的别名定义，提供了容器可对外服务的接口，而启动服务提供者的过程中，会实例化接口对应的对象，后续执行对象依赖接口时就可以从容器中解析出所需要的对象。</p>
<p>容器启动的重点，在于启动服务提供者，在该阶段完成了大量的基础重要工作。如：文件驱动服务、数据库连接服务、Session服务、Redis服务、视图服务、认证服务、路由服务等，详见<code>config/app.php</code>中的providers部分。其中，路由服务，会加载路由定义文件，生成路由表，供后续路由解析时做匹配查询。</p>
<p>在容器启动完毕后，进入第三阶段，请求处理阶段。</p>
<h3 id="第三阶段：请求处理阶段"><a href="#第三阶段：请求处理阶段" class="headerlink" title="第三阶段：请求处理阶段"></a>第三阶段：请求处理阶段</h3><h4 id="路由解析"><a href="#路由解析" class="headerlink" title="路由解析"></a>路由解析</h4><p>路由解析，就是根据当前请求，从路由表中匹配出定义好的路由，匹配会从四个方面进行<code>Uri/Method/Host/Scheme</code>。命中路由后进行下一阶段，否则抛出路由不存在的异常。</p>
<h4 id="全局中间件过滤"><a href="#全局中间件过滤" class="headerlink" title="全局中间件过滤"></a>全局中间件过滤</h4><p>命中路由后，请求经过全局中间的过滤，全局中间定义在Http处理器中，应用默认全局中间件列表如下:</p>
<ul>
<li><code>\Illuminate\Foundation\Http\Middleware\CheckForMaintenanceMode::class</code>: 检查应用状态</li>
<li><code>\Illuminate\Foundation\Http\Middleware\ValidatePostSize::class</code>： 检查请求数据大小</li>
<li><code>\App\Http\Middleware\TrimStrings::class</code>：过滤请求数据值中的首尾空字符</li>
<li><code>\Illuminate\Foundation\Http\Middleware\ConvertEmptyStringsToNull::class</code>：将空的值转化成null</li>
<li><code>\App\Http\Middleware\TrustProxies::class</code>：配置代理IP</li>
</ul>
<h4 id="控制器实例化"><a href="#控制器实例化" class="headerlink" title="控制器实例化"></a>控制器实例化</h4><p>请求通过全局中间之后，接着就要实例化控制器。因为下一步就要通过路由中间件，路由中间件可能随路由一同定义在路由文件中，也有可能定义在控制器的$middleware属性中。所以，为了收集到完整的路由中间列表，需要先实例化控制器对象，才能从中解析中间件属性。由于控制器的实例化，与路由中间件的过滤存在这样一个顺序关系，导致在控制器的构造函数中，无法获取到在路由中间件中处理的一些状态。比如登录状态，用户认证过程，依赖<code>\Illuminate\Session\Middleware\StartSession::class|\App\Http\Middleware\EncryptCookies::class</code>等路由中间件的执行结果，控制器构造函数执行时，路由中间件还未执行，因此无法获取用户的登陆状态。</p>
<p>因此，不推荐在控制器的构造函数中做太多的逻辑处理，避免因上述原因导致的错误。如果确实有些场景，需要在构造函数中做一些统一的操作，可以用CallAction方法来代替构造函数，见<code>Illuminate\Routing\ControllerDispatcher::dispatch()</code>方法。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Dispatch a request to a given controller and method.</span><br><span class="line"> *</span><br><span class="line"> * @param  \Illuminate\Routing\Route  $route</span><br><span class="line"> * @param  mixed  $controller</span><br><span class="line"> * @param  string  $method</span><br><span class="line"> * @return mixed</span><br><span class="line"> */</span><br><span class="line">public function dispatch(Route $route, $controller, $method)</span><br><span class="line">&#123;</span><br><span class="line">    $parameters = $this-&gt;resolveClassMethodDependencies(</span><br><span class="line">        $route-&gt;parametersWithoutNulls(), $controller, $method</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    if (method_exists($controller, &apos;callAction&apos;)) &#123;</span><br><span class="line">        return $controller-&gt;callAction($method, $parameters);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return $controller-&gt;&#123;$method&#125;(...array_values($parameters));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="路由中间件过滤"><a href="#路由中间件过滤" class="headerlink" title="路由中间件过滤"></a>路由中间件过滤</h4><p>一般路由中间件都会包含下列几个：</p>
<ul>
<li><code>\App\Http\Middleware\EncryptCookies::class</code>: cookie加密与解密，解密是前置部分，加密是后置部分</li>
<li><code>\Illuminate\Cookie\Middleware\AddQueuedCookiesToResponse::class</code>：添加程序中定义的cookie到响应中。</li>
<li><code>\Illuminate\Session\Middleware\StartSession::class</code>：启动session</li>
<li><code>\Illuminate\View\Middleware\ShareErrorsFromSession::class</code>：将验证错误信息系添加到session中，见文档表单验证部分</li>
<li><code>\App\Http\Middleware\VerifyCsrfToken::class</code>：csrf检查</li>
<li><code>\Illuminate\Routing\Middleware\SubstituteBindings::class</code>：路由模型绑定解析</li>
</ul>
<h4 id="运行路由方法并响应"><a href="#运行路由方法并响应" class="headerlink" title="运行路由方法并响应"></a>运行路由方法并响应</h4><p>进过上述处理之后，就终于到达了路由方法，也就是我们定义的路由中的控制器方法或闭包方法。执行完毕生成响应返回给浏览器。</p>
<p>需要注意的是，在执行完路由方法之后，还有可能存在后置中间件的方法待执行，比如cookie的加密，关于后置中间件的说明见文档中间件部分。</p>
<h3 id="第四阶段：terminate"><a href="#第四阶段：terminate" class="headerlink" title="第四阶段：terminate"></a>第四阶段：terminate</h3><p>terminate是指在响应发送到浏览器之后会执行的方法。terminate方法中非常适合做日志记录的工作，可以完美解决使用log-viewer插件时的log死循环问题。其次，还需要注意的是，在web环境下与Console环境下，terminate方法的区别。在web环境下，Http处理器先执行中间件中定义的terminate方法，然后执行容器$app的terminate方法，而在Console环境下，直接执行$app的terminate方法。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.slpi1.com/20210219/laravel/filesystem.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="slpi1">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="easy note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/20210219/laravel/filesystem.html" itemprop="url">未命名</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-02-19T15:44:38+08:00">
                2021-02-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="文件系统"><a href="#文件系统" class="headerlink" title="文件系统"></a>文件系统</h1><p>通过阅读 <code>laravel</code> 的 <code>Filesystem</code> 部分的代码可知，框架提供两套文件系统的操作接口：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Illuminate\Filesystem\FilesystemServiceProvider</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;registerNativeFilesystem();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;registerFlysystem();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>他们之间有些差异，以及在使用的过程中，也会有稍许不同。</p>
<h1 id="NativeFilesystem"><a href="#NativeFilesystem" class="headerlink" title="NativeFilesystem"></a>NativeFilesystem</h1><p><code>NativeFilesystem</code> 是由 <code>registerNativeFilesystem()</code> 方法注册的文件系统操作接口，其对应的类是 <code>\Illuminate\Filesystem\Filesystem</code>，对应的 <code>Facade</code> 门面名称是 <code>File</code>，在容器内的别名是 <code>files</code>。</p>
<p>他是框架提供的一组对本地文件系统常用的操作接口，特点是简单易理解，基本就是对 <code>PHP</code> 的一些原生函数的封装。但是在官方入门文档中并不包含对这一套接口的说明，因为上述原因，这部分的接口并没做太多的逻辑业务处理，并不适合在业务流程中使用，但是框架本身有对这部分的接口使用，主要集中在命令行操作的过程中，比如：生成缓存文件、生成模板文件、操作扩展包的文件等。</p>
<h1 id="Flysystem"><a href="#Flysystem" class="headerlink" title="Flysystem"></a>Flysystem</h1><p><code>Flysystem</code> 是框架提供的另一套文件系统操作接口，基于 <code>league/flysystem</code> 扩展，提供对本地文件系统、<code>FTP</code>、云盘等具备文件存储功能的系统的操作。也就是使用文档中的 <code>Storage</code> 。</p>
<p><code>Storage</code> 经过多次封装</p>
<ul>
<li><code>Storage</code> 的操作接口由类 <code>Illuminate\Filesystem\FilesystemAdapter::class</code> 提供；</li>
<li><code>Illuminate\Filesystem\FilesystemAdapter::class</code> 类负责与 <code>league/flysystem</code> 的统一接口 <code>League\Flysystem\Filesystem::class</code> 进行对接;</li>
<li><code>League\Flysystem\Filesystem::class</code> 负责与存储驱动交互，完成最后的文件操作。</li>
</ul>
<p><code>league/flysystem</code> 默认支持 <code>Ftp/Local/NullAdapter</code> 三种存储驱动，其他的存储驱动需要通过 <code>composer</code> 安装额外的扩展，如： <code>sftp/aws/Azure/Memory/aliyun-oss</code> 等。</p>
<p><code>laravel</code> 框架 <code>5.5</code> 版本默认支持 <code>league/flysystem</code> 的 <code>Local/Ftp/S3/Rackspace/</code> 三种驱动，如果需要通过其他储存，可以通过 <code>Storage::extend()</code> 方法，扩展驱动实例。</p>
<h1 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h1><p>如果在使用 <code>Storage</code> 时，通过 <code>Local</code> 本地文件驱动来操作文件，与直接通过 <code>File</code> 来操作文件，有哪些区别呢？</p>
<h2 id="路径字符串的规范化"><a href="#路径字符串的规范化" class="headerlink" title="路径字符串的规范化"></a>路径字符串的规范化</h2><p><code>File</code> 操作文件时，如果参数是相对路径，则是相对当前脚本执行路径。并不会对路径参数做额外的处理。<br><code>Storage</code> 操作文件时，必须先配置存储的根路径，所有的参数路径都是基于根路径参数。同时，在操作文件之前，会对参数路径进行规范化。规范化包括:</p>
<ul>
<li>如果根路劲是符号连接，转化为真实路劲</li>
<li>处理 <code>./..</code> 目录标识符</li>
<li>转化 <code>window</code> 格式的目录分隔符</li>
<li>处理路径参数中的空白字符：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">removeFunkyWhiteSpace</span><span class="params">($path)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// We do this check in a loop, since removing invalid unicode characters</span></span><br><span class="line">    <span class="comment">// can lead to new characters being created.</span></span><br><span class="line">    <span class="keyword">while</span> (preg_match(<span class="string">'#\p&#123;C&#125;+|^\./#u'</span>, $path)) &#123;</span><br><span class="line">        $path = preg_replace(<span class="string">'#\p&#123;C&#125;+|^\./#u'</span>, <span class="string">''</span>, $path);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $path;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解释一下上面出现的正则：</p>
<ul>
<li><code>#</code> 是分隔符</li>
<li><code>u</code> 是模式修饰符，此修正符打开一个与 <code>perl</code> 不兼容的附加功能 <a href="https://www.php.net/manual/zh/reference.pcre.pattern.modifiers.php" target="_blank" rel="noopener">模式修饰符</a></li>
<li><code>\p{C}+</code> 是匹配 <code>Unicode</code> 字符中的其他字符。<a href="https://www.php.net/manual/zh/regexp.reference.unicode.php" target="_blank" rel="noopener">Unicode字符属性</a></li>
</ul>
<p>所以上述正则的含义是，将路径中的 <strong>起头的./字符或一些不规范的unicode字符</strong> 替换为空。</p>
<h2 id="写入文件是否加锁"><a href="#写入文件是否加锁" class="headerlink" title="写入文件是否加锁"></a>写入文件是否加锁</h2><p><code>File</code> 在写入文件时，默认采用不加锁的策略，<code>Storage</code> 在写入文件时，始终会先获取独占锁，然后进行文件的写入。</p>
<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><p><code>File</code> 与 <code>Storage</code> 在进行目录迭代时，都使用到了 <code>PHP标准库</code> 中的文件对象和目录迭代器。</p>
<ul>
<li><a href="https://www.php.net/manual/zh/class.directoryiterator.php" target="_blank" rel="noopener"><code>DirectoryIterator</code></a></li>
<li><a href="https://www.php.net/manual/zh/class.splfileinfo.php" target="_blank" rel="noopener"><code>SplFileInfo</code></a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.slpi1.com/20210219/laravel/pipeline.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="slpi1">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="easy note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/20210219/laravel/pipeline.html" itemprop="url">未命名</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-02-19T15:44:38+08:00">
                2021-02-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Laravel-Pipeline源码分析"><a href="#Laravel-Pipeline源码分析" class="headerlink" title="Laravel Pipeline源码分析"></a>Laravel Pipeline源码分析</h1><h1 id="Index"><a href="#Index" class="headerlink" title="Index"></a>Index</h1><ul>
<li><a href="#Pipeline的使用">Pipeline的使用</a><ul>
<li><a href="#send">send</a></li>
<li><a href="#through">through</a></li>
<li><a href="#then">then</a></li>
</ul>
</li>
<li><a href="#Pipeline的实现">Pipeline的实现</a><ul>
<li><a href="#管道的设计0">管道的设计0</a></li>
<li><a href="#管道的设计1">管道的设计1</a></li>
<li><a href="#管道的设计10">管道的设计10</a></li>
</ul>
</li>
</ul>
<blockquote>
<p><code>Pipeline</code> 模型最早被使用在 <code>Unix</code> 操作系统中。管道的出现，所要解决的问题，还是软件设计中的设计目标——高内聚，低耦合。它以一种“链式模型”来串接不同的程序或者不同的组件，让它们组成一条直线的工作流。<strong>这样给定一个完整的输入，经过各个组件的先后协同处理，得到唯一的最终输出。</strong></p>
</blockquote>
<h1 id="Pipeline的使用"><a href="#Pipeline的使用" class="headerlink" title="Pipeline的使用"></a>Pipeline的使用</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Pipeline</span>\<span class="title">Pipeline</span>;</span><br><span class="line">$result = (<span class="keyword">new</span> Pipeline($container))</span><br><span class="line">    -&gt;send($passable)</span><br><span class="line">    -&gt;through($pipes)</span><br><span class="line">    -&gt;then($callable);</span><br></pre></td></tr></table></figure>
<h2 id="send"><a href="#send" class="headerlink" title="send"></a>send</h2><ul>
<li>参数: <code>$passable</code></li>
</ul>
<p><strong>给定一个完整的输入</strong>就是send所要做的事情。在使用管道模式之前，首先得想清楚，我们是要通过管道来处理什么东西。拿 <code>Laravel</code> 应用来举例，<code>web</code> 程序要通过<strong>中间件</strong>来处理<strong>请求</strong>，最终得到<strong>响应</strong>返回给浏览器。那么，请求就是这里给定的输入。</p>
<h2 id="through"><a href="#through" class="headerlink" title="through"></a>through</h2><ul>
<li>参数: <code>$pipes</code></li>
</ul>
<p><strong>经过各个组件的先后协同处理</strong>中提及的各个组件，就是由 <code>through</code> 方法来传入。基于管道模式的特点，这里的各个组件，会有相同类型的输入，相同类型的输出以及相同的执行入口。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($request, Closure $next)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">    $response = $next($request);</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">    <span class="keyword">return</span> $response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="then"><a href="#then" class="headerlink" title="then"></a>then</h2><ul>
<li>参数: <code>$callable</code></li>
</ul>
<p><strong>最终输出</strong>就是 <code>then</code> 要做的事。前面 <code>send</code> 以及 <code>through</code> 都只是定义管道执行过程中所需要的参数，真正的执行过程在 <code>then</code> 这个方法中。<code>then</code> 的功能点在于将输入转化为输出。</p>
<h1 id="Pipeline的实现"><a href="#Pipeline的实现" class="headerlink" title="Pipeline的实现"></a>Pipeline的实现</h1><h2 id="管道的设计0"><a href="#管道的设计0" class="headerlink" title="管道的设计0"></a>管道的设计0</h2><p>先考虑一种最容易想到的管道的实现方式，我们假设如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">Input</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Output</span>;</span><br><span class="line"></span><br><span class="line">$input = <span class="keyword">new</span> Input;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过管道</span></span><br><span class="line">$result = pipeOne($input);</span><br><span class="line">$result = pipeTwo($result);</span><br><span class="line">$result = pipeThree($result);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 转化输出</span></span><br><span class="line">(Output) $output = then($result);</span><br></pre></td></tr></table></figure>
<p>结合我们上文提到的<code>各个组件，会有相同类型的输入，相同类型的输出以及相同的执行入口</code>,如果通过上述方式来实现管道，那么实际上管道中的组件<code>pipeOne/pipeTwo/pipeThree</code>的输入与输出都是同一种数据类型。否则<code>$input</code>通过第一个组件之后，产生的输出就不能作为下一个组件的输入。显然，这种愚蠢的设计方式根本就不能满足需求。</p>
<h2 id="管道的设计1"><a href="#管道的设计1" class="headerlink" title="管道的设计1"></a>管道的设计1</h2><p>考虑以下面这种方式来实现管道：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">Input</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Output</span>;</span><br><span class="line"></span><br><span class="line">$input = <span class="keyword">new</span> Input;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pipeOne</span><span class="params">(Input $input)</span></span>&#123;</span><br><span class="line">    $input = dosomething($input);</span><br><span class="line">    (Output) $result = pipeTwo($input);</span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pipeTwo</span><span class="params">(Input $input)</span></span>&#123;</span><br><span class="line">    $input = dosomething($input);</span><br><span class="line">    (Output) $result = pipeThree($input);</span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pipeThree</span><span class="params">(Input $input)</span></span>&#123;</span><br><span class="line">    $input = dosomething($input);</span><br><span class="line">    (Output) $result = howToGetTheResult($input);</span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过管道</span></span><br><span class="line">$result = pipeOne($input);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 转化输出</span></span><br><span class="line">$output = then($result);</span><br></pre></td></tr></table></figure></p>
<p>通过这种方式来实现管道，仿佛可以满足上文对输入与输出的定义。但显然也存在很大问题，通过这种方式实现的管道，组件执行的顺利被硬编码到了组件的逻辑之中，如果出现了流程变动的问题，要花很大的力气去做修改。其次，最后一个组件怎么来获取 <code>result</code> 呢？获取 <code>result</code> 的过程，应该定义在 <code>then</code> 当中，综上所述，我们要改进的设计，需要解决下面两个问题：</p>
<ul>
<li>管道中要执行的组件是可配置的。组件的数量与顺序都是可以修改的。</li>
<li>管道要能自行检查到执行的末端，并调用 <code>then</code> 方法，将 <code>input</code> 转化为 <code>output</code>。</li>
</ul>
<h2 id="管道的设计10"><a href="#管道的设计10" class="headerlink" title="管道的设计10"></a>管道的设计10</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">Input</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Output</span>;</span><br><span class="line"></span><br><span class="line">$input = <span class="keyword">new</span> Input;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pipeOne</span><span class="params">(Input $input, Callable $callback)</span></span>&#123;</span><br><span class="line">    <span class="comment">// dosomething</span></span><br><span class="line">    (Output) $result = $callback($input, $callback);</span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pipeTwo</span><span class="params">(Input $input, Callable $callback)</span></span>&#123;</span><br><span class="line">    <span class="comment">// dosomething</span></span><br><span class="line">    (Output) $result = $callback($input, $callback);</span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pipeThree</span><span class="params">(Input $input, Callable $callback)</span></span>&#123;</span><br><span class="line">    <span class="comment">// dosomething</span></span><br><span class="line">    (Output) $result = $callback($input, $callback);</span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createCallbackOfPipe</span><span class="params">($pipes, $index)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">($input, $callback)</span> <span class="title">use</span><span class="params">($pipes,$index)</span></span>&#123;</span><br><span class="line">        <span class="comment">// 自动检测管道的末端</span></span><br><span class="line">        <span class="keyword">if</span>($index == count($pipes))&#123;</span><br><span class="line">            <span class="keyword">return</span> then($input);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            $index+<span class="number">1</span>;</span><br><span class="line">            $nextPipe = $pipes[$index];    </span><br><span class="line">        </span><br><span class="line">            <span class="keyword">return</span> $nextPipe($input,createCallbackOfPipe($pipes, $index));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里可以定义管道中的组件顺序及数量</span></span><br><span class="line">$pipes = [</span><br><span class="line">    <span class="string">'pipeOne'</span>,</span><br><span class="line">    <span class="string">'pipeTwo'</span>,</span><br><span class="line">    <span class="string">'pipeThree'</span>,</span><br><span class="line">];</span><br><span class="line">$firstPipe = $pipes[<span class="number">0</span>];</span><br><span class="line">(Output) $result = $firstPipe($input, createCallbackOfPipe($pipes, <span class="number">0</span>));</span><br></pre></td></tr></table></figure>
<p>至此，一个管道的模型就基本实现了。我们重新梳理一下管道设计中要注意的细节问题，可以归纳出以下几点：</p>
<ul>
<li>管道中的每一个组件，都有相同类型的输入与输出。</li>
<li>管道的参数中还要传递<strong>下一次要调用的句柄</strong>，组件除了要执行本身的逻辑外，还需要调用这个句柄，来触发下一个组件的执行。</li>
<li>组件的执行过程，最好封装成一个匿名函数，这样可以变得通用，而不需要知道下一个要执行的组件的具体信息，比如方法名。</li>
</ul>
<p>在 <code>Laravel</code> 框架中，通过一个函数就达到了我们传递<strong>下一次要调用的句柄</strong>的目的，这个函数就是 <code>array_reduce</code>,这个方法，简直完美的契合管道的思想啊。此外，<code>Laravel</code> 中对管道执行的封装，还考虑到了其他的因素，比如对<strong>下一次要调用的句柄</strong>的扩展，除了可以使用匿名函数，还兼容了 <code>PHP</code> 中的其他三种可调用结构，以及对容器的使用等，具体 <code>Laravel</code> 是如何实现的，就让大家自行去了解吧。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.slpi1.com/20210219/laravel/passport.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="slpi1">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="easy note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/20210219/laravel/passport.html" itemprop="url">未命名</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-02-19T15:44:38+08:00">
                2021-02-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Laravel-Auth源码分析-续"><a href="#Laravel-Auth源码分析-续" class="headerlink" title="Laravel Auth源码分析 - 续"></a>Laravel Auth源码分析 - 续</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">composer require paragonie/random_compat:2.*</span><br><span class="line">composer require laravel/passport &quot;4.0.*&quot;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.slpi1.com/20210219/laravel/middleware.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="slpi1">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="easy note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/20210219/laravel/middleware.html" itemprop="url">未命名</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-02-19T15:44:38+08:00">
                2021-02-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Laravel-中间件"><a href="#Laravel-中间件" class="headerlink" title="Laravel 中间件"></a>Laravel 中间件</h1><h1 id="Index"><a href="#Index" class="headerlink" title="Index"></a>Index</h1><ul>
<li><a href="#中间件全家福">中间件全家福</a></li>
<li><a href="#authenticate">Authenticate</a></li>
<li><a href="#checkformaintenancemode">CheckForMaintenanceMode</a></li>
<li><a href="#encryptcookies">EncryptCookies</a></li>
<li><a href="#redirectifauthenticated">RedirectIfAuthenticated</a></li>
<li><a href="#trimstrings">TrimStrings</a></li>
<li><a href="#trustproxies">TrustProxies</a></li>
<li><a href="#verifycsrftoken">VerifyCsrfToken</a></li>
<li>待续…</li>
<li><a href="#validatepostsize">ValidatePostSize</a></li>
<li><a href="#convertemptystringstonull">ConvertEmptyStringsToNull</a></li>
<li><a href="#addqueuedcookiestoresponse">AddQueuedCookiesToResponse</a></li>
<li><a href="#startsession">StartSession</a></li>
<li><a href="#shareerrorsfromsession">ShareErrorsFromSession</a></li>
<li><a href="#substitutebindings">SubstituteBindings</a></li>
<li><a href="#authenticatewithbasicauth">AuthenticateWithBasicAuth</a></li>
<li><a href="#authorize">Authorize</a></li>
<li><a href="#redirectifauthenticated">RedirectIfAuthenticated</a></li>
<li><a href="#throttlerequests">ThrottleRequests</a></li>
</ul>
<h2 id="中间件全家福"><a href="#中间件全家福" class="headerlink" title="中间件全家福"></a>中间件全家福</h2><p>先在这里列一下框架中用到的中间件。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 全局中间件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 检测项目是否处于 维护模式。</span></span><br><span class="line">\Illuminate\Foundation\Http\Middleware\CheckForMaintenanceMode::class</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查请求数据大小是否超过限制</span></span><br><span class="line">\Illuminate\Foundation\Http\Middleware\ValidatePostSize::class</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清理请求字段值首位的空格</span></span><br><span class="line">\App\Http\Middleware\TrimStrings::class</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将请求中的空字段转化为null值</span></span><br><span class="line">\Illuminate\Foundation\Http\Middleware\ConvertEmptyStringsToNull::class</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置可信任代理</span></span><br><span class="line">\App\Http\Middleware\TrustProxies::class</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * web 路由中间件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 获取请求中的Cookies，解密Cookies的值，加密Headers中的Cookies</span></span><br><span class="line">\App\Http\Middleware\EncryptCookies::class</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加Cookies到Headers</span></span><br><span class="line">\Illuminate\Cookie\Middleware\AddQueuedCookiesToResponse::class</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启用Session，在Headers中添加Session相关的Cookies</span></span><br><span class="line">\Illuminate\Session\Middleware\StartSession::class</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将闪存到Session中的错误信息，共享到视图 - 闪存是指在上一次请求时将数据存入Session的过程，数据会在下一次请求时取出并销毁</span></span><br><span class="line">\Illuminate\View\Middleware\ShareErrorsFromSession::class</span><br><span class="line"></span><br><span class="line"><span class="comment">// csrf 令牌验证</span></span><br><span class="line">\App\Http\Middleware\VerifyCsrfToken::class</span><br><span class="line"></span><br><span class="line"><span class="comment">// 路由参数模型绑定检查</span></span><br><span class="line">\Illuminate\Routing\Middleware\SubstituteBindings::class</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 其他路由中间件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">[</span><br><span class="line">    <span class="comment">// 认证中间件</span></span><br><span class="line">    <span class="string">'auth'</span>       =&gt; \Illuminate\Auth\Middleware\Authenticate::class,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// http基础认证</span></span><br><span class="line">    <span class="string">'auth.basic'</span> =&gt; \Illuminate\Auth\Middleware\AuthenticateWithBasicAuth::class,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 路由参数模型绑定检查</span></span><br><span class="line">    <span class="string">'bindings'</span>   =&gt; \Illuminate\Routing\Middleware\SubstituteBindings::class,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 授权检查</span></span><br><span class="line">    <span class="string">'can'</span>        =&gt; \Illuminate\Auth\Middleware\Authorize::class,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 访客认证</span></span><br><span class="line">    <span class="string">'guest'</span>      =&gt; \App\Http\Middleware\RedirectIfAuthenticated::class,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 请求节流</span></span><br><span class="line">    <span class="string">'throttle'</span>   =&gt; \Illuminate\Routing\Middleware\ThrottleRequests::class,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h2 id="Authenticate"><a href="#Authenticate" class="headerlink" title="Authenticate"></a>Authenticate</h2><h3 id="源文件"><a href="#源文件" class="headerlink" title="源文件"></a>源文件</h3><p><code>app\Http\Middleware\Http\Middleware\Authenticate.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Middleware</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Auth</span>\<span class="title">Middleware</span>\<span class="title">Authenticate</span> <span class="title">as</span> <span class="title">Middleware</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Authenticate</span> <span class="keyword">extends</span> <span class="title">Middleware</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Get the path the user should be redirected to when they are not authenticated.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> \Illuminate\Http\Request $request</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">redirectTo</span><span class="params">($request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (! $request-&gt;expectsJson()) &#123;</span><br><span class="line">            <span class="keyword">return</span> route(<span class="string">'login'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h3><p>用户身份验证。可修改 <code>redirectTo</code> 方法，返回未经身份验证的用户应该重定向到的路径。</p>
<h2 id="CheckForMaintenanceMode"><a href="#CheckForMaintenanceMode" class="headerlink" title="CheckForMaintenanceMode"></a>CheckForMaintenanceMode</h2><h3 id="源文件-1"><a href="#源文件-1" class="headerlink" title="源文件"></a>源文件</h3><p><code>app\Http\Middleware\CheckForMaintenanceMode.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Middleware</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Http</span>\<span class="title">Middleware</span>\<span class="title">CheckForMaintenanceMode</span> <span class="title">as</span> <span class="title">Middleware</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CheckForMaintenanceMode</span> <span class="keyword">extends</span> <span class="title">Middleware</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * The URIs that should be reachable while maintenance mode is enabled.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">protected</span> $except = [</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="作用-1"><a href="#作用-1" class="headerlink" title="作用"></a>作用</h3><p>检测项目是否处于 <strong>维护模式</strong>。可通过 <code>$except</code> 数组属性设置在维护模式下仍能访问的网址。</p>
<h2 id="EncryptCookies"><a href="#EncryptCookies" class="headerlink" title="EncryptCookies"></a>EncryptCookies</h2><h3 id="源文件-2"><a href="#源文件-2" class="headerlink" title="源文件"></a>源文件</h3><p><code>app\Http\Middleware\EncryptCookies.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Middleware</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Cookie</span>\<span class="title">Middleware</span>\<span class="title">EncryptCookies</span> <span class="title">as</span> <span class="title">Middleware</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EncryptCookies</span> <span class="keyword">extends</span> <span class="title">Middleware</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * The names of the cookies that should not be encrypted.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">protected</span> $except = [</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="作用-2"><a href="#作用-2" class="headerlink" title="作用"></a>作用</h3><p>对 Cookie 进行加解密处理与验证。可通过 <code>$except</code> 数组属性设置不做加密处理的 cookie。</p>
<h2 id="RedirectIfAuthenticated"><a href="#RedirectIfAuthenticated" class="headerlink" title="RedirectIfAuthenticated"></a>RedirectIfAuthenticated</h2><h3 id="源文件-3"><a href="#源文件-3" class="headerlink" title="源文件"></a>源文件</h3><p><code>app\Http\Middleware\RedirectIfAuthenticated.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Middleware</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Auth</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedirectIfAuthenticated</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Handle an incoming request.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> \Illuminate\Http\Request $request</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> \Closure $next</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> string|null $guard</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($request, Closure $next, $guard = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Auth::guard($guard)-&gt;check()) &#123;</span><br><span class="line">            <span class="keyword">return</span> redirect(<span class="string">'/home'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $next($request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="作用-3"><a href="#作用-3" class="headerlink" title="作用"></a>作用</h3><p>当请求页是 <code>注册、登录、忘记密码</code> 时，检测用户是否已经登录，如果已经登录，那么就重定向到首页，如果没有就打开相应界面。可以在 <code>handle</code> 方法中定制重定向到的路径。</p>
<h2 id="TrimStrings"><a href="#TrimStrings" class="headerlink" title="TrimStrings"></a>TrimStrings</h2><h3 id="源文件-4"><a href="#源文件-4" class="headerlink" title="源文件"></a>源文件</h3><p><code>app\Http\Middleware\TrimStrings.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Middleware</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Http</span>\<span class="title">Middleware</span>\<span class="title">TrimStrings</span> <span class="title">as</span> <span class="title">Middleware</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TrimStrings</span> <span class="keyword">extends</span> <span class="title">Middleware</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * The names of the attributes that should not be trimmed.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">protected</span> $except = [</span><br><span class="line">        <span class="string">'password'</span>,</span><br><span class="line">        <span class="string">'password_confirmation'</span>,</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="作用-4"><a href="#作用-4" class="headerlink" title="作用"></a>作用</h3><p>对请求参数内容进行 <strong>前后空白字符清理</strong>。可通过 <code>$except</code> 数组属性设置不做处理的参数。</p>
<h2 id="TrustProxies"><a href="#TrustProxies" class="headerlink" title="TrustProxies"></a>TrustProxies</h2><h3 id="源文件-5"><a href="#源文件-5" class="headerlink" title="源文件"></a>源文件</h3><p><code>app\Http\Middleware\TrustProxies.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Middleware</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Fideloper</span>\<span class="title">Proxy</span>\<span class="title">TrustProxies</span> <span class="title">as</span> <span class="title">Middleware</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TrustProxies</span> <span class="keyword">extends</span> <span class="title">Middleware</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * The trusted proxies for this application.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@var</span> array|string</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">protected</span> $proxies;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * The headers that should be used to detect proxies.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@var</span> int</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">protected</span> $headers = Request::HEADER_X_FORWARDED_ALL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="作用-5"><a href="#作用-5" class="headerlink" title="作用"></a>作用</h3><p>配置可信代理。可通过 <code>$proxies</code> 属性设置可信代理列表，<code>$headers</code> 属性设置用来检测代理的 HTTP 头字段。</p>
<h2 id="VerifyCsrfToken"><a href="#VerifyCsrfToken" class="headerlink" title="VerifyCsrfToken"></a>VerifyCsrfToken</h2><h3 id="源文件-6"><a href="#源文件-6" class="headerlink" title="源文件"></a>源文件</h3><p><code>app\Http\Middleware\VerifyCsrfToken.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Middleware</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Http</span>\<span class="title">Middleware</span>\<span class="title">VerifyCsrfToken</span> <span class="title">as</span> <span class="title">Middleware</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VerifyCsrfToken</span> <span class="keyword">extends</span> <span class="title">Middleware</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Indicates whether the XSRF-TOKEN cookie should be set on the response.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@var</span> bool</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">protected</span> $addHttpCookie = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * The URIs that should be excluded from CSRF verification.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">protected</span> $except = [</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="作用-6"><a href="#作用-6" class="headerlink" title="作用"></a>作用</h3><p>验证请求里的令牌是否与存储在会话中令牌匹配。可通过 <code>$except</code> 数组属性设置不做 CSRF 验证的网址。</p>
<h2 id="ValidatePostSize"><a href="#ValidatePostSize" class="headerlink" title="ValidatePostSize"></a>ValidatePostSize</h2><h3 id="源文件-7"><a href="#源文件-7" class="headerlink" title="源文件"></a>源文件</h3><p><code>vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/ValidatePostSize.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Http</span>\<span class="title">Middleware</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Exceptions</span>\<span class="title">PostTooLargeException</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ValidatePostSize</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle an incoming request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Http\Request  $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Closure  $next</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> \Illuminate\Http\Exceptions\PostTooLargeException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($request, Closure $next)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $max = <span class="keyword">$this</span>-&gt;getPostMaxSize();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($max &gt; <span class="number">0</span> &amp;&amp; $request-&gt;server(<span class="string">'CONTENT_LENGTH'</span>) &gt; $max) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PostTooLargeException;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $next($request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Determine the server 'post_max_size' as bytes.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getPostMaxSize</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_numeric($postMaxSize = ini_get(<span class="string">'post_max_size'</span>))) &#123;</span><br><span class="line">            <span class="keyword">return</span> (int) $postMaxSize;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $metric = strtoupper(substr($postMaxSize, <span class="number">-1</span>));</span><br><span class="line">        $postMaxSize = (int) $postMaxSize;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> ($metric) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'K'</span>:</span><br><span class="line">                <span class="keyword">return</span> $postMaxSize * <span class="number">1024</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'M'</span>:</span><br><span class="line">                <span class="keyword">return</span> $postMaxSize * <span class="number">1048576</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'G'</span>:</span><br><span class="line">                <span class="keyword">return</span> $postMaxSize * <span class="number">1073741824</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> $postMaxSize;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="作用-7"><a href="#作用-7" class="headerlink" title="作用"></a>作用</h3><p>检查请求数据大小是否操作限制。 </p>
<h2 id="ConvertEmptyStringsToNull"><a href="#ConvertEmptyStringsToNull" class="headerlink" title="ConvertEmptyStringsToNull"></a>ConvertEmptyStringsToNull</h2><h3 id="源文件-8"><a href="#源文件-8" class="headerlink" title="源文件"></a>源文件</h3><p><code>vendor/laravel/framework/src/Illuminate/Foundation/Http/Middleware/ConvertEmptyStringsToNull.php</code><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Http</span>\<span class="title">Middleware</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConvertEmptyStringsToNull</span> <span class="keyword">extends</span> <span class="title">TransformsRequest</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Transform the given value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  mixed  $value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">transform</span><span class="params">($key, $value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> is_string($value) &amp;&amp; $value === <span class="string">''</span> ? <span class="keyword">null</span> : $value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="作用-8"><a href="#作用-8" class="headerlink" title="作用"></a>作用</h3><p>将请求中的空字符，转化为 <code>NULL</code> 值。</p>
<h2 id="AddQueuedCookiesToResponse"><a href="#AddQueuedCookiesToResponse" class="headerlink" title="AddQueuedCookiesToResponse"></a>AddQueuedCookiesToResponse</h2><h3 id="源文件-9"><a href="#源文件-9" class="headerlink" title="源文件"></a>源文件</h3><p><code>vendor/laravel/framework/src/Illuminate/Cookie\Middleware/AddQueuedCookiesToResponse.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Cookie</span>\<span class="title">Middleware</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Cookie</span>\<span class="title">QueueingFactory</span> <span class="title">as</span> <span class="title">CookieJar</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AddQueuedCookiesToResponse</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The cookie jar instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> \Illuminate\Contracts\Cookie\QueueingFactory</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $cookies;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new CookieQueue instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Contracts\Cookie\QueueingFactory  $cookies</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(CookieJar $cookies)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;cookies = $cookies;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle an incoming request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Http\Request  $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Closure  $next</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($request, Closure $next)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $response = $next($request);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;cookies-&gt;getQueuedCookies() <span class="keyword">as</span> $cookie) &#123;</span><br><span class="line">            $response-&gt;headers-&gt;setCookie($cookie);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $response;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="作用-9"><a href="#作用-9" class="headerlink" title="作用"></a>作用</h3><p>将程序中通过 <code>Cookies Queue</code> 的方式设置的 <code>cookies</code> 值设置到响应头。</p>
<h2 id="StartSession"><a href="#StartSession" class="headerlink" title="StartSession"></a>StartSession</h2><h3 id="源文件-10"><a href="#源文件-10" class="headerlink" title="源文件"></a>源文件</h3><p><code>vendor/laravel/framework/src/Illuminate/Session/Middleware/StartSession.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Session</span>\<span class="title">Middleware</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Carbon</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Session</span>\<span class="title">SessionManager</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Session</span>\<span class="title">Session</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Session</span>\<span class="title">CookieSessionHandler</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">HttpFoundation</span>\<span class="title">Cookie</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">HttpFoundation</span>\<span class="title">Response</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StartSession</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The session manager.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> \Illuminate\Session\SessionManager</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $manager;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Indicates if the session was handled for the current request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $sessionHandled = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new session middleware.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Session\SessionManager  $manager</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(SessionManager $manager)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;manager = $manager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle an incoming request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Http\Request  $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Closure  $next</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($request, Closure $next)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;sessionHandled = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If a session driver has been configured, we will need to start the session here</span></span><br><span class="line">        <span class="comment">// so that the data is ready for an application. Note that the Laravel sessions</span></span><br><span class="line">        <span class="comment">// do not make use of PHP "native" sessions in any way since they are crappy.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;sessionConfigured()) &#123;</span><br><span class="line">            $request-&gt;setLaravelSession(</span><br><span class="line">                $session = <span class="keyword">$this</span>-&gt;startSession($request)</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="keyword">$this</span>-&gt;collectGarbage($session);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $response = $next($request);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Again, if the session has been configured we will need to close out the session</span></span><br><span class="line">        <span class="comment">// so that the attributes may be persisted to some storage medium. We will also</span></span><br><span class="line">        <span class="comment">// add the session identifier cookie to the application response headers now.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;sessionConfigured()) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;storeCurrentUrl($request, $session);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">$this</span>-&gt;addCookieToResponse($response, $session);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Perform any final actions for the request lifecycle.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Http\Request  $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Symfony\Component\HttpFoundation\Response  $response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">terminate</span><span class="params">($request, $response)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;sessionHandled &amp;&amp; <span class="keyword">$this</span>-&gt;sessionConfigured() &amp;&amp; ! <span class="keyword">$this</span>-&gt;usingCookieSessions()) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;manager-&gt;driver()-&gt;save();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Start the session for the given request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Http\Request  $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \Illuminate\Contracts\Session\Session</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">startSession</span><span class="params">(Request $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> tap(<span class="keyword">$this</span>-&gt;getSession($request), <span class="function"><span class="keyword">function</span> <span class="params">($session)</span> <span class="title">use</span> <span class="params">($request)</span> </span>&#123;</span><br><span class="line">            $session-&gt;setRequestOnHandler($request);</span><br><span class="line"></span><br><span class="line">            $session-&gt;start();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the session implementation from the manager.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Http\Request  $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \Illuminate\Contracts\Session\Session</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getSession</span><span class="params">(Request $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> tap(<span class="keyword">$this</span>-&gt;manager-&gt;driver(), <span class="function"><span class="keyword">function</span> <span class="params">($session)</span> <span class="title">use</span> <span class="params">($request)</span> </span>&#123;</span><br><span class="line">            $session-&gt;setId($request-&gt;cookies-&gt;get($session-&gt;getName()));</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Remove the garbage from the session if necessary.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Contracts\Session\Session  $session</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">collectGarbage</span><span class="params">(Session $session)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $config = <span class="keyword">$this</span>-&gt;manager-&gt;getSessionConfig();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Here we will see if this request hits the garbage collection lottery by hitting</span></span><br><span class="line">        <span class="comment">// the odds needed to perform garbage collection on any given request. If we do</span></span><br><span class="line">        <span class="comment">// hit it, we'll call this handler to let it delete all the expired sessions.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;configHitsLottery($config)) &#123;</span><br><span class="line">            $session-&gt;getHandler()-&gt;gc(<span class="keyword">$this</span>-&gt;getSessionLifetimeInSeconds());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Determine if the configuration odds hit the lottery.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  array  $config</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">configHitsLottery</span><span class="params">(array $config)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> random_int(<span class="number">1</span>, $config[<span class="string">'lottery'</span>][<span class="number">1</span>]) &lt;= $config[<span class="string">'lottery'</span>][<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Store the current URL for the request if necessary.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Http\Request  $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Contracts\Session\Session  $session</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">storeCurrentUrl</span><span class="params">(Request $request, $session)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($request-&gt;method() === <span class="string">'GET'</span> &amp;&amp; $request-&gt;route() &amp;&amp; ! $request-&gt;ajax()) &#123;</span><br><span class="line">            $session-&gt;setPreviousUrl($request-&gt;fullUrl());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Add the session cookie to the application response.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Symfony\Component\HttpFoundation\Response  $response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Contracts\Session\Session  $session</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">addCookieToResponse</span><span class="params">(Response $response, Session $session)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;usingCookieSessions()) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;manager-&gt;driver()-&gt;save();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;sessionIsPersistent($config = <span class="keyword">$this</span>-&gt;manager-&gt;getSessionConfig())) &#123;</span><br><span class="line">            $response-&gt;headers-&gt;setCookie(<span class="keyword">new</span> Cookie(</span><br><span class="line">                $session-&gt;getName(), $session-&gt;getId(), <span class="keyword">$this</span>-&gt;getCookieExpirationDate(),</span><br><span class="line">                $config[<span class="string">'path'</span>], $config[<span class="string">'domain'</span>], $config[<span class="string">'secure'</span>] ?? <span class="keyword">false</span>,</span><br><span class="line">                $config[<span class="string">'http_only'</span>] ?? <span class="keyword">true</span>, <span class="keyword">false</span>, $config[<span class="string">'same_site'</span>] ?? <span class="keyword">null</span></span><br><span class="line">            ));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the session lifetime in seconds.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getSessionLifetimeInSeconds</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">$this</span>-&gt;manager-&gt;getSessionConfig()[<span class="string">'lifetime'</span>] ?? <span class="keyword">null</span>) * <span class="number">60</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the cookie lifetime in seconds.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \DateTimeInterface</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getCookieExpirationDate</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $config = <span class="keyword">$this</span>-&gt;manager-&gt;getSessionConfig();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $config[<span class="string">'expire_on_close'</span>] ? <span class="number">0</span> : Carbon::now()-&gt;addMinutes($config[<span class="string">'lifetime'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Determine if a session driver has been configured.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">sessionConfigured</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ! is_null(<span class="keyword">$this</span>-&gt;manager-&gt;getSessionConfig()[<span class="string">'driver'</span>] ?? <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Determine if the configured session driver is persistent.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  array|null  $config</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">sessionIsPersistent</span><span class="params">(array $config = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $config = $config ?: <span class="keyword">$this</span>-&gt;manager-&gt;getSessionConfig();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ! in_array($config[<span class="string">'driver'</span>], [<span class="keyword">null</span>, <span class="string">'array'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Determine if the session is using cookie sessions.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">usingCookieSessions</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;sessionConfigured()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;manager-&gt;driver()-&gt;getHandler() <span class="keyword">instanceof</span> CookieSessionHandler;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="作用-10"><a href="#作用-10" class="headerlink" title="作用"></a>作用</h3><p>启用 <code>session</code>。同时执行 <code>session</code> 垃圾回收、 <code>referer</code> 保存，<code>session ID</code> 保存至 <code>cookies</code> 等操作。</p>
<h2 id="ShareErrorsFromSession"><a href="#ShareErrorsFromSession" class="headerlink" title="ShareErrorsFromSession"></a>ShareErrorsFromSession</h2><h3 id="源文件-11"><a href="#源文件-11" class="headerlink" title="源文件"></a>源文件</h3><p><code>vendor/laravel/framework/src/Illuminate/View/Middleware/ShareErrorsFromSession.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">View</span>\<span class="title">Middleware</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">ViewErrorBag</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">View</span>\<span class="title">Factory</span> <span class="title">as</span> <span class="title">ViewFactory</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShareErrorsFromSession</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The view factory implementation.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> \Illuminate\Contracts\View\Factory</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $view;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new error binder instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Contracts\View\Factory  $view</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(ViewFactory $view)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;view = $view;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle an incoming request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Http\Request  $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Closure  $next</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($request, Closure $next)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// If the current session has an "errors" variable bound to it, we will share</span></span><br><span class="line">        <span class="comment">// its value with all view instances so the views can easily access errors</span></span><br><span class="line">        <span class="comment">// without having to bind. An empty bag is set when there aren't errors.</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;view-&gt;share(</span><br><span class="line">            <span class="string">'errors'</span>, $request-&gt;session()-&gt;get(<span class="string">'errors'</span>) ?: <span class="keyword">new</span> ViewErrorBag</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Putting the errors in the view for every view allows the developer to just</span></span><br><span class="line">        <span class="comment">// assume that some errors are always available, which is convenient since</span></span><br><span class="line">        <span class="comment">// they don't have to continually run checks for the presence of errors.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $next($request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="作用-11"><a href="#作用-11" class="headerlink" title="作用"></a>作用</h3><p>将闪存到 <code>session</code> 中的错误消息数据，传递到视图中。</p>
<h2 id="SubstituteBindings"><a href="#SubstituteBindings" class="headerlink" title="SubstituteBindings"></a>SubstituteBindings</h2><h3 id="源文件-12"><a href="#源文件-12" class="headerlink" title="源文件"></a>源文件</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Routing</span>\<span class="title">Middleware</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Routing</span>\<span class="title">Registrar</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubstituteBindings</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The router instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> \Illuminate\Contracts\Routing\Registrar</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $router;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new bindings substitutor.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Contracts\Routing\Registrar  $router</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Registrar $router)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;router = $router;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle an incoming request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Http\Request  $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Closure  $next</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($request, Closure $next)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;router-&gt;substituteBindings($route = $request-&gt;route());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;router-&gt;substituteImplicitBindings($route);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $next($request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="作用-12"><a href="#作用-12" class="headerlink" title="作用"></a>作用</h3><p>检查路由模型绑定。</p>
<h2 id="AuthenticateWithBasicAuth"><a href="#AuthenticateWithBasicAuth" class="headerlink" title="AuthenticateWithBasicAuth"></a>AuthenticateWithBasicAuth</h2><h3 id="源文件-13"><a href="#源文件-13" class="headerlink" title="源文件"></a>源文件</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Auth</span>\<span class="title">Middleware</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Auth</span>\<span class="title">Factory</span> <span class="title">as</span> <span class="title">AuthFactory</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthenticateWithBasicAuth</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The guard factory instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> \Illuminate\Contracts\Auth\Factory</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $auth;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new middleware instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Contracts\Auth\Factory  $auth</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(AuthFactory $auth)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;auth = $auth;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle an incoming request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Http\Request  $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Closure  $next</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string|null  $guard</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($request, Closure $next, $guard = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;auth-&gt;guard($guard)-&gt;basic() ?: $next($request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="作用-13"><a href="#作用-13" class="headerlink" title="作用"></a>作用</h3><p><code>http</code> 基础认证，浏览器弹出账号密码输入框。</p>
<h2 id="Authorize"><a href="#Authorize" class="headerlink" title="Authorize"></a>Authorize</h2><h3 id="源文件-14"><a href="#源文件-14" class="headerlink" title="源文件"></a>源文件</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Auth</span>\<span class="title">Middleware</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Auth</span>\<span class="title">Access</span>\<span class="title">Gate</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Auth</span>\<span class="title">Factory</span> <span class="title">as</span> <span class="title">Auth</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Authorize</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The authentication factory instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> \Illuminate\Contracts\Auth\Factory</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $auth;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The gate instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> \Illuminate\Contracts\Auth\Access\Gate</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $gate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new middleware instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Contracts\Auth\Factory  $auth</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Contracts\Auth\Access\Gate  $gate</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Auth $auth, Gate $gate)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;auth = $auth;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;gate = $gate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle an incoming request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Http\Request  $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Closure  $next</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $ability</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  array|null  $models</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> \Illuminate\Auth\AuthenticationException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> \Illuminate\Auth\Access\AuthorizationException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($request, Closure $next, $ability, ...$models)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;auth-&gt;authenticate();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;gate-&gt;authorize($ability, <span class="keyword">$this</span>-&gt;getGateArguments($request, $models));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $next($request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the arguments parameter for the gate.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Http\Request  $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  array|null  $models</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array|string|\Illuminate\Database\Eloquent\Model</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getGateArguments</span><span class="params">($request, $models)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_null($models)) &#123;</span><br><span class="line">            <span class="keyword">return</span> [];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> collect($models)-&gt;map(<span class="function"><span class="keyword">function</span> <span class="params">($model)</span> <span class="title">use</span> <span class="params">($request)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> $model <span class="keyword">instanceof</span> Model ? $model : <span class="keyword">$this</span>-&gt;getModel($request, $model);</span><br><span class="line">        &#125;)-&gt;all();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the model to authorize.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Http\Request  $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $model</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \Illuminate\Database\Eloquent\Model|string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getModel</span><span class="params">($request, $model)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;isClassName($model) ? $model : $request-&gt;route($model);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Checks if the given string looks like a fully qualified class name.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">isClassName</span><span class="params">($value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> strpos($value, <span class="string">'\\'</span>) !== <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="作用-14"><a href="#作用-14" class="headerlink" title="作用"></a>作用</h3><p><code>Gate</code> 授权检查</p>
<h2 id="RedirectIfAuthenticated-1"><a href="#RedirectIfAuthenticated-1" class="headerlink" title="RedirectIfAuthenticated"></a>RedirectIfAuthenticated</h2><h3 id="源文件-15"><a href="#源文件-15" class="headerlink" title="源文件"></a>源文件</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Middleware</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Auth</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedirectIfAuthenticated</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle an incoming request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Http\Request  $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Closure  $next</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string|null  $guard</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($request, Closure $next, $guard = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Auth::guard($guard)-&gt;check()) &#123;</span><br><span class="line">            <span class="keyword">return</span> redirect(<span class="string">'/home'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $next($request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="作用-15"><a href="#作用-15" class="headerlink" title="作用"></a>作用</h3><p>访客授权检查。仅在用户未登录的情况下通过，否则重定向到统一的地址。</p>
<h2 id="ThrottleRequests"><a href="#ThrottleRequests" class="headerlink" title="ThrottleRequests"></a>ThrottleRequests</h2><h3 id="源文件-16"><a href="#源文件-16" class="headerlink" title="源文件"></a>源文件</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Routing</span>\<span class="title">Middleware</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">RuntimeException</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Str</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Cache</span>\<span class="title">RateLimiter</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">InteractsWithTime</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">HttpFoundation</span>\<span class="title">Response</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">HttpKernel</span>\<span class="title">Exception</span>\<span class="title">HttpException</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThrottleRequests</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">InteractsWithTime</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The rate limiter instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> \Illuminate\Cache\RateLimiter</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $limiter;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new request throttler.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Cache\RateLimiter  $limiter</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(RateLimiter $limiter)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;limiter = $limiter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle an incoming request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Http\Request  $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Closure  $next</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  int|string  $maxAttempts</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  float|int  $decayMinutes</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> \Symfony\Component\HttpKernel\Exception\HttpException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($request, Closure $next, $maxAttempts = <span class="number">60</span>, $decayMinutes = <span class="number">1</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $key = <span class="keyword">$this</span>-&gt;resolveRequestSignature($request);</span><br><span class="line"></span><br><span class="line">        $maxAttempts = <span class="keyword">$this</span>-&gt;resolveMaxAttempts($request, $maxAttempts);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;limiter-&gt;tooManyAttempts($key, $maxAttempts, $decayMinutes)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">$this</span>-&gt;buildException($key, $maxAttempts);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;limiter-&gt;hit($key, $decayMinutes);</span><br><span class="line"></span><br><span class="line">        $response = $next($request);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;addHeaders(</span><br><span class="line">            $response, $maxAttempts,</span><br><span class="line">            <span class="keyword">$this</span>-&gt;calculateRemainingAttempts($key, $maxAttempts)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Resolve the number of attempts if the user is authenticated or not.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Http\Request  $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  int|string  $maxAttempts</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveMaxAttempts</span><span class="params">($request, $maxAttempts)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Str::contains($maxAttempts, <span class="string">'|'</span>)) &#123;</span><br><span class="line">            $maxAttempts = explode(<span class="string">'|'</span>, $maxAttempts, <span class="number">2</span>)[$request-&gt;user() ? <span class="number">1</span> : <span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (int) $maxAttempts;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Resolve request signature.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Http\Request  $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> \RuntimeException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveRequestSignature</span><span class="params">($request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($user = $request-&gt;user()) &#123;</span><br><span class="line">            <span class="keyword">return</span> sha1($user-&gt;getAuthIdentifier());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($route = $request-&gt;route()) &#123;</span><br><span class="line">            <span class="keyword">return</span> sha1($route-&gt;getDomain().<span class="string">'|'</span>.$request-&gt;ip());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">            <span class="string">'Unable to generate the request signature. Route unavailable.'</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a 'too many attempts' exception.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  int  $maxAttempts</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \Symfony\Component\HttpKernel\Exception\HttpException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">buildException</span><span class="params">($key, $maxAttempts)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $retryAfter = <span class="keyword">$this</span>-&gt;getTimeUntilNextRetry($key);</span><br><span class="line"></span><br><span class="line">        $headers = <span class="keyword">$this</span>-&gt;getHeaders(</span><br><span class="line">            $maxAttempts,</span><br><span class="line">            <span class="keyword">$this</span>-&gt;calculateRemainingAttempts($key, $maxAttempts, $retryAfter),</span><br><span class="line">            $retryAfter</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HttpException(</span><br><span class="line">            <span class="number">429</span>, <span class="string">'Too Many Attempts.'</span>, <span class="keyword">null</span>, $headers</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the number of seconds until the next retry.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getTimeUntilNextRetry</span><span class="params">($key)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;limiter-&gt;availableIn($key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Add the limit header information to the given response.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Symfony\Component\HttpFoundation\Response  $response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  int  $maxAttempts</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  int  $remainingAttempts</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  int|null  $retryAfter</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \Symfony\Component\HttpFoundation\Response</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">addHeaders</span><span class="params">(Response $response, $maxAttempts, $remainingAttempts, $retryAfter = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $response-&gt;headers-&gt;add(</span><br><span class="line">            <span class="keyword">$this</span>-&gt;getHeaders($maxAttempts, $remainingAttempts, $retryAfter)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the limit headers information.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  int  $maxAttempts</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  int  $remainingAttempts</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  int|null  $retryAfter</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getHeaders</span><span class="params">($maxAttempts, $remainingAttempts, $retryAfter = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $headers = [</span><br><span class="line">            <span class="string">'X-RateLimit-Limit'</span> =&gt; $maxAttempts,</span><br><span class="line">            <span class="string">'X-RateLimit-Remaining'</span> =&gt; $remainingAttempts,</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (! is_null($retryAfter)) &#123;</span><br><span class="line">            $headers[<span class="string">'Retry-After'</span>] = $retryAfter;</span><br><span class="line">            $headers[<span class="string">'X-RateLimit-Reset'</span>] = <span class="keyword">$this</span>-&gt;availableAt($retryAfter);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $headers;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Calculate the number of remaining attempts.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  int  $maxAttempts</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  int|null  $retryAfter</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateRemainingAttempts</span><span class="params">($key, $maxAttempts, $retryAfter = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_null($retryAfter)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;limiter-&gt;retriesLeft($key, $maxAttempts);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="作用-16"><a href="#作用-16" class="headerlink" title="作用"></a>作用</h3><p>请求节流。限定单位时间内，同一客户端访问的评率。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.slpi1.com/20210219/laravel/email-filter.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="slpi1">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="easy note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/20210219/laravel/email-filter.html" itemprop="url">未命名</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-02-19T15:44:38+08:00">
                2021-02-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="邮件发送过滤"><a href="#邮件发送过滤" class="headerlink" title="邮件发送过滤"></a>邮件发送过滤</h1><h1 id="Index"><a href="#Index" class="headerlink" title="Index"></a>Index</h1><ul>
<li><a href="#实现思路">实现思路</a></li>
<li><a href="#监听事件">监听事件</a></li>
<li><a href="#过滤">过滤</a></li>
</ul>
<h2 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h2><p>开发中无法避免有要发送邮件的情况，在开发或测试环节，一般都需要对邮件发送操作进行拦截，仅对指定的邮箱发送邮件，避免用户收到测试邮件。在 <code>Laravel</code> 中有一个非常简单的办法实现这一功能，其原理如下：</p>
<p>无论是通过 <code>Mail</code> 或 <code>Notification</code> 的方式来发送邮件，最后都会执行到 <code>Illuminate\Mail\Mailer::class</code> 类的 <code>send()</code> 方法:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">send</span><span class="params">($view, array $data = [], $callback = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($view <span class="keyword">instanceof</span> MailableContract) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;sendMailable($view);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// First we need to parse the view, which could either be a string or an array</span></span><br><span class="line">    <span class="comment">// containing both an HTML and plain text versions of the view which should</span></span><br><span class="line">    <span class="comment">// be used when sending an e-mail. We will extract both of them out here.</span></span><br><span class="line">    <span class="keyword">list</span>($view, $plain, $raw) = <span class="keyword">$this</span>-&gt;parseView($view);</span><br><span class="line"></span><br><span class="line">    $data[<span class="string">'message'</span>] = $message = <span class="keyword">$this</span>-&gt;createMessage();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Once we have retrieved the view content for the e-mail we will set the body</span></span><br><span class="line">    <span class="comment">// of this message using the HTML type, which will provide a simple wrapper</span></span><br><span class="line">    <span class="comment">// to creating view based emails that are able to receive arrays of data.</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;addContent($message, $view, $plain, $raw, $data);</span><br><span class="line"></span><br><span class="line">    call_user_func($callback, $message);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If a global "to" address has been set, we will set that address on the mail</span></span><br><span class="line">    <span class="comment">// message. This is primarily useful during local development in which each</span></span><br><span class="line">    <span class="comment">// message should be delivered into a single mail address for inspection.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;to[<span class="string">'address'</span>])) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;setGlobalTo($message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Next we will determine if the message should be sent. We give the developer</span></span><br><span class="line">    <span class="comment">// one final chance to stop this message and then we will send it to all of</span></span><br><span class="line">    <span class="comment">// its recipients. We will then fire the sent event for the sent message.</span></span><br><span class="line">    $swiftMessage = $message-&gt;getSwiftMessage();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;shouldSendMessage($swiftMessage)) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;sendSwiftMessage($swiftMessage);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;dispatchSentEvent($message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在通过一系列的操作之后，得到了一个 <code>$swiftMessage</code> 对象，通过 <code>shouldSendMessage()</code> 方法来检查该对象是否应该发送邮件。此处会触发一个 <code>MessageSending</code> 事件，通过监听这个事件，并做出相应的返回，达到控制邮件是否发送的目的。</p>
<h2 id="监听事件"><a href="#监听事件" class="headerlink" title="监听事件"></a>监听事件</h2><p>在 <code>App\Providers\EventServiceProvider::class</code> 类中定义事件监听：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EventServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The event listener mappings for the application.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $listen = [</span><br><span class="line">        <span class="string">'Illuminate\Mail\Events\MessageSending'</span> =&gt; [</span><br><span class="line">            <span class="string">'App\Listeners\SendMailFilter'</span>,</span><br><span class="line">        ],</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后通过 <code>php artisan event:generate</code> 命令生成监听类 <code>App\Listeners\SendMailFilter::class</code></p>
<h2 id="过滤"><a href="#过滤" class="headerlink" title="过滤"></a>过滤</h2><p>在事件监听器中写入邮箱过滤的逻辑，比如通过添加白名单的方式:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SendMailFilter</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create the event listener.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义放行的收件邮箱列表</span></span><br><span class="line">    <span class="keyword">protected</span> $whiteList = [</span><br><span class="line">        <span class="string">'aaa@youzu.com'</span>,</span><br><span class="line">        <span class="string">'bbb@youzu.com'</span>,</span><br><span class="line">        <span class="string">'ccc@youzu.com'</span>,</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle the event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  MessageSending  $event</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">(MessageSending $event)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 如果是正式环境的非调试模式，不启用过滤</span></span><br><span class="line">        <span class="keyword">if</span> (App::environment(<span class="string">'production'</span>) &amp;&amp; !config(<span class="string">'app.debug'</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 此处的 $event-&gt;message 是Swift_Mime_SimpleMessage 类的一个实例</span></span><br><span class="line">        <span class="comment">// 获取收件邮箱列表</span></span><br><span class="line">        $to = $event-&gt;message-&gt;getTo();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// $cc = $event-&gt;message-&gt;getCc();</span></span><br><span class="line">        <span class="comment">// $bcc = $event-&gt;message-&gt;getBcc();</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> ($to <span class="keyword">as</span> $mail =&gt; $name) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!in_array($mail, <span class="keyword">$this</span>-&gt;whiteList)) &#123;</span><br><span class="line">                <span class="comment">// throw new Exception</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要注意的是，在 <code>return false</code> 处可以直接抛出异常，也可达到过滤效果，区别在于，通过 <code>return false</code> 的方式不会打断程序原始的执行流程。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.slpi1.com/20210219/laravel/auth.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="slpi1">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="easy note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/20210219/laravel/auth.html" itemprop="url">未命名</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-02-19T15:44:38+08:00">
                2021-02-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="laravel-Auth源码分析"><a href="#laravel-Auth源码分析" class="headerlink" title="laravel Auth源码分析"></a>laravel Auth源码分析</h1><h2 id="Index"><a href="#Index" class="headerlink" title="Index"></a>Index</h2><ul>
<li><a href="#Auth模块">Auth模块</a><ul>
<li><a href="#AuthManager">AuthManager</a></li>
<li><a href="#Guard">Guard</a><ul>
<li><a href="#SessionGuard与TokenGuard">SessionGuard与TokenGuard</a></li>
</ul>
</li>
<li><a href="#UserProvider">UserProvider</a></li>
</ul>
</li>
<li><a href="#Auth与框架的关系">Auth与框架的关系</a><ul>
<li><a href="#AuthServiceProvider">AuthServiceProvider</a></li>
<li><a href="#路由解析">路由解析</a></li>
<li><a href="#路由中间件">路由中间件</a></li>
</ul>
</li>
</ul>
<p><code>Auth</code> 模块用于处理用户认证。在源码中，关于 <code>Auth</code> 模块，有两处命名空间：</p>
<ul>
<li><code>Illuminate\Auth</code>: <code>Auth</code> 模块核心代码。这部分的代码都是关于 <code>Auth</code> 模块的实现原理及逻辑。</li>
<li><code>Illuminate\Foundation\Auth</code>: <code>Auth</code> 模块应用功能。这部分是 <code>Auth</code> 模块在应用层的一些功能的实现。</li>
</ul>
<h2 id="Auth模块"><a href="#Auth模块" class="headerlink" title="Auth模块"></a>Auth模块</h2><p>三大组成部分</p>
<ul>
<li><code>AuthManager</code>: 认证管理器</li>
<li><code>Guard</code>: 认证器 <code>or</code> 看守器</li>
<li><code>UserProvider</code>: 用户提供者</li>
</ul>
<h3 id="AuthManager"><a href="#AuthManager" class="headerlink" title="AuthManager"></a>AuthManager</h3><p><code>AuthManager</code> 是用户认证模块功能的入口，是 <code>Auth</code> 类指代的实例。 <code>AuthManager</code> 的职责在于管理及扩展 <code>Guard</code> 与 <code>UserProvider</code>，这是他的“本职工作”，如果在使用过程中，我们不涉及对认证功能的扩展，一般不会用到这部分；<code>AuthManager</code> 的另一个职责，在于充当模块功能的入口，转发应用中对于 <code>Auth</code> 类的调用到 <code>Guard</code>，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Auth::user();</span><br><span class="line">Auth::check();</span><br><span class="line">Auth::login($user);</span><br><span class="line"></span><br><span class="line">// 等同于</span><br><span class="line">Auth::guard(&apos;web&apos;)-&gt;user();</span><br><span class="line">Auth::guard(&apos;web&apos;)-&gt;check();</span><br><span class="line">Auth::guard(&apos;web&apos;)-&gt;login($user);</span><br></pre></td></tr></table></figure>
<h3 id="Guard"><a href="#Guard" class="headerlink" title="Guard"></a>Guard</h3><p><code>Guard</code> 用于实现认证功能，在 <code>AuthManager</code> 实例化 <code>Guard</code> 时，会绑定一个 <code>UserProvider</code> 给 <code>Guard</code> ，用于后续提供用户实例。框架实现了 <code>SessionGuard</code> 及 <code>TokenGuard</code> ，分别用于使用 <code>session</code>，<code>token</code> 做用户认证的场景。<code>Guard</code> 的认证逻辑可以概括为：<code>Guard</code> 从上下文中获取登陆凭证，将登陆凭证传递给 <code>UserProvider</code>，查询出登陆用户的实例返回给 <code>Guard</code>。</p>
<h4 id="SessionGuard与TokenGuard"><a href="#SessionGuard与TokenGuard" class="headerlink" title="SessionGuard与TokenGuard"></a>SessionGuard与TokenGuard</h4><p><code>Session</code> 是非常常用的认证手段，框架实现的 <code>SessionGuard</code> 除了拥有认证功能外，还赋予了登陆与退出的功能。这里简单描述一下认证，登陆与退出的概念：</p>
<ul>
<li>登陆：客户端提交认证资料，经服务端验证成功后，生成登陆凭证，保存到相应位置，完成登陆。</li>
<li>认证：服务端检查登陆凭证是否存在及有效，有则完成认证，请求放行。</li>
<li>退出：服务端销毁登陆凭证，完成退出。</li>
</ul>
<p>只有认证才是 <code>Guard</code> 的职责，其他两个并不是 <code>Guard</code> 的职责。基于不同的认证实现，登陆与退出功能可能会交给其他模块完成。比如基于 <code>JWT</code> 的 <code>Token</code> 认证方式，其登陆凭证是保存在客户端的，服务端不保存，所以服务端无法主动销毁登陆凭证，也就没有退出功能。然而基于 <code>Session</code> 的认证方式，登陆凭证是保存在服务端的，所以基于 <code>Session</code> 认证的方式，<strong>可以</strong>提供退出功能。</p>
<p><code>SessionGuard</code> 实现的登陆功能，也就是文档中所指的“手动认证用户”部分。<code>SessionGuard</code> 提供 <code>attempt</code> 接口，用于用户登陆，同时提供了 <code>logout</code> 接口，实现了退出功能。<code>TokenGuard</code> 并没有这两个功能。</p>
<h3 id="UserProvider"><a href="#UserProvider" class="headerlink" title="UserProvider"></a>UserProvider</h3><p>用户提供者接收由Guard传递的用户标识，查询出用户实例并返回。框架实现了 <code>EloquentUserProvider</code> 与 <code>DatabaseUserProvider</code> ，分别需要在 <code>Auth</code> 配置中指定用户模型与用户表。大多数情况都是使用 <code>EloquentUserProvider</code>。</p>
<h2 id="Auth与框架的关系"><a href="#Auth与框架的关系" class="headerlink" title="Auth与框架的关系"></a>Auth与框架的关系</h2><p>要完整的了解 <code>Auth</code> 模块的认证过程，需要结合框架的其他模块及细节来解读。</p>
<h3 id="AuthServiceProvider"><a href="#AuthServiceProvider" class="headerlink" title="AuthServiceProvider"></a>AuthServiceProvider</h3><p>和其他模块一样，<code>Auth</code> 模块也是由服务提供者注册，在 <code>Laravel</code> 应用生命周期中，处于第二阶段（容器启动）的结束阶段，在这里第一次与 <code>Request</code> 产生互动：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Illuminate\Auth\AuthServiceProvider</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">registerRequestRebindHandler</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;app-&gt;rebinding(<span class="string">'request'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($app, $request)</span> </span>&#123;</span><br><span class="line">        $request-&gt;setUserResolver(<span class="function"><span class="keyword">function</span> <span class="params">($guard = null)</span> <span class="title">use</span> <span class="params">($app)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> call_user_func($app[<span class="string">'auth'</span>]-&gt;userResolver(), $guard);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Auth</code>服务注册时，给 <code>request</code> 绑定了一个“重绑定”事件，该事件的目的何在？</p>
<p>首先需要知道，<code>request</code> 对象的实例化，是在容器启动之前，是一个比较早的阶段，可以说，在 <code>request</code> 对象第一次被实例化时，容器中基本还没有其他对象的存在，那么，如果在代码后续执行的过程中，需要丰富 <code>request</code> 对象，该怎么办呢？答案就是重绑定，在合适的时机，更新 <code>request</code> 对象之后，重新将 <code>request</code> 对象绑定到容器中。</p>
<p><code>Auth</code> 服务注册时，给 <code>request</code> 对象重绑定了一个事件，用于给 <code>request</code> 添加“用户解析”功能，当使用 <code>request</code> 的“用户解析”功能时，实际上会去找 <code>Guard</code> 要用户。然而，在服务注册阶段，<code>Guard</code> 表示我也还没实例化，你不能立刻来找我要用户，而是要“推迟”找我要用户的时间，所以，最终在这里绑定的是一个闭包，保存的是 <code>request</code> 解析用户的途径，在合适的时机，通过这一途径，即可找 <code>Guard</code> 要到用户，但这时机究竟是什么时候呢？这个时机，必须满足两个条件：</p>
<ul>
<li><code>request</code> 发生了重绑定</li>
<li><code>Guard</code> 认证用户结束</li>
</ul>
<h3 id="路由解析"><a href="#路由解析" class="headerlink" title="路由解析"></a>路由解析</h3><p>路由解析处于 <code>Laravel</code> 应用生命周期的的第三阶段（请求处理）。在第二阶段结束，第三阶段开始时，<code>request</code> 进行了重绑定：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Illuminate\Foundation\Http\Kernel</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// request 重绑定的发生过程</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// HTTP kernel 捕获request，开始处理</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($request)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $request-&gt;enableHttpMethodParameterOverride();</span><br><span class="line"></span><br><span class="line">        $response = <span class="keyword">$this</span>-&gt;sendRequestThroughRouter($request);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;reportException($e);</span><br><span class="line"></span><br><span class="line">        $response = <span class="keyword">$this</span>-&gt;renderException($request, $e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable $e) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;reportException($e = <span class="keyword">new</span> FatalThrowableError($e));</span><br><span class="line"></span><br><span class="line">        $response = <span class="keyword">$this</span>-&gt;renderException($request, $e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;app[<span class="string">'events'</span>]-&gt;dispatch(</span><br><span class="line">        <span class="keyword">new</span> Events\RequestHandled($request, $response)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $response;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. HTTP kernel 发送request通过路由</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">sendRequestThroughRouter</span><span class="params">($request)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 这里第一次对request经行绑定，但不会触发重绑定事件</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;app-&gt;instance(<span class="string">'request'</span>, $request);</span><br><span class="line">    <span class="comment">// 紧接着立刻清除已绑定的request对象</span></span><br><span class="line">    Facade::clearResolvedInstance(<span class="string">'request'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;bootstrap();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">new</span> Pipeline(<span class="keyword">$this</span>-&gt;app))</span><br><span class="line">        -&gt;send($request)</span><br><span class="line">        -&gt;through(<span class="keyword">$this</span>-&gt;app-&gt;shouldSkipMiddleware() ? [] : <span class="keyword">$this</span>-&gt;middleware)</span><br><span class="line">        -&gt;then(<span class="keyword">$this</span>-&gt;dispatchToRouter());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. HTTP kernel 准备解析路由</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatchToRouter</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">($request)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// request 在这里重新被绑定，触发重绑定事件</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;app-&gt;instance(<span class="string">'request'</span>, $request);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;router-&gt;dispatch($request);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>框架选择在此处对 <code>request</code> 进行重绑定，是因为，刚刚结束的第二阶段，已经完成了所有服务提供者的注册与启动，此时容器中已经存在所有的服务对象，通过服务对象来丰富 <code>request</code> 对象成为可能。</p>
<p>在 <code>request</code> 重新绑定之后，执行了这么一段代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Illuminate\Auth\AuthServiceProvider</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;router-&gt;dispatch($request);</span><br></pre></td></tr></table></figure>
<p>这段代码的后文比较长，我简单概况一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">匹配并命中路由 -&gt; 通过路由解析并实例化控制器对象 -&gt; 收集路由与控制器中定义的中间件 -&gt; 执行路由中间件 -&gt; 执行控制器方法</span><br></pre></td></tr></table></figure>
<h3 id="路由中间件"><a href="#路由中间件" class="headerlink" title="路由中间件"></a>路由中间件</h3><p>认证的行为，在中间件中触发。触发认证行为的中间件是<code>\Illuminate\Auth\Middleware\Authenticate::class</code>，在 <code>request</code> 通过该中间件时，<code>Guard</code> 检查 <code>request</code> 是否已通过认证，通过则放行，否则抛出<code>AuthenticationException</code>未认证异常。在通过认证之后，用户实例会保存在 <code>Guard</code> 对象中，后续所有找 <code>Guard</code> 要用户的行为，都可以得到相同的用户实例。至此，认证完成。</p>
<p>综上所述，用户的认证，发生在执行路由中间的过程中，在此之前，是无法通过 <code>Auth</code> 来获取认证用户的，需要特别注意的是，控制器的实例化过程，发生在路由中间件执行之前，所以无法在控制器的构造函数中获取用户的登陆状态。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.slpi1.com/20210219/laravel/eloquent-article.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="slpi1">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="easy note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/20210219/laravel/eloquent-article.html" itemprop="url">未命名</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-02-19T15:44:38+08:00">
                2021-02-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="laravel-ORM源码分析"><a href="#laravel-ORM源码分析" class="headerlink" title="laravel ORM源码分析"></a>laravel ORM源码分析</h1><p>在web应用中，与数据库的交互可以说是最常用且最重要的操作。作为当前最流行的php框架之一，laravel对数据库操作的封装，可以说是非常优秀了。在官方文档当中，数据库的使用说明文档占据了两个大章节，分别是【数据库】与【Eloquent ORM】，为什么针对同一功能，官方要出两个文档呢？是因为它重要？复杂？对此我无从猜测，不过可以从源码中窥知一二。</p>
<h1 id="一、-Eloquent的生命周期"><a href="#一、-Eloquent的生命周期" class="headerlink" title="一、 Eloquent的生命周期"></a>一、 Eloquent的生命周期</h1><p>在laravel应用的生命周期里，数据库部分出现在第二阶段，容器启动阶段。更精确的说，是容器启动阶段的服务提供者注册/启动阶段。数据库服务的入口，是数据库的服务提供者，即<code>Illuminate\Database\DatabaseServiceProvider</code>。</p>
<p>DatabaseServiceProvider的注册方法如代码所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public function register()</span><br><span class="line">&#123;</span><br><span class="line">    Model::clearBootedModels();</span><br><span class="line"></span><br><span class="line">    $this-&gt;registerConnectionServices();</span><br><span class="line"></span><br><span class="line">    $this-&gt;registerEloquentFactory();</span><br><span class="line"></span><br><span class="line">    $this-&gt;registerQueueableEntityResolver();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中，<code>registerConnectionServices()</code>方法注册了三个别名服务，分别是<code>db.factor/db/db.connection</code>。db用于管理数据库连接；db.factor用于创建数据库连接；而db.connection绑定了一个可用的连接对象。值得一提的是，db.connection是通过bind方法绑定闭包到容器当中，所以在注册阶段并未实例化，而是在真正 需要进行数据连接时实例化连接对象，然后替换原来的闭包。</p>
<p><code>registerEloquentFactory()</code>方法注册了数据填充功能中的数据工厂，用于生成模拟数据。<code>registerQueueableEntityResolver()</code>方法注册了队列的数据库实现。</p>
<p>接着，在DatabaseServiceProvider的启动方法中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public function boot()</span><br><span class="line">&#123;</span><br><span class="line">    Model::setConnectionResolver($this-&gt;app[&apos;db&apos;]);</span><br><span class="line"></span><br><span class="line">    Model::setEventDispatcher($this-&gt;app[&apos;events&apos;]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>分别调用了Model的两个静态方法<code>setConnectionResolver()/setEventDispatcher()</code>，加上注册方法中的<code>clearBootedModels()</code>，完成了Eloquent ORM的Model类的全局设置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Model::clearBootedModels();</span><br><span class="line">Model::setConnectionResolver($this-&gt;app[&apos;db&apos;]);</span><br><span class="line">Model::setEventDispatcher($this-&gt;app[&apos;events&apos;]);</span><br></pre></td></tr></table></figure>
<h1 id="二、-楔子-Eloquent-ORM的使用"><a href="#二、-楔子-Eloquent-ORM的使用" class="headerlink" title="二、 楔子 - Eloquent ORM的使用"></a>二、 楔子 - Eloquent ORM的使用</h1><p>我们先回顾一下官方文档中，关于ORM的用法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// 1. 静态调用</span><br><span class="line">User::all();</span><br><span class="line">User::find(1);</span><br><span class="line">User::where();</span><br><span class="line"></span><br><span class="line">// 2. 对象调用</span><br><span class="line">$flight = App\Flight::find(1);</span><br><span class="line">$flight-&gt;name = &apos;New Flight Name&apos;;</span><br><span class="line">$flight-&gt;save();</span><br><span class="line">$filght-&gt;delete();</span><br></pre></td></tr></table></figure>
<p>Eloquent ORM既可以通过静态调用执行方法，也可以先获取到模型对象，然后执行方法。但他们实质是一样的。在Model中定义的静态方法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">protected static function boot()</span><br><span class="line">protected static function bootTraits()</span><br><span class="line">public static function clearBootedModels()</span><br><span class="line">public static function on($connection = null)</span><br><span class="line">public static function onWriteConnection()</span><br><span class="line">public static function all($columns = [&apos;*&apos;])</span><br><span class="line">public static function with($relations)</span><br><span class="line">public static function destroy($ids)</span><br><span class="line">public static function query()</span><br><span class="line">public static function resolveConnection($connection = null)</span><br><span class="line">public static function getConnectionResolver()</span><br><span class="line">public static function setConnectionResolver(Resolver $resolver)</span><br><span class="line">public static function unsetConnectionResolver()</span><br><span class="line">public static function __callStatic($method, $parameters)</span><br></pre></td></tr></table></figure>
<p>可以看到，形如<code>User::find(1)/User::where()</code>的静态调用方法，本身不在类中有定义，而是转发到__callStatic魔术方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public static function __callStatic($method, $parameters)</span><br><span class="line">&#123;</span><br><span class="line">    return (new static)-&gt;$method(...$parameters);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也就是先实例化自身，然后在对象上执行调用。所以，在使用Eloquent的过程中，模型基本上都会有实例化的过程，然后再对象的基础上进行方法的调用。那么我们看看Model的构造方法中，都做了哪些动作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public function __construct(array $attributes = [])</span><br><span class="line">&#123;</span><br><span class="line">    $this-&gt;bootIfNotBooted();</span><br><span class="line"></span><br><span class="line">    $this-&gt;syncOriginal();</span><br><span class="line"></span><br><span class="line">    $this-&gt;fill($attributes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>bootIfNotBooted()</code>是模型的启动方法，标记模型被启动，并且触发模型启动的前置与后置事件。在启动过程中，会查询模型使用的trait中是否包含<code>boot{Name}</code>形式的方法，有的话就执行，这个步骤可以为模型扩展一些功能，比如文档中的软删除：</p>
<blockquote>
<p>要在模型上启动软删除，则必须在模型上使用 Illuminate\Database\Eloquent\SoftDeletes trait 并添加 deleted_at 字段到你的 $dates 属性上。</p>
</blockquote>
<p>就是在启动<code>SoftDeletes</code>traits的时候，给模型添加了一组查询作用域，来新增<code>Restore()/WithTrashed()/WithoutTrashed()/OnlyTrashed()</code>四个方法，同时改写delete方法的逻辑，从而定义了软删除的相关行为。</p>
<p><code>syncOriginal()</code>方法的作用在于保存原始对象数据，当更新对象的属性时，可以进行脏检查。</p>
<p><code>fill($attributes)</code>就是初始化模型的属性。</p>
<p>在实际运用中可能会注意到，我们很少会用new的方法、通过构造函数来实例化模型对象，但在后续我们要说道的查询方法中，会有一个<code>装载对象</code>的过程，有这样的用法。为什么我们很少会new一个Model，其实原因两个方面：首先从逻辑上说，是先有一条数据库记录，然后才有基于该记录的数据模型，所以在new之前必然要有查询数据库的动作；其次是因为直接new出来的Model，它的状态有可能并不正确，需要手动进行设置，可以查阅Model的<code>newInstance()/newFromBuilder()</code>两个方法来理解“状态不正确”的含义。</p>
<h1 id="三、-深入-Eloquent-ORM的查询过程"><a href="#三、-深入-Eloquent-ORM的查询过程" class="headerlink" title="三、 深入 - Eloquent ORM的查询过程"></a>三、 深入 - Eloquent ORM的查询过程</h1><p>我们以<code>User::all()</code>的查询过程来作为本小节的开始，Model的all()方法代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public static function all($columns = [&apos;*&apos;])</span><br><span class="line">&#123;</span><br><span class="line">    return (new static)-&gt;newQuery()-&gt;get(</span><br><span class="line">        is_array($columns) ? $columns : func_get_args()</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个查询过程，可以分成三个步骤来执行:</p>
<ul>
<li><code>new static</code>: 模型实例化，得到模型对象。</li>
<li><code>$model-&gt;newQuery()</code>: 根据模型对象，获取查询构造器$query。</li>
<li><code>$query-&gt;get($columns)</code>: 根据查询构造器，取得模型数据集合。</li>
</ul>
<p>Eloquent ORM的查询过程，就可以归纳成这三个过程:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[模型对象]=&gt;[查询构造器]=&gt;[数据集合]</span><br></pre></td></tr></table></figure>
<p>数据集合也是模型对象的集合，即使是做<code>first()</code>查询，也是先获取到只有一个对象的数据集合，然后取出第一个对象。但数据集合中的模型对象，与第一步中的模型对象不是同一个对象，作用也不一样。第一步实例化得到的模型对象，是一个<code>空对象</code>，其作用是为了获取第二步的查询构造器，第三步中的模型对象，是经过数据库查询，获取到数据后，对数据进行封装后的对象，是一个有数据的对象，从查询数据到模型对象的过程，我称之为<code>装载对象</code>，装载对象，正是使用的上文提及的<code>newFromBuilder()</code>方法。</p>
<p><code>newQuery()</code>的调用过程很长，概括如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">newQuery()</span><br><span class="line">--&gt;newQueryWithoutScopes()  // 添加查询作用域</span><br><span class="line">--&gt;newModelQuery() // 添加对关系模型的加载</span><br><span class="line">--&gt;newEloquentBuilder(newBaseQueryBuilder()) // 获取查询构造器</span><br><span class="line">--&gt; return new Builder(new QueryBuilder()) // 查询构造器的再封装</span><br></pre></td></tr></table></figure>
<p>它引出了Eloquent ORM中的一个重要概念，叫做$query，查询构造器，虽然官方文档中，有大篇幅关于Model的使用说明，但其实很多方法都会转发给$query去执行。从最后的一次调用可以看出，有两个查询构造器，分别是：</p>
<ul>
<li>数据库查询构造器：Illuminate\Database\Query\Builder</li>
<li>Eloquent ORM查询构造器：Illuminate\Database\Eloquent\Builder</li>
</ul>
<blockquote>
<p>备注：</p>
<ol>
<li>由于两个类名一致，我们约定当提到Builder时，我们指的是Illuminate\Database\Query\Builder;当提到EloquentBuilder时，我们指的是Illuminate\Database\Eloquent\Builder。</li>
<li>在代码中，Builder或EloquentBuilder的实例一般用变量$query来表示</li>
</ol>
</blockquote>
<p>这两个查询构造器的存在，解释了本文开头提到的问题：为什么关于数据库的文档说明，会分为两个章节？因为一章是对<code>Illuminate\Database\Query\Builder</code>的说明，另一章是对<code>Illuminate\Database\Eloquent\Builder</code>的说明(直观的理解为对Model的说明)。</p>
<p>数据库查询构造器Builder定义了一组通用的，人性化的操作接口，来描述将要执行的SQL语句（见官方文档【数据库 - 查询构造器】一章。）在这一层提供的接口更接近SQL原生的使用方法，比如：<code>where/join/select/insert/delete/update</code>等，都很容易在数据库的体系内找到相应的操作或指令；EloquentBuilder是对Builder的再封装，EloquentBuilder在Builder的基础之上，定义了一些更复杂，但更便捷的描述接口（见官方文档【Eloquent ORM - 快速入门】一章。），比如：<code>first/firstOrCreate/paginator</code>等。</p>
<h2 id="3-1-EloquentBuilder"><a href="#3-1-EloquentBuilder" class="headerlink" title="3.1 EloquentBuilder"></a>3.1 EloquentBuilder</h2><p>EloquentBuilder是Eloquent ORM查询构造器，是比较高级的能与数据库交互的对象。一般在Model层面的与数据库交互的方法，都会转发到Model的EloquentBuilder对象上去执行，通过下列方法可以获取到一个Eloquent对象：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$query = User::query();</span><br><span class="line">$query = User::select();</span><br></pre></td></tr></table></figure>
<p>每个EloquentBuilder对象都会有一个Builder成员对象。</p>
<h2 id="3-2-Builder"><a href="#3-2-Builder" class="headerlink" title="3.2 Builder"></a>3.2 Builder</h2><p>Builder是数据库查询构造器，在Builder层面已经可以与数据库进行交互了，如何获取到一个Builder对象呢？下面展示两种方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 获取Builder对象</span><br><span class="line">$query = DB::table(&apos;user&apos;);</span><br><span class="line">$query = User::query()-&gt;getQuery();</span><br><span class="line"></span><br><span class="line">// Builder对象与数据库交互</span><br><span class="line">$query-&gt;select(&apos;name&apos;)-&gt;where(&apos;status&apos;, 1)-&gt;orderBy(&apos;id&apos;)-&gt;get();</span><br></pre></td></tr></table></figure>
<p>Builder有三个成员对象:</p>
<ul>
<li>ConnectionInterface</li>
<li>Grammar</li>
<li>Processor</li>
</ul>
<p><strong>ConnectionInterface</strong></p>
<p>ConnectionInterface对象是执行SQL语句、对读写分离连接进行管理的对象，也就是数据库连接对象。是最初级的、能与数据交互的对象：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DB::select(&apos;select * from users where active = ?&apos;, [1]);</span><br><span class="line">DB::insert(&apos;insert into users (id, name) values (?, ?)&apos;, [1, &apos;Dayle&apos;]);</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>虽然DB门面指向的是<code>Illuminate\Database\DatabaseManager</code>的实例，但是对数据库交互上的操作，都会转发到connection上去执行。</p>
</blockquote>
<p>回头看本文中 <a href="#Eloquent的生命周期">Eloquent的生命周期</a> 关于DatabaseServiceProvider的启动方法的描述，DatabaseServiceProvider的启动方法中执行的代码 <code>Model::setConnectionResolver($this-&gt;app[&#39;db&#39;]);</code> ，这个步骤就是为了后续获取Builder的第一个成员对象<code>ConnectionInterface</code>，数据库连接对象。前文提到过，数据库的连接并不是在服务提供者启动时进行的，是在做出查询动作时才会连接数据库：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">// Illuminate\Database\Eloquent\Model::class</span><br><span class="line">protected function newBaseQueryBuilder()</span><br><span class="line">&#123;</span><br><span class="line">    // 获取数据库连接</span><br><span class="line">    $connection = $this-&gt;getConnection();</span><br><span class="line"></span><br><span class="line">    // Builder实例化时传入的三个对象，ConnectionInterface、Grammar、Processor</span><br><span class="line">    return new QueryBuilder(</span><br><span class="line">        $connection, $connection-&gt;getQueryGrammar(), $connection-&gt;getPostProcessor()</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public function getConnection()</span><br><span class="line">&#123;</span><br><span class="line">    return static::resolveConnection($this-&gt;getConnectionName());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public static function resolveConnection($connection = null)</span><br><span class="line">&#123;</span><br><span class="line">    // 使用通过Model::setConnectionResolver($this-&gt;app[&apos;db&apos;])注入的resolver进行数据库的连接</span><br><span class="line">    return static::$resolver-&gt;connection($connection);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Grammar</strong></p>
<p>Grammar对象是SQL语法解析对象，我们在Builder对象中调用的方法，会以Builder属性的形式将调用参数管理起来，然后在调用SQL执行方法时，先通过Grammar对象对这些数据进行解析，解析出将要执行的SQL语句，然后交给ConnectionInterface执行，获取到数据。</p>
<p><strong>Processor</strong></p>
<p>Processor对象的作用比较简单，将查询结果数据返回给Builder，包括查询的行数据，插入后的自增ID值。</p>
<h2 id="3-3-SELECT语句的描述"><a href="#3-3-SELECT语句的描述" class="headerlink" title="3.3 SELECT语句的描述"></a>3.3 SELECT语句的描述</h2><p>在Builder对象中，关于数据库查询语句的描述，被分成12个部分:</p>
<ul>
<li>aggregate: 聚合查询列描述，该部分与columns互斥</li>
<li>columns: 查询列描述</li>
<li>from: 查询表描述</li>
<li>joins: 聚合表描述</li>
<li>wheres: 查询条件描述</li>
<li>groups: 分组描述</li>
<li>havings: 分组条件描述</li>
<li>orders: 排序条件描述</li>
<li>limit: 限制条数描述</li>
<li>offset: 便宜了描述</li>
<li>unions: 组合查询描述</li>
<li>lock: 锁描述</li>
</ul>
<p>其中，关于wherers的描述提供了相当丰富的操作接口，在实现这部分的接口时，在查询构造器Builder中将where操作分成了以下类型： <code>Basic/Column/In/NotIn/NotInSub/InSub/NotNull/Null/between/Nested/Sub/NotExists/Exists/Raw</code>。wheres条件的组装在 <code>Illuminate\Database\Query\Grammars\Grammar::compileWheres()</code> 方法中完成，每种类型都由两个部分组成：<code>逻辑符号 + 条件表达式</code>，逻辑符号包含<code>and/or</code>。多个where条件直接连接后，通过Grammar::removeLeadingBoolean去掉头部的逻辑符号，组装成最终的条件部分。如果有 <code>Nested</code> 的wheres描述，对Nested的部分单独执行<code>compileWheres</code>后，用括号包装起来形成一个复合的 <code>条件表达式</code>。</p>
<p>wheresTable:</p>
<table>
<thead>
<tr>
<th>type</th>
<th>boolean</th>
<th>condition</th>
</tr>
</thead>
<tbody>
<tr>
<td>Basic</td>
<td><del>and</del> (Grammar::removeLeadingBoolean)</td>
<td>id = 1</td>
</tr>
<tr>
<td>Column</td>
<td>and</td>
<td>table1.column1 = table2.column2</td>
</tr>
<tr>
<td>Nested</td>
<td>and</td>
<td>(wheresTable)</td>
</tr>
</tbody>
</table>
<p>最终组合成的Sql语句就是 <code>id = 1 and table1.column1 = table2.column2 and (...)</code>。</p>
<p>where用法的一些注意事项：</p>
<ul>
<li>where的第一个参数是数组或闭包时，条件被描述为Nested类型，也就是参数分组。</li>
<li>where的第二个参数，比较符号是等于号时，可以省略。</li>
<li>where的第三个参数是闭包时，表示一个子查询</li>
</ul>
<h2 id="3-4-join语句的描述"><a href="#3-4-join语句的描述" class="headerlink" title="3.4 join语句的描述"></a>3.4 join语句的描述</h2><p>每次对Builder执行join操作时，都会新建一个JoinClause对象，在文档中关于高级 Join 语法的说明中，有非常类似于where参数分组的用法，就是由闭包导入查询条件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// join高级用法</span><br><span class="line">DB::table(&apos;users&apos;)</span><br><span class="line">    -&gt;join(&apos;contacts&apos;, function ($join) &#123;</span><br><span class="line">        $join-&gt;on(&apos;users.id&apos;, &apos;=&apos;, &apos;contacts.user_id&apos;)-&gt;orOn(...);</span><br><span class="line">    &#125;)</span><br><span class="line">    -&gt;get();</span><br><span class="line"></span><br><span class="line">// where参数分组</span><br><span class="line">DB::table(&apos;users&apos;)</span><br><span class="line">    -&gt;where(&apos;name&apos;, &apos;=&apos;, &apos;John&apos;)</span><br><span class="line">    -&gt;orWhere(function ($query) &#123;</span><br><span class="line">        $query-&gt;where(&apos;votes&apos;, &apos;&gt;&apos;, 100)</span><br><span class="line">              -&gt;where(&apos;title&apos;, &apos;&lt;&gt;&apos;, &apos;Admin&apos;);</span><br><span class="line">    &#125;)</span><br><span class="line">    -&gt;get();</span><br></pre></td></tr></table></figure>
<p>实际上JoinClause继承自Builder，所以上述代码中的闭包参数$join，后面也是可以链式调用where系列函数的。与Builder对象的区别在于扩展了一个on方法，on方法类似于whereColumn，条件的两边是对表字段的描述。</p>
<p>Builder调用join方法时传入的条件，会以<code>Nested</code>的类型添加到JoinClause对象当中，然后将JoinClause对象加入到Builder的joins部分。join结构的组装与wheres类似，会单独对JoinClause对象进行一次compileWheres，然后组装到整体SQL语句中：<code>&quot;{$join-&gt;type} join {$table} {$this-&gt;compileWheres($join)}&quot;</code>。</p>
<h1 id="四、-高级-读写分离的实现"><a href="#四、-高级-读写分离的实现" class="headerlink" title="四、 高级 - 读写分离的实现"></a>四、 高级 - 读写分离的实现</h1><p>读写分离的问题在connection的范畴。当模型实例化Builder的时候，会先去获取一个connection，如果有配置读写分离，先获取一个writeConnection，然后获取一个readConnection，并绑定到writeConnection上去。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Illuminate\Database\Connectors\ConnectionFactory</span><br><span class="line">public function make(array $config, $name = null)</span><br><span class="line">&#123;</span><br><span class="line">    $config = $this-&gt;parseConfig($config, $name);</span><br><span class="line"></span><br><span class="line">    if (isset($config[&apos;read&apos;])) &#123;</span><br><span class="line">        return $this-&gt;createReadWriteConnection($config);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return $this-&gt;createSingleConnection($config);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">protected function createReadWriteConnection(array $config)</span><br><span class="line">&#123;</span><br><span class="line">    $connection = $this-&gt;createSingleConnection($this-&gt;getWriteConfig($config));</span><br><span class="line"></span><br><span class="line">    return $connection-&gt;setReadPdo($this-&gt;createReadPdo($config));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意此时的writeConnection与readConnection并不会真正的连接数据库，而是一个闭包，保存了获取连接的方法，当第一次需要连接数据时，执行闭包获取到连接，并将该连接替换掉闭包，后续执行SQL语句时直接使用该连接即可。在实际使用过程中，可能读写连接的使用并不能简单的按照定义而来，有时需要主动设置要使用的连接。</p>
<h2 id="4-1-读连接的使用判定"><a href="#4-1-读连接的使用判定" class="headerlink" title="4.1 读连接的使用判定"></a>4.1 读连接的使用判定</h2><p>在配置读写分离后，默认查询会使用readConnection，以下情况会使用writeConnection：</p>
<ul>
<li>对select操作指定为write：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// connection 级别指定</span><br><span class="line">Illuminate\Database\Connection::select($query, $bindings = [], $useReadPdo = true);</span><br><span class="line"></span><br><span class="line">// Builder 级别指定</span><br><span class="line">DB::table(&apos;user&apos;)-&gt;useWritePdo()-&gt;get();</span><br><span class="line"></span><br><span class="line">// Model 级别指定</span><br><span class="line">Model::onWriteConnection()-&gt;get()</span><br></pre></td></tr></table></figure>
<ul>
<li>查询时启用锁</li>
<li>启用事务</li>
<li>启用sticky配置且前文有写操作</li>
<li>在队列执行时，读取SerializesModels的模型数据时</li>
</ul>
<p>关于其判定逻辑的代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// Illuminate\Database\Connection::getReadPdo():</span><br><span class="line">public function getReadPdo()</span><br><span class="line">&#123;</span><br><span class="line">    if ($this-&gt;transactions &gt; 0) &#123;</span><br><span class="line">        return $this-&gt;getPdo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if ($this-&gt;getConfig(&apos;sticky&apos;) &amp;&amp; $this-&gt;recordsModified) &#123;</span><br><span class="line">        return $this-&gt;getPdo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if ($this-&gt;readPdo instanceof Closure) &#123;</span><br><span class="line">        return $this-&gt;readPdo = call_user_func($this-&gt;readPdo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return $this-&gt;readPdo ?: $this-&gt;getPdo();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="五、-进阶-关系模型"><a href="#五、-进阶-关系模型" class="headerlink" title="五、 进阶 - 关系模型"></a>五、 进阶 - 关系模型</h1><p>关于关系模型的定义，其操作接口全部定义在Illuminate\Database\Eloquent\Concerns\HasRelationships::trait中。每个关系定义方法，都是对一个关系对象的定义。</p>
<h2 id="5-1-关系对象"><a href="#5-1-关系对象" class="headerlink" title="5.1 关系对象"></a>5.1 关系对象</h2><p>关系对象全部继承自 <code>Illuminate\Database\Eloquent\Relations\Relation::abstract</code> 虚拟类。关系对象由一个查询构造器组成，用来保存由关系定义所决定的关系查询条件，和加载关系时的额外条件。比如一对一（多）的关系定义中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public function addConstraints()</span><br><span class="line">&#123;</span><br><span class="line">    if (static::$constraints) &#123;</span><br><span class="line">        $this-&gt;query-&gt;where($this-&gt;foreignKey, &apos;=&apos;, $this-&gt;getParentKey());</span><br><span class="line"></span><br><span class="line">        $this-&gt;query-&gt;whereNotNull($this-&gt;foreignKey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每当需要获取关系数据时，都会实例化关系对象，实例化的过程中调用addConstraints方法。与此同时，在加载关系数据时，可以传入额外的查询条件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$users = App\User::with([&apos;posts&apos; =&gt; function ($query) &#123;</span><br><span class="line">    $query-&gt;where(&apos;title&apos;, &apos;like&apos;, &apos;%first%&apos;);</span><br><span class="line">&#125;])-&gt;get();</span><br></pre></td></tr></table></figure>
<p>这些条件最终都会保存在关系对象的查询构造器中，在获取关系数据时，起到筛选作用。</p>
<p>在使用关系模型时，有两种模式：一种是即时加载模式，一种是预加载模式。</p>
<h2 id="5-2-即时加载"><a href="#5-2-即时加载" class="headerlink" title="5.2 即时加载"></a>5.2 即时加载</h2><p>即时加载关系对象，是基于当前模型对象来获取关系数据。当以<code>$user-&gt;post</code>的形式获取Model关系属性时，通过__get方法触发对关系模型的获取。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public function getAttribute($key)</span><br><span class="line">&#123;</span><br><span class="line">    if (! $key) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 访问对象属性或存取器</span><br><span class="line">    if (array_key_exists($key, $this-&gt;attributes) ||</span><br><span class="line">        $this-&gt;hasGetMutator($key)) &#123;</span><br><span class="line">        return $this-&gt;getAttributeValue($key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 判断同名方法是否存在</span><br><span class="line">    if (method_exists(self::class, $key)) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 获取关系对象</span><br><span class="line">    return $this-&gt;getRelationValue($key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取关系模型并实例化，得到关系模型对象，执行关系模型对象的addConstraints方法，将模型对象，转化为关系模型对象的查询条件：</p>
<ul>
<li>已知模型对象</li>
<li>关系定义绑定对象的模型名称</li>
<li>关系定义外键，已知模型对象的主键，及主键的值<br>通过上述三个条件，可以生成关系查询，并获取到结果，这个过程是即时加载关系数据的。</li>
</ul>
<p>即时加载在只有单个模型对象时比较适用，如果我们拥有的是一个模型集合，并且需要用到关系数据时，通过即时加载的模式，会有N+1的问题。针对每个模型去获取关系数据，都要进行一次数据库查询，这种情况下，就需要使用预加载的模式。</p>
<h2 id="5-3-预加载"><a href="#5-3-预加载" class="headerlink" title="5.3 预加载"></a>5.3 预加载</h2><p>对于预加载关系的情况，Model::with(‘relation’)标记关系为预加载，在Model::get()获取数据时，检查到对关系的预加载标记，会对关系进行实例化，这个实例化的过程，会通过Relation::noConstraints屏蔽对关系数据的直接加载，在后续过程中，由通过Model::get()获取的模型列表数据，得到模型的ID列表，关系利用这个ID列表，统一查询关系模型数据。查询完成之后匹配到对应的模型中去，其过程如下：</p>
<ul>
<li>EloquentBuilder::get():<ul>
<li>Builder::get() 获取到模型数据列表</li>
<li>EloquentBuilder::eagerLoadRelations(): 获取所有模型关系<ul>
<li>foreach relations EloquentBuilder::eagerLoadRelation() 针对每个关系获取关系数据</li>
</ul>
</li>
<li>Collection: 转化为集合</li>
</ul>
</li>
</ul>
<p>其中：eagerLoadRelation()的代码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Illuminate\Database\Eloquent\Builder::eagerLoadRelation()</span><br><span class="line">protected function eagerLoadRelation(array $models, $name, Closure $constraints)</span><br><span class="line">&#123;</span><br><span class="line">    // 获取关系对象，这里获取关系对象时会通过Relation::noConstraints屏蔽即时加载</span><br><span class="line">    $relation = $this-&gt;getRelation($name);</span><br><span class="line"></span><br><span class="line">    // 在这里将模型id列表注入到关系对象中，作为关系模型查询的条件</span><br><span class="line">    $relation-&gt;addEagerConstraints($models);</span><br><span class="line"></span><br><span class="line">    // 这里可以注入Model::with([&apos;relation&apos; =&gt; function($query)&#123;&#125;])时定义的关系额外条件</span><br><span class="line">    $constraints($relation);</span><br><span class="line"></span><br><span class="line">    // 匹配每个关系对象数据到模型对象中去</span><br><span class="line">    return $relation-&gt;match(</span><br><span class="line">        $relation-&gt;initRelation($models, $name),</span><br><span class="line">        $relation-&gt;getEager(), $name</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="六、-总结"><a href="#六、-总结" class="headerlink" title="六、 总结"></a>六、 总结</h1><p>理解laravel的Eloquent ORM模型，可以先建立下列对象的概念：</p>
<ul>
<li>Model，模型对象，编码中比较容易接触与使用的对象，是框架开放给用户的最直观的操作接口;</li>
<li>EloquentBuilder，Eloquent查询构造器;</li>
<li>Builder，数据库查询构造器，是EloquentBuilder的组成部分;</li>
<li>connection，数据库连接对象，与数据库进行交互，执行查询构造器描述的SQL语句;</li>
<li>Grammar，语法解析器，将查询构造器的描述解释为规范的SQL语句;</li>
<li>Processor，转发查询进程的结果数据;</li>
<li>Relation，关系对象，描述两个模型之间的关系，关键是关系之间的查询条件;</li>
<li>JoinClause，连接查询对象，多表join查询的实现;</li>
</ul>
<p>上述对象的关系如图所示 <img src="/images/Laravel-Model.png" alt="relateion"></p>
<p>当然，Eloquent ORM还有其他跟多的特性，比如数据迁移、数据填充、查询作用域、存取器等，可以留给读者自行去了解与熟悉。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="slpi1" />
          <p class="site-author-name" itemprop="name">slpi1</p>
           
              <p class="site-description motion-element" itemprop="description">PHP,Laravel,thinkPHP,javascript,css</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">42</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">slpi1</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

</body>
</html>
