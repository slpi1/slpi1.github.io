<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="PHP,Laravel,thinkPHP,javascript,css">
<meta property="og:type" content="website">
<meta property="og:title" content="slpi1">
<meta property="og:url" content="http://blog.slpi1.com/page/3/index.html">
<meta property="og:site_name" content="slpi1">
<meta property="og:description" content="PHP,Laravel,thinkPHP,javascript,css">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="slpi1">
<meta name="twitter:description" content="PHP,Laravel,thinkPHP,javascript,css">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"right","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.slpi1.com/page/3/"/>





  <title>slpi1</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">slpi1</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">slpi1</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.slpi1.com/20190506/laravel/progress.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="slpi1">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="slpi1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/20190506/laravel/progress.html" itemprop="url">laravel 主流程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-06T11:26:00+08:00">
                2019-05-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">st=&gt;start: index.php入口</span><br><span class="line">e=&gt;end: 结束</span><br><span class="line">define_start_time=&gt;operation: 定义开始运行时间LARAVEL_START</span><br><span class="line">autoload=&gt;operation: composer自动加载</span><br><span class="line">load_app=&gt;condition: 框架载入</span><br><span class="line">instance_application=&gt;condition: 实例化容器</span><br><span class="line">Application::__construct</span><br><span class="line"></span><br><span class="line">app_base_binding=&gt;operation: 容器自绑定</span><br><span class="line">app_base_provider=&gt;operation: 容器基础provider注册</span><br><span class="line">Route/Log/Event</span><br><span class="line">app_base_alias=&gt;operation: 容器核心别名定义</span><br><span class="line"></span><br><span class="line">bind_base_kernel=&gt;operation: 单例绑定容器核心服务</span><br><span class="line">HttpKernel</span><br><span class="line">ConsoleKernel</span><br><span class="line">ExceptionsHandler</span><br><span class="line"></span><br><span class="line">make_http_kernel=&gt;operation: 实例化http处理器</span><br><span class="line">capture_http=&gt;operation: 捕获http请求</span><br><span class="line">kernel_handle_request=&gt;condition: http处理器处理请求</span><br><span class="line">bootstrap=&gt;condition: 容器启动</span><br><span class="line">bootstrap_app=&gt;operation: 加载环境变量配置</span><br><span class="line">加载配置文件</span><br><span class="line">注册异常handler</span><br><span class="line">注册Facades</span><br><span class="line">注册应用providers</span><br><span class="line">启动应用proveider</span><br><span class="line"></span><br><span class="line">common_middleware=&gt;condition: 全局中间件过滤</span><br><span class="line">dispatch_route=&gt;operation: 解析路由</span><br><span class="line">match_route=&gt;operation: 匹配路由</span><br><span class="line">instance_controller=&gt;operation: 实例化控制器</span><br><span class="line">route_middleware=&gt;condition: 路由中间件过滤</span><br><span class="line">call_action=&gt;operation: callAction引导执行控制器方法</span><br><span class="line">run_action=&gt;operation: 执行控制器</span><br><span class="line"></span><br><span class="line">common_middleware_item=&gt;operation: 全局中间件详情</span><br><span class="line">up&amp;down检查</span><br><span class="line">post包大小检查</span><br><span class="line">空格过滤</span><br><span class="line">空数据转化为null</span><br><span class="line">代理设置</span><br><span class="line"></span><br><span class="line">web_route_middleware_item=&gt;operation: 路由中间件详情</span><br><span class="line">cookie加密解密</span><br><span class="line">cookie设置</span><br><span class="line">start session</span><br><span class="line">Error闪存至session</span><br><span class="line">csrf验证</span><br><span class="line">路由模型绑定监听</span><br><span class="line"></span><br><span class="line">send_response=&gt;operation: 发送响应</span><br><span class="line">kernel_terminate=&gt;operation: http处理器运行后台任务</span><br><span class="line"></span><br><span class="line">st-&gt;define_start_time-&gt;autoload-&gt;load_app</span><br><span class="line">load_app(yes,right)-&gt;instance_application</span><br><span class="line">load_app(no,)-&gt;make_http_kernel-&gt;capture_http-&gt;kernel_handle_request</span><br><span class="line">instance_application(no)-&gt;bind_base_kernel(left)-&gt;make_http_kernel</span><br><span class="line">instance_application(yes, right)-&gt;app_base_binding-&gt;app_base_provider-&gt;app_base_alias(left)-&gt;bind_base_kernel</span><br><span class="line">kernel_handle_request(no)-&gt;send_response-&gt;kernel_terminate-&gt;e</span><br><span class="line">kernel_handle_request(yes, right)-&gt;bootstrap</span><br><span class="line">bootstrap(no)-&gt;common_middleware</span><br><span class="line">bootstrap(yes, right)-&gt;bootstrap_app</span><br><span class="line">common_middleware(no)-&gt;dispatch_route-&gt;match_route-&gt;instance_controller-&gt;route_middleware</span><br><span class="line">common_middleware(yes, right)-&gt;common_middleware_item</span><br><span class="line">route_middleware(no)-&gt;call_action-&gt;run_action(left)-&gt;send_response</span><br><span class="line">route_middleware(yes, right)-&gt;web_route_middleware_item</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.slpi1.com/20190506/laravel/progress-doc.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="slpi1">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="slpi1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/20190506/laravel/progress-doc.html" itemprop="url">laravel应用执行流程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-06T11:26:00+08:00">
                2019-05-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Index"><a href="#Index" class="headerlink" title="Index"></a>Index</h1><ul>
<li><a href="#应用入口">应用入口</a><ul>
<li><a href="#第一阶段：容器准备阶段">第一阶段：容器准备阶段</a><ul>
<li><a href="#$app对象实例化">$app对象实例化</a></li>
<li><a href="#Illuminate\Contracts\Http\Kernel::class">Illuminate\Contracts\Http\Kernel::class</a></li>
<li><a href="#Illuminate\Contracts\Console\Kernel::class">Illuminate\Contracts\Console\Kernel::class</a></li>
<li><a href="#Illuminate\Contracts\Debug\ExceptionHandler::class">Illuminate\Contracts\Debug\ExceptionHandler::class</a></li>
</ul>
</li>
<li><a href="#第二阶段：容器启动阶段">第二阶段：容器启动阶段</a><ul>
<li><a href="#Http处理器捕获请求">Http处理器捕获请求</a></li>
<li><a href="#启动容器">启动容器</a></li>
<li><a href="#启动服务提供者">启动服务提供者</a></li>
</ul>
</li>
<li><a href="#第三阶段：请求处理阶段">第三阶段：请求处理阶段</a><ul>
<li><a href="#路由解析">路由解析</a></li>
<li><a href="#全局中间件过滤">全局中间件过滤</a></li>
<li><a href="#控制器实例化">控制器实例化</a></li>
<li><a href="#路由中间件过滤">路由中间件过滤</a></li>
<li><a href="#运行路由方法并响应">运行路由方法并响应</a></li>
</ul>
</li>
<li><a href="#第四阶段：terminate">第四阶段：terminate</a></li>
</ul>
</li>
</ul>
<h2 id="应用入口"><a href="#应用入口" class="headerlink" title="应用入口"></a>应用入口</h2><p>请求经过web服务器，路由到index.php入口文件。在入口文件中引入<code>vendor/autoload.php</code>和<code>bootstrap/app.php</code>文件。其中，前者是文件自动加载规则，后者是应用启动文件。</p>
<h3 id="第一阶段：容器准备阶段"><a href="#第一阶段：容器准备阶段" class="headerlink" title="第一阶段：容器准备阶段"></a>第一阶段：容器准备阶段</h3><p>在该文件中，首先实例化应用核心容器<code>Illuminate\Foundation\Application</code>，即<code>$app</code>对象，然后单例绑定容器核心服务：</p>
<ul>
<li><code>Illuminate\Contracts\Http\Kernel::class</code></li>
<li><code>Illuminate\Contracts\Console\Kernel::class</code></li>
<li><code>Illuminate\Contracts\Debug\ExceptionHandler::class</code></li>
</ul>
<h4 id="app对象实例化"><a href="#app对象实例化" class="headerlink" title="$app对象实例化"></a>$app对象实例化</h4><ul>
<li>实例化应用核心容器时，传入应用根目录作为参数。以此目录分别衍生出<code>base/lang/config/public/storage/database/resources/bootstrap</code>等应用目录</li>
<li>然后将应用对象绑定到自身<code>app</code>别名与<code>Illuminate\Container\Container::class</code>接口，同时绑定<code>PackageManifest::class</code>对象，后续用于对<code>composer.json</code>文件的解析</li>
<li>接下来注册基础服务提供者<code>EventServiceProvider/LogServiceProvider/RoutingServiceProvider</code></li>
<li>最后进行核心别名的定义，</li>
</ul>
<h4 id="Illuminate-Contracts-Http-Kernel-class"><a href="#Illuminate-Contracts-Http-Kernel-class" class="headerlink" title="Illuminate\Contracts\Http\Kernel::class"></a>Illuminate\Contracts\Http\Kernel::class</h4><p>该接口绑定http请求处理器。用于接收并处理来自web的请求</p>
<h4 id="Illuminate-Contracts-Console-Kernel-class"><a href="#Illuminate-Contracts-Console-Kernel-class" class="headerlink" title="Illuminate\Contracts\Console\Kernel::class"></a>Illuminate\Contracts\Console\Kernel::class</h4><p>该接口绑定Console处理器。用于接收来自CLI的命令。</p>
<h4 id="Illuminate-Contracts-Debug-ExceptionHandler-class"><a href="#Illuminate-Contracts-Debug-ExceptionHandler-class" class="headerlink" title="Illuminate\Contracts\Debug\ExceptionHandler::class"></a>Illuminate\Contracts\Debug\ExceptionHandler::class</h4><p>该接口绑定异常处理器。用于在应用中出现异常时，做出对应的响应。</p>
<h3 id="第二阶段：容器启动阶段"><a href="#第二阶段：容器启动阶段" class="headerlink" title="第二阶段：容器启动阶段"></a>第二阶段：容器启动阶段</h3><p>在做完第一阶段的准备工作后，从容器中解析出Http处理器，Http处理器捕获到请求，开始启动容器。</p>
<h4 id="Http处理器捕获请求"><a href="#Http处理器捕获请求" class="headerlink" title="Http处理器捕获请求"></a>Http处理器捕获请求</h4><p>捕获请求也就是<code>$request</code> 对象的初始化。</p>
<h4 id="启动容器"><a href="#启动容器" class="headerlink" title="启动容器"></a>启动容器</h4><p>在捕获到请求后，需要先启动容器，容器启动的动作由Http处理器触发，并启动由Http处理器定义的启动文件，启动文件列表如下：</p>
<ul>
<li><code>\Illuminate\Foundation\Bootstrap\LoadEnvironmentVariables::class</code>: 加载环境变量配置.env文件</li>
<li><code>\Illuminate\Foundation\Bootstrap\LoadConfiguration::class</code>: 加载配置目录配置文件</li>
<li><code>\Illuminate\Foundation\Bootstrap\HandleExceptions::class</code>: 注册异常处理函数</li>
<li><code>\Illuminate\Foundation\Bootstrap\RegisterFacades::class</code>: 注册Facade，由<code>config/app.php</code>中定义的aliases和从composer.json中解析出的Facade组成</li>
<li><code>\Illuminate\Foundation\Bootstrap\RegisterProviders::class</code>: 注册服务提供者，由<code>config/app.php</code>中定义的providers和从composer.json中解析出的providers组成</li>
<li><code>\Illuminate\Foundation\Bootstrap\BootProviders::class</code>: 启动服务提供者。</li>
</ul>
<h4 id="启动服务提供者"><a href="#启动服务提供者" class="headerlink" title="启动服务提供者"></a>启动服务提供者</h4><p>在启动服务提供者后，容器就算是完全准备就绪了：容器准备阶段的别名定义，提供了容器可对外服务的接口，而启动服务提供者的过程中，会实例化接口对应的对象，后续执行对象依赖接口时就可以从容器中解析出所需要的对象。</p>
<p>容器启动的重点，在于启动服务提供者，在该阶段完成了大量的基础重要工作。如：文件驱动服务、数据库连接服务、Session服务、Redis服务、视图服务、认证服务、路由服务等，详见<code>config/app.php</code>中的providers部分。其中，路由服务，会加载路由定义文件，生成路由表，供后续路由解析时做匹配查询。</p>
<p>在容器启动完毕后，进入第三阶段，请求处理阶段。</p>
<h3 id="第三阶段：请求处理阶段"><a href="#第三阶段：请求处理阶段" class="headerlink" title="第三阶段：请求处理阶段"></a>第三阶段：请求处理阶段</h3><h4 id="路由解析"><a href="#路由解析" class="headerlink" title="路由解析"></a>路由解析</h4><p>路由解析，就是根据当前请求，从路由表中匹配出定义好的路由，匹配会从四个方面进行<code>Uri/Method/Host/Scheme</code>。命中路由后进行下一阶段，否则抛出路由不存在的异常。</p>
<h4 id="全局中间件过滤"><a href="#全局中间件过滤" class="headerlink" title="全局中间件过滤"></a>全局中间件过滤</h4><p>命中路由后，请求经过全局中间的过滤，全局中间定义在Http处理器中，应用默认全局中间件列表如下:</p>
<ul>
<li><code>\Illuminate\Foundation\Http\Middleware\CheckForMaintenanceMode::class</code>: 检查应用状态</li>
<li><code>\Illuminate\Foundation\Http\Middleware\ValidatePostSize::class</code>： 检查请求数据大小</li>
<li><code>\App\Http\Middleware\TrimStrings::class</code>：过滤请求数据值中的首尾空字符</li>
<li><code>\Illuminate\Foundation\Http\Middleware\ConvertEmptyStringsToNull::class</code>：将空的值转化成null</li>
<li><code>\App\Http\Middleware\TrustProxies::class</code>：配置代理IP</li>
</ul>
<h4 id="控制器实例化"><a href="#控制器实例化" class="headerlink" title="控制器实例化"></a>控制器实例化</h4><p>请求通过全局中间之后，接着就要实例化控制器。因为下一步就要通过路由中间件，路由中间件可能随路由一同定义在路由文件中，也有可能定义在控制器的$middleware属性中。所以，为了收集到完整的路由中间列表，需要先实例化控制器对象，才能从中解析中间件属性。由于控制器的实例化，与路由中间件的过滤存在这样一个顺序关系，导致在控制器的构造函数中，无法获取到在路由中间件中处理的一些状态。比如登录状态，用户认证过程，依赖<code>\Illuminate\Session\Middleware\StartSession::class|\App\Http\Middleware\EncryptCookies::class</code>等路由中间件的执行结果，控制器构造函数执行时，路由中间件还未执行，因此无法获取用户的登陆状态。</p>
<p>因此，不推荐在控制器的构造函数中做太多的逻辑处理，避免因上述原因导致的错误。如果确实有些场景，需要在构造函数中做一些统一的操作，可以用CallAction方法来代替构造函数，见<code>Illuminate\Routing\ControllerDispatcher::dispatch()</code>方法。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Dispatch a request to a given controller and method.</span><br><span class="line"> *</span><br><span class="line"> * @param  \Illuminate\Routing\Route  $route</span><br><span class="line"> * @param  mixed  $controller</span><br><span class="line"> * @param  string  $method</span><br><span class="line"> * @return mixed</span><br><span class="line"> */</span><br><span class="line">public function dispatch(Route $route, $controller, $method)</span><br><span class="line">&#123;</span><br><span class="line">    $parameters = $this-&gt;resolveClassMethodDependencies(</span><br><span class="line">        $route-&gt;parametersWithoutNulls(), $controller, $method</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    if (method_exists($controller, &apos;callAction&apos;)) &#123;</span><br><span class="line">        return $controller-&gt;callAction($method, $parameters);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return $controller-&gt;&#123;$method&#125;(...array_values($parameters));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="路由中间件过滤"><a href="#路由中间件过滤" class="headerlink" title="路由中间件过滤"></a>路由中间件过滤</h4><p>一般路由中间件都会包含下列几个：</p>
<ul>
<li><code>\App\Http\Middleware\EncryptCookies::class</code>: cookie加密与解密，解密是前置部分，加密是后置部分</li>
<li><code>\Illuminate\Cookie\Middleware\AddQueuedCookiesToResponse::class</code>：添加程序中定义的cookie到响应中。</li>
<li><code>\Illuminate\Session\Middleware\StartSession::class</code>：启动session</li>
<li><code>\Illuminate\View\Middleware\ShareErrorsFromSession::class</code>：将验证错误信息系添加到session中，见文档表单验证部分</li>
<li><code>\App\Http\Middleware\VerifyCsrfToken::class</code>：csrf检查</li>
<li><code>\Illuminate\Routing\Middleware\SubstituteBindings::class</code>：路由模型绑定解析</li>
</ul>
<h4 id="运行路由方法并响应"><a href="#运行路由方法并响应" class="headerlink" title="运行路由方法并响应"></a>运行路由方法并响应</h4><p>进过上述处理之后，就终于到达了路由方法，也就是我们定义的路由中的控制器方法或闭包方法。执行完毕生成响应返回给浏览器。</p>
<p>需要注意的是，在执行完路由方法之后，还有可能存在后置中间件的方法待执行，比如cookie的加密，关于后置中间件的说明见文档中间件部分。</p>
<h3 id="第四阶段：terminate"><a href="#第四阶段：terminate" class="headerlink" title="第四阶段：terminate"></a>第四阶段：terminate</h3><p>terminate是指在响应发送到浏览器之后会执行的方法。terminate方法中非常适合做日志记录的工作，可以完美解决使用log-viewer插件时的log死循环问题。其次，还需要注意的是，在web环境下与Console环境下，terminate方法的区别。在web环境下，Http处理器先执行中间件中定义的terminate方法，然后执行容器$app的terminate方法，而在Console环境下，直接执行$app的terminate方法。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.slpi1.com/20190416/信息管理部PHP小组知识分享.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="slpi1">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="slpi1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/20190416/信息管理部PHP小组知识分享.html" itemprop="url">信息管理部PHP小组知识分享</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-16T18:18:00+08:00">
                2019-04-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Index"><a href="#Index" class="headerlink" title="Index"></a>Index</h1><ul>
<li><a href="#编码规范">编码规范</a><ul>
<li><a href="#php编码规范">php编码规范</a></li>
<li><a href="#编码习惯">编码习惯</a></li>
</ul>
</li>
<li><a href="#环境搭建">环境搭建</a><ul>
<li><a href="#本地集成环境">本地集成环境</a></li>
<li><a href="#虚拟机环境">虚拟机环境</a></li>
<li><a href="#docker环境">docker环境</a></li>
</ul>
</li>
<li><a href="#php框架">php框架</a><ul>
<li><a href="#laravel">laravel</a><ul>
<li><a href="#版本要求">版本要求</a></li>
<li><a href="#源码分析系列">源码分析系列</a></li>
<li><a href="#扩展包">扩展包</a></li>
</ul>
</li>
<li><a href="#YII">YII</a></li>
</ul>
</li>
<li><a href="#最佳实践">最佳实践</a></li>
</ul>
<h1 id="编码规范"><a href="#编码规范" class="headerlink" title="编码规范"></a>编码规范</h1><h2 id="php编码规范"><a href="#php编码规范" class="headerlink" title="php编码规范"></a>php编码规范</h2><p>目前主流的php编码规范是<a href="https://github.com/PizzaLiu/PHP-FIG" target="_blank" rel="noopener">PSR编码规范</a>。 个人意见是不需要严格去抠规范的细节，但是需要理解规范的意义：</p>
<blockquote>
<p>项目的目的在于：通过框架作者或者框架的代表之间讨论，以最低程度的限制，制定一个协作标准，各个框架遵循统一的编码规范，避免各家自行发展的风格阻碍了 PHP 的发展，解决这个程序设计师由来已久的困扰。</p>
</blockquote>
<p>对我们的意义在于：规范让我们能编写可维护性更高的代码。</p>
<p><a href="/standard.md">规范概览</a></p>
<p>通过给IDE编辑器安装相关插件，可以达到自动规范化代码的目的，具体教程方法可以在网上搜索一下。</p>
<ul>
<li><a href="https://packagecontrol.io/packages/phpfmt" target="_blank" rel="noopener">phpfpm</a></li>
<li><a href="https://www.eertime.com/archives/86.html" target="_blank" rel="noopener">sublime安装phpfpm及配置</a></li>
</ul>
<p>只不过，插件可以解决代码形式上的规范问题，能做的毕竟有限，何况在代码可维护性上还会遇到编码规范所不能解决的问题，我将这类问题归纳到编码习惯当中。</p>
<h2 id="编码习惯"><a href="#编码习惯" class="headerlink" title="编码习惯"></a>编码习惯</h2><p>编码习惯是经验的总结，是一个不断补充的列表，具体内容见下面的链接。如果你有比较好的经验总结，也可提出来供大家参考。</p>
<ul>
<li><a href="/custom/">编码习惯</a> 持续更新中…</li>
</ul>
<h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><h2 id="环境要求"><a href="#环境要求" class="headerlink" title="环境要求"></a>环境要求</h2><ul>
<li><code>php7.2</code></li>
</ul>
<p>工欲善其事，必先利其器。为了提升开发效率，达到良好的编码体验，需要配置好一套自己熟悉的开发环境。这里推荐三种开发环境的搭建方式，分别是本地集成环境、虚拟机环境、docker环境，并就本人的使用经验来阐述各自的优缺点。</p>
<h2 id="本地集成环境"><a href="#本地集成环境" class="headerlink" title="本地集成环境"></a>本地集成环境</h2><p>目前可以免费使用的本地集成环境有很多，本人只用过 <code>Wampserver</code>，可以根据自己的喜好自己做选择。 <strong>请注意尽量在官方网站下载集成环境软件，其他来源的软件可能携带病毒或者后门</strong>。</p>
<p><strong>优点</strong></p>
<ul>
<li>环境搭建难度低</li>
<li>系统资源占用低</li>
</ul>
<p><strong>缺点</strong></p>
<ul>
<li>windows版本的PHP不支持部分扩展</li>
<li><p>周边服务使用不便或者干脆没有，imagick、redis、nginx等</p>
<p>点评：<br>本地集成环境基本可以满足日常开发的需要，也是开发者本地必备的环境。但随着项目经验的累积，会遇到本地开发环境难以解决的问题。</p>
</li>
</ul>
<h2 id="虚拟机环境"><a href="#虚拟机环境" class="headerlink" title="虚拟机环境"></a>虚拟机环境</h2><p>先在本机上安装Vmware等虚拟机引擎，然后创建一个linux虚拟机，再在linux虚拟机上安装开发环境及周边服务。</p>
<p><strong>优点</strong></p>
<ul>
<li>熟悉linux系统的使用。</li>
<li>很大程度上模拟正式环境。如果遇到正式环境上的bug无法在本地环境重现，可以再虚拟机环境上试试。</li>
<li>周边服务安装简单。众所周知，很多软件在linux上安装就是一个命令的问题。</li>
<li>可以装多个虚拟环境。</li>
</ul>
<p><strong>缺点</strong></p>
<ul>
<li>环境搭建麻烦</li>
<li>系统资源占用升高</li>
<li>需要通过ssh工具来对环境进行管理</li>
<li>不熟悉linux怎么使用？？ 流下的技术不足的泪水…</li>
</ul>
<p>点评：<br>推荐使用。就我的使用经验来看，虚拟机更多的是对本地集成环境的补充，一般不会在开发的时候，将代码部署到虚拟机来运行，而是通过虚拟机来提供redis/es/nginx代理等服务。</p>
<h2 id="docker环境"><a href="#docker环境" class="headerlink" title="docker环境"></a>docker环境</h2><p>通过docker来搭建开发环境也是一种方式。首先需要安装好docker引擎，然后需要进行镜像制作、镜像编排来完成开发环境的搭建。</p>
<p><strong>优点</strong></p>
<ul>
<li>比较贴合当前技术趋势</li>
<li>拥有虚拟机环境的所有优点</li>
<li>无需ssh工具就能体验linux的功能</li>
</ul>
<p><strong>缺点</strong></p>
<ul>
<li>系统资源占用很高，可能比虚拟机环境的资源占用还高。</li>
<li>前期工作量大且复杂</li>
<li>需要学习docker相关知识。但是只需要会docker、docker-compose两个命令的使用就可以搭建</li>
</ul>
<p>点评：<br>入坑吧，少年！<a href="/environment/docker/">教程</a></p>
<h1 id="php框架"><a href="#php框架" class="headerlink" title="php框架"></a>php框架</h1><p>我部门目前php的技术栈主要是laravel和YII，除部分遗留的系统外，新系统均使用laravel进行开发。</p>
<h2 id="laravel"><a href="#laravel" class="headerlink" title="laravel"></a>laravel</h2><h3 id="版本要求"><a href="#版本要求" class="headerlink" title="版本要求"></a>版本要求</h3><ul>
<li><code>laravel 5.5</code></li>
</ul>
<h3 id="源码分析系列"><a href="#源码分析系列" class="headerlink" title="源码分析系列"></a>源码分析系列</h3><ul>
<li><a href="/laravel/progress-doc.md">laravel应用执行流程</a></li>
<li><a href="/laravel/eloquent-article.md">laravel ORM源码分析</a></li>
<li><a href="/laravel/queue.md">laravel 队列部分源码阅读</a></li>
<li><a href="/laravel/route.md">laravel 路由模块源码分析</a></li>
<li><a href="/laravel/__call.md">laravel 框架对__call魔术方法的使用</a></li>
<li><a href="/laravel/auth.md">laravel Auth源码分析</a></li>
<li><a href="/laravel/pipeline.md">laravel Pipeline源码分析</a></li>
<li><a href="/laravel/email-filter.md">邮件发送过滤</a></li>
<li><a href="/laravel/middleware.md">laravel 中间件</a></li>
<li><a href="/laravel/filesystem.md">laravel 文件系统</a></li>
</ul>
<h3 id="扩展包"><a href="#扩展包" class="headerlink" title="扩展包"></a>扩展包</h3><ul>
<li><a href="https://gitlab.uuzu.com/songzhp/log" target="_blank" rel="noopener">log</a>: laravel 日志记录扩展包</li>
<li><a href="https://gitlab.uuzu.com/songzhp/im-sdk" target="_blank" rel="noopener">im-sdk</a>: 公司内部IM软件接口扩展包</li>
<li><a href="https://gitlab.uuzu.com/songzhp/emp-sdk" target="_blank" rel="noopener">emp-sdk</a>: 公司人员中枢接口扩展包</li>
</ul>
<h2 id="YII"><a href="#YII" class="headerlink" title="YII"></a>YII</h2><h1 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h1><ul>
<li><a href="/discuss/what_the_fu..function.md">PHP坑爹函数系列</a></li>
<li><a href="/discuss/error.md">错误与异常的处理</a></li>
<li><a href="/discuss/package.md">如何进行代码结构的规划</a></li>
<li><a href="/discuss/excel-merge-cell.md">Excel单元格自动合并的实现方案</a></li>
<li><a href="/discuss/office-to-pdf.md">word操作与pdf转码</a></li>
</ul>
<h1 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h1><ul>
<li><del>PHP坑爹函数系列</del></li>
<li>可配置化</li>
<li><del>错误与异常的处理</del></li>
<li>接口返回定义</li>
<li>对象属性修改的注意事项</li>
<li>input的作用域</li>
<li><del>如何进行代码结构的规划</del></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.slpi1.com/20180925/discuss/excel-merge-cell.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="slpi1">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="slpi1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/20180925/discuss/excel-merge-cell.html" itemprop="url">Excel单元格自动合并的实现方案</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-25T10:16:00+08:00">
                2018-09-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Index"><a href="#Index" class="headerlink" title="Index"></a>Index</h1><ul>
<li><a href="#背景">背景</a></li>
<li><a href="#思路">思路</a><ul>
<li><a href="#找出合并的隐含条件">找出合并的隐含条件</a></li>
<li><a href="#可合并区域的寻找">可合并区域的寻找</a></li>
<li><a href="#可合并区域的影响">可合并区域的影响</a></li>
<li><a href="#结束条件">结束条件</a></li>
<li><a href="#其他问题">其他问题</a><ul>
<li><a href="#三角形问题">三角形问题</a></li>
<li><a href="#起始点的合并顺序">起始点的合并顺序</a></li>
<li><a href="#我们如何引入自定义条件">我们如何引入自定义条件</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#点睛之笔-自定义条件">点睛之笔-自定义条件</a><ul>
<li><a href="#停止行与停止列">停止行与停止列</a></li>
<li><a href="#继承">继承</a></li>
<li><a href="#合并优先序">合并优先序</a></li>
</ul>
</li>
<li><a href="#实现">实现</a><ul>
<li><a href="#基本对象">基本对象</a><ul>
<li><a href="#单元格对象">单元格对象</a></li>
<li><a href="#区域对象">区域对象</a></li>
<li><a href="#数据源对象">数据源对象</a></li>
<li><a href="#搜索执行对象">搜索执行对象</a></li>
<li><a href="#停止规则对象">停止规则对象</a></li>
</ul>
</li>
<li><a href="#执行过程">执行过程</a><ul>
<li><a href="#合并的初始化与进行">合并的初始化与进行</a></li>
<li><a href="#停止行规则">停止行规则</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>以前在开发有格数据驾驶舱的时候，由于需要展示比较多的表格，而且表格有合并的情况，每个表格的合并规则还不一致。当时需要同时支持导出 <code>Excel</code> 文件的合并，以及返回到接口的数据，供前端展示时合并，这两种情况。通过分析之后，计划通过两种方案来实现：</p>
<ul>
<li><code>Excel</code> 模板。模板包含要合并的情况，导出时仅填充数据。</li>
<li>动态合并规则。按要求，自动对数据项进行合并。</li>
</ul>
<p>通过模板的方式来解决这个问题，需要面以下下困难：</p>
<ul>
<li>如果合并的情况比较复杂，比如前十行与后十行的合并情况不一致，更进一步，如果这个“十”是变化的，那么模板就无能为力了。</li>
<li>返回给前端接口的表格数据，无法共模板这一方案，需要单独想办法解决</li>
</ul>
<p>由于上述两个原因，决定采用方案二，动态合并规则来实现。总的概括一下我们要解决的问题：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">任意给定一组二维数据，根据自定义的一些规则，来对这组数据进行合并，并列出所有合并区域的起点与终点。</span><br></pre></td></tr></table></figure>
<h1 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h1><p>如何找出需要合并的区域呢？先假设一个无规则的情况；如果有一个表格，你可以自由的对表格数据进行合并，要如何实现？</p>
<h2 id="找出合并的隐含条件"><a href="#找出合并的隐含条件" class="headerlink" title="找出合并的隐含条件"></a>找出合并的隐含条件</h2><p>在无规则情况下，其实默认单元格满足下列两个条件，就可以进行合并：</p>
<ul>
<li>两个单元格的值相等</li>
<li>两个单元格的位置相邻</li>
</ul>
<h2 id="可合并区域的寻找"><a href="#可合并区域的寻找" class="headerlink" title="可合并区域的寻找"></a>可合并区域的寻找</h2><p>那么，合并区域的寻找，可以通过以下过程来展开：</p>
<ul>
<li>确定起点：确定数据的起点，假设为 <code>O(0,0)</code>，标记点 <code>O</code> 为合并的起点</li>
<li>横向检查：检查 <code>O</code> 右侧的点 <code>N(0,1)</code>，如果点 <code>O</code> 与点 <code>N</code> 的值相等，那么表示可以合并，继续检查 <code>N</code> 右侧的点 <code>N1</code>，直到 <code>Nx</code> 的值不等于 <code>O</code> 的值，至此，横向检查完毕</li>
<li>纵向检查：检查 <code>O</code> 下方的点 <code>H(1,0)</code>, 如果点 <code>O</code> 与点 <code>H</code> 的值相等，那么从 <code>H</code> 点开始，启动第二轮横向检查。如果不想等，那么合并结束，合并区域为 <code>O~Nx-1</code> 。 <code>Nx-1</code> 表示最后一轮横向检查的终点。</li>
</ul>
<p>这个过程是一次合并区域检查的过程，每执行一个这样的过程，就会得到一个合并区域，记作 <code>Range[O,Nx-1]</code>，如果点 <code>O</code> 与点 <code>Nx-1</code> 相等，说明该合并区域就是一个点，可以舍弃掉。</p>
<h2 id="可合并区域的影响"><a href="#可合并区域的影响" class="headerlink" title="可合并区域的影响"></a>可合并区域的影响</h2><p>每寻找到一个合并区域 <code>Range[O,Nx-1]</code> ,我们就消除了一个起点，同时，得到了两个新的起点。由于合并区域是一个矩形，矩形有四个点，其中一个是我们选择的起始点，还剩下三个点，由于对角线上的点比较特殊，我们先抛开不谈，还剩下起始点相邻的两个点，这两个点，就是下一次合并的起始点。<br>假设合并区域的终点为 <code>Nx-1(m,n)</code>，那么，由点 <code>O</code> 分裂出两个新的起始点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O(0,0) -&gt; O1(0,n), O2(m,0)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>由于合并起始点需要进行一个单位的偏移，对角点会偏移成三个点。但这三个点都有可能被相邻两个点的区域所包含，也有可能不会包含。将对角点考虑进来讨论的话，会大大的增加问题的复杂性，但并不会对结果有积极的意义，弊大于利，所以讨论与编码时，都将这个点忽略</p>
</blockquote>
<p>接下来，我们继续以 <code>O1/O2</code> 为起始点，分别进行可合并区域的寻找，就能又找到两个可合并区域，以及，分裂成四个新的起始点。</p>
<h2 id="结束条件"><a href="#结束条件" class="headerlink" title="结束条件"></a>结束条件</h2><p>根据上述分析，我们会发现，随着可合并区域不断被找出，起始点不断被分裂成更多的起始点。那么这个循环会一直持续下去吗？并不是，当分裂到数据的边界的时候，一个起始点就只会分裂成一个起始点，这时，起始点的规模就会开始收缩。那么，“数据的边界”，包含哪些情况呢？</p>
<ul>
<li>数据的范围达到给定范围的极限，就是，数据右边或下边没有更多数据了。</li>
<li>数据的范围，触及到某个已找到的可合并区域的边界。显然，由此分裂出的开始点，已经被“寻找过”，并不会产生新的可合并区域。</li>
</ul>
<p>当所有的起始点，都触碰到数据的边界的时候，查找，就结束了，已找到的可合并区域，就是给定数据中，所有的可合并区域。</p>
<h2 id="其他问题"><a href="#其他问题" class="headerlink" title="其他问题"></a>其他问题</h2><p>我们按照上述思路，已经归纳出了方案的基本雏形，只不过在实际使用中，可能并不会达到我们想要的结果，因为这当中忽略了几个比较重要的问题。</p>
<h3 id="三角形问题"><a href="#三角形问题" class="headerlink" title="三角形问题"></a>三角形问题</h3><p>如果数据中有一个三角形区域 <code>O(0,0) -&gt; A(0,10) -&gt; B(10, 0)</code> 其中所有的单元格的值都相等，按照上述思路，最终寻找的可合并区域是 <code>Range[O(0,0), B(10,0)]</code>，因为我们在可合并区域的寻找过程中，遵循的是“横向合并优先”，如果我们遵循“纵向合并优先”的话，最终需要的可合并区域是 <code>Range[O(0,0), A(0, 10)]</code>，然而实际当中，也许这两种情况，都不是我们希望的结果，比如，若我希望合并区域有最大的面积，那么，最终的可合并区域应该是 <code>Range[O(0,0), M(5,5)]</code>。究竟应该如何取舍，实际上取决于“我们的要求”。</p>
<h3 id="起始点的合并顺序"><a href="#起始点的合并顺序" class="headerlink" title="起始点的合并顺序"></a>起始点的合并顺序</h3><p>由于起始点是会逐渐分裂增加的，那么，依据什么来决定，哪个起始点优先进入合并队列呢？考虑一种极端情况，第一个可合并区域将整个数据分成了两个部分：可合并区域的数据都是1，剩下部分的数据，都是2。如果称可合并区域为第二象限，那么以右侧的点开始，得到的合并区域是第一象限与第四象限的组合；如果以下侧的点，开始，得到的合并区域是第三象限与第四象限的组合。所以，起始点的选取顺序，也会导致合并区域结果的差异。</p>
<h3 id="我们如何引入自定义条件"><a href="#我们如何引入自定义条件" class="headerlink" title="我们如何引入自定义条件"></a>我们如何引入自定义条件</h3><p>到此为止，我们上述的讨论，都不涉及到自定义条件的问题，而这本身就是需求之一。</p>
<h1 id="点睛之笔-自定义条件"><a href="#点睛之笔-自定义条件" class="headerlink" title="点睛之笔-自定义条件"></a>点睛之笔-自定义条件</h1><p>如果讨论至于上述的思路，那么这一方案实际上并无太大用处，因为由于最后三个问题的存在，导致最终合并的结果，很有可能并不是我们想要的。其中，第三个问题，它既是一个问题，又是一个需求，那么，考虑在解决该问题的同时，附带解决其余两个问题。我们将上文的思路，归纳成两个过程：</p>
<ul>
<li>寻找合并区域</li>
<li>循环起始点</li>
</ul>
<p>从顺序上看，<code>寻找合并区域</code> 先于 <code>循环起始点</code> ，从因果关系上看，<code>寻找合并区域</code> 会导致 <code>循环起始点</code> 的主体 <code>起始点</code> 起始点的变化。所以我们先考虑从 <code>寻找合并区域</code> 这一过程中，引入自定义条件。 <code>寻找合并区域</code> 分为两个主要过程，<code>横向检查</code> 与 <code>纵向检查</code>，我们引入的条件，应该是能影响这两个过程的结束位置。</p>
<p>对于上述 <code>三角形问题</code> ,如果我们要求可合并区域的面积最大，可以转化为这样的一组条件：</p>
<ul>
<li>横向合并到 <code>5</code> 为止</li>
<li>纵向合并到 <code>5</code> 为止</li>
</ul>
<p>这里的两个条件，就是我们的自定义条件，我们把这类条件，归纳为 <code>停止行/停止列</code></p>
<h2 id="停止行与停止列"><a href="#停止行与停止列" class="headerlink" title="停止行与停止列"></a>停止行与停止列</h2><p>停止行与停止列，是自定义条件的核心。他规定合并区域的寻找，在遇到哪些行与列的时候，就停止。因此，我们只需要在寻找合并区域的逻辑当中，引入对停止行与停止列的检查即可。需要留意的是，停止行与停止列的位置可能是变化的，我们在编码时可能需要考虑到这一点。</p>
<h2 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h2><p>停止行与停止列可能需要被继承，他所代表的含义是：表格前面部分的停止规则，极有可能对后面的数据生效，但是根据后面的数据以及规则，可能无法计算出合适的停止规则，这时，直接将前面的停止规则继承过来即可。</p>
<h2 id="合并优先序"><a href="#合并优先序" class="headerlink" title="合并优先序"></a>合并优先序</h2><p>我们在讨论 <code>三角形问题</code> 时，提到过 <code>横向合并优先/纵向合并优先</code> 的概念，这是指在寻找合并区域时遇到的顺序问题。在循环起始点时，也存在这么一个问题：即应该以左侧的点开始新一轮的合并区域寻找，还是应该以下侧的点，开始新一轮的合并区域寻找。这是两个合并优先序的问题。</p>
<p>先来看一看起始点的分裂情况，假设有以下分裂过程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">O(0,0) -&gt; [N(2, 0),H(0,2)]</span><br><span class="line"></span><br><span class="line">N(2, 0) -&gt; [N1(5, 0), H1(2,3)]; H(0, 2) -&gt; [N2(1, 2), H2(0, 4)]</span><br></pre></td></tr></table></figure>
<p>起始点出现的顺序是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">N - H - N1 - H1 - N2 - H2</span><br></pre></td></tr></table></figure>
<p>分布大概如下表所示</p>
<table>
<thead>
<tr>
<th>0 O(0,0)</th>
<th>1</th>
<th>2 N(2, 0)</th>
<th>3</th>
<th>4</th>
<th>5 N1(5,0)</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>—</td>
<td>—</td>
<td>—</td>
<td>—</td>
<td>—</td>
</tr>
<tr>
<td>2 H(0,2)</td>
<td>N2(1,2)</td>
<td>—</td>
<td>—</td>
<td>—</td>
<td>—</td>
</tr>
<tr>
<td>3</td>
<td>—</td>
<td>H1(2,3)</td>
<td>—</td>
<td>—</td>
<td>—</td>
</tr>
<tr>
<td>4 H2(0,4)</td>
<td>—</td>
<td>—</td>
<td>—</td>
<td>—</td>
<td>—</td>
</tr>
<tr>
<td>5</td>
<td>—</td>
<td>—</td>
<td>—</td>
<td>—</td>
<td>—</td>
</tr>
</tbody>
</table>
<p>如果以开始点出现的顺序进行合并，通过相对位置可知，点 <code>H1</code> 可能会被包含在 <code>N2</code> 开始的可合并区域中。但是按点的顺序来看，<code>H1</code> 的合并先发生，由于已合并区域会形成边界，这时 <code>N2</code> 进行合并的话，不可能再次包含点 <code>H1</code>。</p>
<p>通过以上示例可以看出，起始点的合并开始顺序，确实会影响最终的合并结果。因此，在每次合并完成后，都需要对已存在的点和新生成的两个点，进行一次排序，用以决定究竟哪个点该进入下一次的合并。</p>
<p>每个点都有一个横坐标与纵坐标，很容易想到的方法是，仅比较每个点的横坐标，越小的点，越先开始合并；或者仅比较每个点的纵坐标，越小的点，越先开始合并。但如果有两个点的某个坐标相同，又恰巧以该坐标决定合并顺序呢，很容易想到，比较应该同时结合横坐标与纵坐标，但以某一项为主；就像如果以横坐标为主，那么横坐标的值充当十位，纵坐标的值充当个位，用以区分其权重。</p>
<p>显然，如果横坐标的排序权重高，我们称为“横向合并优先”，那么每次分裂之后，横向的点都会进入下一个合并队列，纵向的点，进入等待队列，直到横向的数据达到数据范围的极限，此时，等待队列中的开始点，类似下列情况：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Nn - H1 - H2 - H3 - - - Hn</span><br></pre></td></tr></table></figure>
<p>横向数据范围越大，<code>Hn</code> 中 <code>n</code> 的值越大，等待合并的点越多。如果纵坐标的排序权重高，我们称为“横向合并优先”，情况依然类似。</p>
<p>其实，只要合并不是无序的，无论是横向优先，还是纵向优先，对合并结果的影响并不是很大，尤其是在停止行规则充分时，基本可以达到相同的合并结果。不过因为横向与纵向数据范围的差异，可能导致待合并队列中点的个数差异，进一步影响点排序的效率，因此，此处可以有一个优化，来使排序的效率增加，就是以数据范围小的坐标作为合并优先序。</p>
<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><p>基于上述思想。我们简单理一下，该如何编码来实现本功能。</p>
<h2 id="基本对象"><a href="#基本对象" class="headerlink" title="基本对象"></a>基本对象</h2><h3 id="单元格对象"><a href="#单元格对象" class="headerlink" title="单元格对象"></a>单元格对象</h3><p>该对象用来表示点，他需要有一个横坐标属性，纵坐标属性，还需要能计算出左侧的点，右侧的点，以及两个点是否是同一个点。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cell</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $x;</span><br><span class="line">    <span class="keyword">protected</span> $y;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($x = <span class="number">0</span>, $y = <span class="number">0</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;x = $x;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;y = $y;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getX</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getY</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;y;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">nextHorizonCell</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Cell(<span class="keyword">$this</span>-&gt;x + <span class="number">1</span>, <span class="keyword">$this</span>-&gt;y);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">nextVerticalCell</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Cell(<span class="keyword">$this</span>-&gt;x, <span class="keyword">$this</span>-&gt;y + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">equal</span><span class="params">(Cell $cell)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;x == $cell-&gt;getX() &amp;&amp; <span class="keyword">$this</span>-&gt;y == $cell-&gt;getY();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个实现并没有任何对点的值的表示，为何要这样处理，我们放在后面来说。</p>
<h3 id="区域对象"><a href="#区域对象" class="headerlink" title="区域对象"></a>区域对象</h3><p>区域表示的是一个范围，他有一个开始的点，与结束的点。同时他还需要有获取分裂后的点的能力，需要有判断点是否落在区域中的能力。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Cell</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Range</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $start;</span><br><span class="line">    <span class="keyword">public</span> $end;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $active;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $maxX = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Cell $start, Cell $end)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;start = $start;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;end   = <span class="keyword">$this</span>-&gt;active   = $end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">haveCell</span><span class="params">(Cell $cell)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $cellX = $cell-&gt;getX();</span><br><span class="line">        $cellY = $cell-&gt;getY();</span><br><span class="line"></span><br><span class="line">        $startX = <span class="keyword">$this</span>-&gt;start-&gt;getX();</span><br><span class="line">        $startY = <span class="keyword">$this</span>-&gt;start-&gt;getY();</span><br><span class="line"></span><br><span class="line">        $endX = <span class="keyword">$this</span>-&gt;end-&gt;getX();</span><br><span class="line">        $endY = <span class="keyword">$this</span>-&gt;end-&gt;getY();</span><br><span class="line">        <span class="keyword">if</span> ($cellX &gt;= $startX &amp;&amp; $cellX &lt;= $endX &amp;&amp; $cellY &gt;= $startY &amp;&amp; $cellY &lt;= $endY) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isCell</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;start-&gt;getX() == <span class="keyword">$this</span>-&gt;end-&gt;getX() &amp;&amp; <span class="keyword">$this</span>-&gt;start-&gt;getY() == <span class="keyword">$this</span>-&gt;end-&gt;getY()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">horizonTouchAllow</span><span class="params">(Cell $cell)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;maxX != <span class="number">0</span> &amp;&amp; $cell-&gt;getX() &gt; <span class="keyword">$this</span>-&gt;maxX) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">markMaxHorizonTouch</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;maxX = <span class="keyword">$this</span>-&gt;maxX == <span class="number">0</span> ? <span class="keyword">$this</span>-&gt;active-&gt;getX() : min(<span class="keyword">$this</span>-&gt;maxX, <span class="keyword">$this</span>-&gt;active-&gt;getX());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getValue</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            [<span class="keyword">$this</span>-&gt;start-&gt;getX(), <span class="keyword">$this</span>-&gt;start-&gt;getY()],</span><br><span class="line">            [<span class="keyword">$this</span>-&gt;end-&gt;getX(), <span class="keyword">$this</span>-&gt;end-&gt;getY()],</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">nextRowFirst</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $x = <span class="keyword">$this</span>-&gt;start-&gt;getX();</span><br><span class="line">        $y = <span class="keyword">$this</span>-&gt;end-&gt;getY() + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Cell($x, $y);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">nextColumnFirst</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $x = <span class="keyword">$this</span>-&gt;end-&gt;getX() + <span class="number">1</span>;</span><br><span class="line">        $y = <span class="keyword">$this</span>-&gt;start-&gt;getY();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Cell($x, $y);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">nextMergeStartCells</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $nextRowFirst    = <span class="keyword">$this</span>-&gt;nextRowFirst();</span><br><span class="line">        $nextColumnFirst = <span class="keyword">$this</span>-&gt;nextColumnFirst();</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            $nextColumnFirst,</span><br><span class="line">            $nextRowFirst,</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="数据源对象"><a href="#数据源对象" class="headerlink" title="数据源对象"></a>数据源对象</h3><p>数据源对象，就是给定的初始二维数据。只不过我们在编码时，不应该把它具体化，只需要知道，这个对象需要提供哪些功能。因此，数据源对象是什么。我们并不关心，但他需要实现这个接口：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">Cell</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">RepositoryInterface</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// 获取点的值</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getValue</span><span class="params">(Cell $cell)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取数据横向范围</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getWidth</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取数据纵向范围</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getHeight</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里来解释一下，为何单元格对象并不能获取自身的值？因为源数据有可能需要一个很大的存储空间，如果单元格能获取到值，必然需要在某处引用这一数据源，此时，<code>Cell</code> 类会对外部产生一个依赖，并且需要在实例化时主动传入该数据对象。而在执行过程中，会出现大量的点对象，由此可能导致内存占用增加，所以，将单元格的取值过程转嫁给数据源对象。</p>
<h3 id="搜索执行对象"><a href="#搜索执行对象" class="headerlink" title="搜索执行对象"></a>搜索执行对象</h3><p>对给定数据源执行搜索，其中包含代码主要的逻辑部分。</p>
<h3 id="停止规则对象"><a href="#停止规则对象" class="headerlink" title="停止规则对象"></a>停止规则对象</h3><p>停止规则对象依赖给定数据源，用以计算出动态的停止规则。</p>
<h2 id="执行过程"><a href="#执行过程" class="headerlink" title="执行过程"></a>执行过程</h2><h3 id="合并的初始化与进行"><a href="#合并的初始化与进行" class="headerlink" title="合并的初始化与进行"></a>合并的初始化与进行</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">start</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 将点 O(0,0) 放入横向合并队列</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;horizonMergeQueue[] = <span class="keyword">new</span> Cell;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开始检查合并</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;catchMergeRange();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回合并区域列表</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;mergedRanges;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">catchMergeRange</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 判断下一个要合并的起始点</span></span><br><span class="line">    $startCell = <span class="keyword">$this</span>-&gt;getNextMergeStart();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果不存在，表示合并结束</span></span><br><span class="line">    <span class="keyword">if</span> ($startCell) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果点不存在于已合并的区域中</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;merged($startCell)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 初始化待合并区域</span></span><br><span class="line">            $range = <span class="keyword">new</span> Range($startCell, $startCell);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 可合并区域的寻找 - 区域终点搜索</span></span><br><span class="line">            $range = <span class="keyword">$this</span>-&gt;touchRange($range);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 判断区域是否是一个点，如果不是，则加入已合并区域列表</span></span><br><span class="line">            <span class="keyword">if</span> (!$range-&gt;isCell()) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;mergedRanges[<span class="keyword">$this</span>-&gt;getRangeId($range)] = $range;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 起始点分裂</span></span><br><span class="line">            <span class="keyword">list</span>($cellHorizon, $cellVertical) = $range-&gt;nextMergeStartCells();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将点$cellHorizon 加入横向合并队列</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isExistsCell($cellHorizon)) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;horizonMergeQueue[<span class="keyword">$this</span>-&gt;getCellHorizonIndex($cellHorizon)] = $cellHorizon;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;makeExtendStopRule($cellHorizon);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将点$cellVertical 加入纵向合并队列</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isExistsCell($cellVertical)) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;verticalMergeQueue[<span class="keyword">$this</span>-&gt;getCellVerticalIndex($cellVertical)] = $cellVertical;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;makeExtendStopRule($cellVertical);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 启动下一个起始点的合并</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;catchMergeRange();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">touchRange</span><span class="params">(Range $range)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 区域内 - 横向检查</span></span><br><span class="line">    $range = <span class="keyword">$this</span>-&gt;touchCellHorizon($range);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 区域内 - 纵向检查</span></span><br><span class="line">    $range = <span class="keyword">$this</span>-&gt;touchCellVertical($range);</span><br><span class="line">    <span class="keyword">return</span> $range;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 纵向检查</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">touchCellHorizon</span><span class="params">(Range $range)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $nextHorizonCell = $range-&gt;active-&gt;nextHorizonCell();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 达到纵向数据范围的极限，检查停止</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;isExistsCell($nextHorizonCell)) &#123;</span><br><span class="line">        $range-&gt;end = $range-&gt;active;</span><br><span class="line">        <span class="keyword">return</span> $range;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 纵向检查通过，启动横向检查，在这里检查停止行规则</span></span><br><span class="line">    <span class="keyword">if</span> ($range-&gt;horizonTouchAllow($nextHorizonCell) &amp;&amp;</span><br><span class="line">        !<span class="keyword">$this</span>-&gt;atStopColumn($nextHorizonCell) &amp;&amp;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;getValue($range-&gt;active) === <span class="keyword">$this</span>-&gt;getValue($nextHorizonCell)) &#123;</span><br><span class="line">        $range-&gt;active = $nextHorizonCell;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;touchCellHorizon($range);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 否则检查停止</span></span><br><span class="line">        $range-&gt;end = $range-&gt;active;</span><br><span class="line"></span><br><span class="line">        $range-&gt;markMaxHorizonTouch();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $range;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 横向检查</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">touchCellVertical</span><span class="params">(Range $range)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $nextRowFirst = $range-&gt;nextRowFirst();</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;isExistsCell($nextRowFirst)) &#123;</span><br><span class="line">        <span class="keyword">return</span> $range;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 横向检查通过，继续下一轮检查，在这里检查停止行规则</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;atStopRow($nextRowFirst) &amp;&amp; <span class="keyword">$this</span>-&gt;getValue($range-&gt;start) === <span class="keyword">$this</span>-&gt;getValue($nextRowFirst)) &#123;</span><br><span class="line">        $range-&gt;active = $nextRowFirst;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;touchRange($range);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $range;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取下一个起始点</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getNextMergeStart</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;horizonMergeQueue) &amp;&amp; <span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;verticalMergeQueue)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">$this</span>-&gt;mergeDirect == <span class="keyword">self</span>::HORIZON_DIRECT &amp;&amp; !<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;horizonMergeQueue)) || <span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;verticalMergeQueue)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getNextMergeStartOfQueue(<span class="keyword">$this</span>-&gt;horizonMergeQueue);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getNextMergeStartOfQueue(<span class="keyword">$this</span>-&gt;verticalMergeQueue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 去除起始点时，先进行一次排序</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getNextMergeStartOfQueue</span><span class="params">(&amp;$queue)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    krsort($queue);</span><br><span class="line">    <span class="keyword">return</span> array_pop($queue);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 是否是停止列</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">atStopColumn</span><span class="params">(Cell $cell)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;stopRule-&gt;atStopColumn($cell);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 是否是停止行</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">atStopRow</span><span class="params">(Cell $cell)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;stopRule-&gt;atStopRow($cell);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里只列出了主要的检查逻辑。</p>
<h3 id="停止行规则"><a href="#停止行规则" class="headerlink" title="停止行规则"></a>停止行规则</h3><p>停止规则对象</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StopRule</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">ExcelBaseOperate</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> $exporter;</span><br><span class="line">    <span class="keyword">protected</span> $stopColumn = [];</span><br><span class="line">    <span class="keyword">protected</span> $stopRow    = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $extendStopRows = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $extendStopColumns = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($exporter)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;exporter = $exporter;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($exporter-&gt;extendStopRows) &amp;&amp; $exporter-&gt;extendStopRows) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;extendStopRows = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($exporter-&gt;extendStopColumns) &amp;&amp; $exporter-&gt;extendStopColumns) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;extendStopColumns = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 传入一个点对象，用来检查是否处于停止行</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">atStopColumn</span><span class="params">(Cell $cell)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 如果数据源对象实现了规则，则获取数据源的规则，并解析停止结果</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;exporter <span class="keyword">instanceof</span> WithStopRule) &#123;</span><br><span class="line">            $rule       = <span class="keyword">$this</span>-&gt;exporter-&gt;stopColumns();</span><br><span class="line">            $shouldStop = <span class="keyword">$this</span>-&gt;parserStopColumnRule($rule, $cell);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ($shouldStop) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (in_array($cell-&gt;getX(), <span class="keyword">$this</span>-&gt;stopColumn)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 传入一个点对象，用来检查是否处于停止列</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">atStopRow</span><span class="params">(Cell $cell)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 如果数据源对象实现了规则，则获取数据源的规则，并解析停止结果</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;exporter <span class="keyword">instanceof</span> WithStopRule) &#123;</span><br><span class="line">            $rule       = <span class="keyword">$this</span>-&gt;exporter-&gt;stopRows();</span><br><span class="line">            $shouldStop = <span class="keyword">$this</span>-&gt;parserStopRowRule($rule, $cell);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ($shouldStop) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (in_array($cell-&gt;getY(), <span class="keyword">$this</span>-&gt;stopRow)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addStopColumn</span><span class="params">($index)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;stopColumn[$index] = $index;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addStopRow</span><span class="params">($index)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;stopRow[$index] = $index;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 按数据源规则解析停止结果</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">parserStopColumnRule</span><span class="params">($rule, Cell $cell)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 规则为布尔值，表示始终停止或不停止</span></span><br><span class="line">        <span class="keyword">if</span> (is_bool($rule)) &#123;</span><br><span class="line">            <span class="keyword">return</span> $rule;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 规则为数组，表示指定的停止行号或ID</span></span><br><span class="line">        <span class="keyword">if</span> (is_array($rule)) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> ($rule <span class="keyword">as</span> $item) &#123;</span><br><span class="line">                <span class="keyword">if</span> (is_numeric($item) &amp;&amp; $cell-&gt;getX() == $item) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isColumnName($item) &amp;&amp; <span class="keyword">$this</span>-&gt;columnNameToIndex($item) == $cell-&gt;getX()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 规则为一个可执行结构，由数据源自身计算是否需要停止</span></span><br><span class="line">        <span class="keyword">if</span> (is_callable($rule)) &#123;</span><br><span class="line">            <span class="keyword">return</span> call_user_func_array($rule, [$cell-&gt;getX(), $cell-&gt;getY()]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">parserStopRowRule</span><span class="params">($rule, Cell $cell)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_bool($rule)) &#123;</span><br><span class="line">            <span class="keyword">return</span> $rule;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_array($rule)) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> ($rule <span class="keyword">as</span> $item) &#123;</span><br><span class="line">                <span class="keyword">if</span> (is_numeric($item) &amp;&amp; $cell-&gt;getY() == $item) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_callable($rule)) &#123;</span><br><span class="line">            <span class="keyword">return</span> call_user_func_array($rule, [$cell-&gt;getY(), $cell-&gt;getX()]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在进行停止行的判定时，有这样的一部分代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;exporter <span class="keyword">instanceof</span> WithStopRule) &#123;</span><br><span class="line">    $rule       = <span class="keyword">$this</span>-&gt;exporter-&gt;stopRows();</span><br><span class="line">    $shouldStop = <span class="keyword">$this</span>-&gt;parserStopRowRule($rule, $cell);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($shouldStop) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中 <code>exporter</code> 就是一开始给定的原始数据对象，如果该对象实现了 <code>WithStopRule</code> 接口的话，表名该对象定义了自己的停止规则，通过 <code>stopRows/stopColumns</code> 方法获取到原始数据定义的停止规则 <code>$rule</code>，然后将 <code>$rule</code>和当前的点 <code>$cell</code> 传给 <code>parserStopRowRule</code> 方法，计算出在当前点 <code>$cell</code> 是否需要停止。</p>
<p>最终代码结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/</span><br><span class="line">|----/Concerns/</span><br><span class="line">|--------/ExtendStopColumns.php·············停止列继承</span><br><span class="line">|--------/ExtendStopRows.php················停止行继承</span><br><span class="line">|--------/RepositoryInterface.php···········源数据对象接口</span><br><span class="line">|--------/WithStopRule.php··················停止规则定义接口</span><br><span class="line">|----/Merge/</span><br><span class="line">|--------/Discover.php······················搜索过程定义</span><br><span class="line">|--------/StopRule.php······················停止规则解析</span><br><span class="line">|----/Repositories/</span><br><span class="line">|--------/ArrayRepository.php···············二维数组源数据包装对象</span><br><span class="line">|--------/WorksheetRepository.php···········Excel工作表源数据包装对象</span><br><span class="line">|----/Table/</span><br><span class="line">|--------/Cell.php··························基础点对象</span><br><span class="line">|--------/Range.php·························基础区域对象</span><br><span class="line">|----/Table/</span><br><span class="line">|--------/ExcelBaseOperate.php··············行与列操作方法</span><br></pre></td></tr></table></figure>
<p>完整代码请转<a href="https://gitlab.uuzu.com/songzhp/laravel-excel-merge" target="_blank" rel="noopener">gitlab.uuzu.com/songzhp/laravel-excel-merge</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.slpi1.com/20180325/服务端支持跨域请求.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="slpi1">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="slpi1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/20180325/服务端支持跨域请求.html" itemprop="url">服务端支持跨域请求</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-25T19:45:00+08:00">
                2018-03-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>解决 js 跨域的一种方式是直接在服务端设置允许跨域请求，具体原理及规范可以参考<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS" target="_blank" rel="noopener">HTTP 访问控制（ CORS ）</a>。问题的关键在于，在创建跨域请求时，请求首部会带上额外信息，这部分不需要手动设置；服务端接收到跨域请求后，设置必要的响应首部信息，完成跨域的请求。</p>
<p>具体设置如下：</p>
<ul>
<li><p>Apache</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Header set Access-Control-Allow-Origin *</span><br><span class="line">Header add Access-Control-Allow-Headers &quot;origin, content-type, authorization&quot;</span><br><span class="line">Header always set Access-Control-Allow-Methods &quot;POST, GET, PUT, DELETE, OPTIONS&quot;</span><br><span class="line">Header set Access-Control-Allow-Credentials true</span><br></pre></td></tr></table></figure>
</li>
<li><p>Nginx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add_header &apos;Access-Control-Allow-Origin&apos; &apos;*&apos;;</span><br><span class="line">add_header &apos;Access-Control-Allow-Credentials&apos; &apos;true&apos;;</span><br><span class="line">add_header &apos;Access-Control-Allow-Headers&apos; &apos;Authorization,Origin,Content-Type&apos;;</span><br><span class="line">add_header &apos;Access-Control-Allow-Methods&apos; &apos;GET,POST,PUT,DELETE,OPTIONS&apos;;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>如果需要限制能进行跨域请求的域，在 <code>nginx</code> 中可以进行如下设置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">set $set_cross_origin &apos;http://www.a.com&apos;;</span><br><span class="line">if ($http_origin ~* &apos;https?://(api.a.lar|localhost:4200)&apos;) &#123;</span><br><span class="line">    set $set_cross_origin &quot;$http_origin&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">add_header &apos;Access-Control-Allow-Origin&apos; &apos;$set_cross_origin&apos;;</span><br><span class="line">add_header &apos;Access-Control-Allow-Credentials&apos; &apos;true&apos;;</span><br><span class="line">add_header &apos;Access-Control-Allow-Headers&apos; &apos;Authorization,Origin,Content-Type&apos;;</span><br><span class="line">add_header &apos;Access-Control-Allow-Methods&apos; &apos;GET,POST,PUT,DELETE,OPTIONS&apos;;</span><br></pre></td></tr></table></figure></p>
<p><strong>注意</strong><br>在服务器是 <code>nginx</code> 时，当响应状态码为40x、50x等错误码时，指令 <code>add_header</code> 会失效。<br>如果 <code>nginx</code> 的版本大于 1.7.5，可以指定第三个参数 <code>always</code> 来修正这问题；如果版本比较低，需要加入其它模块来完成响应首部信息的添加。具体可以参考<a href="http://nginx.org/en/docs/http/ngx_http_headers_module.html" target="_blank" rel="noopener">Module ngx_http_headers_module</a>、<a href="https://www.nginx.com/resources/wiki/modules/headers_more/" target="_blank" rel="noopener">Headers More</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.slpi1.com/20171219/2017年终总结.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="slpi1">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="slpi1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/20171219/2017年终总结.html" itemprop="url">2017年终总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-19T15:50:00+08:00">
                2017-12-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="工作成绩"><a href="#工作成绩" class="headerlink" title="工作成绩"></a>工作成绩</h2><p>2017年主要参与了SDK的维护与升级，H5SDK的开发与维护，聚合SDK的开发与维护，说说英语的相关功能的参与。</p>
<h2 id="经验教训"><a href="#经验教训" class="headerlink" title="经验教训"></a>经验教训</h2><p>SDK的维护与升级，从第一版到第二版有很大的改进。第一是用户体系的升级：经历了从用户名登录到用户名或手机登录的的过程。这一功能的改进，主要是为了解决用户名密码注册流程繁琐，随机注册容易忘记账号的问题。通过手机直接注册，一来可以省去输入密码的环节，二来可以解决用户忘记账号的情况。我觉的在实现过程中出现了一些状况，主要是用户名和手机两个字段的冲突问题。应该一开始就区分注册的来源与登录的来源，比如通过验证码的话，必然是通过手机号进行的操作，那么与之对应的唯一标示字段就是mobile，如果是通过密码进行的操作，与之对应的唯一标示就是用户名。执行这一策略也许会在操作流程上引入一些环节，但是可以避免在系统中引入bug的可能。第二是新增游戏盒子的功能，盒子的定制功能的引入，如果要贯彻下去，应该是要有很大的技术资源投入的，否则不足以支撑比较广泛的定制需求，而基础的定制功能对需求方来说会比较鸡肋。所以现在盒子基本上是只有自己在使用的一个功能。第三是关于SDK后台的问题，随着项目的扩大，功能的增多，后台集成的功能越来越多，对于非技术的使用者来说，不一定了解每一个功能如何使用，对于新进来的管理员来说，需要重复的教。从角色的功能的角度出发，可以按照每个角色的权限范围来做一套系统的使用说明文档。</p>
<p>H5SDK基于SDK已有的功能来进行。由于一开始对目标与需求的不明确导致后续的一系列问题。第一是h5的回调通知与原有游戏App的回调通知格式不一致，导致在与游戏厂商对接的过程中需要做两份不同的文档，给对接的过程增加困扰。第二是一开始没有考虑到h5游戏同时会有App包的情况，在分发的环节出现两个入口的问题，一个apk下载入口，一个web在线入口，并且在对接的时候游戏方要对接两套文档。而且现在已经累积了很多上线的H5游戏，从根本上来解决这个问题变得比较困难了。</p>
<p>在开发H5SDK的过成功，使用到了前端框架VUE，掌握了基本的使用。VUE适用于前端驱动的项目，需要分离前后端，与App的通讯类似，但是由于浏览器端的开放性，在浏览器端做比较复杂的加密并不现实，需要引入其他的安全保障机制。关于VUE的一些使用心得，有一下几点</p>
<ul>
<li>比较轻量级，有比较全面的中文文档支持，入门比较方便。</li>
<li>在项目构架层面没有做出太多规范，如果使用者在这一方面的能力不足，会随着项目规模的扩大变得越来越难维护。</li>
<li>建议在一些小的项目中做尝试，累积经验。</li>
</ul>
<p>在做聚合SDK的开发前期，对这一项目的目标与流程有一个完整深入的了解，结合前期SDK开发过程中的经验，规避了一下可能会踩到的坑。项目开发过程中，始终贯彻的一个理念是解构。解构整个流程分为两大部分，与渠道的对接和与CP的对接。两个过程由两个相互解耦的模块负责：<code>AgentSdk</code>/<code>PSdk</code>。<code>AgentSdk</code> 负责平台与渠道的对接过程中的签名、验签、参数转换等功能。<code>PSdk</code>负责与CP对接过程中的签名、验签、参数转换等功能。开发过程中先按照思路整理出必要的文档，随着项目的推进不断对文档进行修改与完善。最终开发完毕，重复使用文档到内部对接、外部对接的过程中去，是一次比较愉快的编程体验。</p>
<p>由于前期需求中有web聊天的功能，找到了一些开源的框架来完成，期间接触到Angular。Angular与VUE是统一类框架。关于Angular的一下使用心得：</p>
<ul>
<li>Angular新版本是基于TypeScript来实现，对开发者更友好。</li>
<li>Angular框架本身包含了很多模块与组件，功能非常强大。</li>
<li>Angular框架本身在项目构架层面做了很多的工作，开发过程中参考文档来实现，可以是项目进展更顺利，对于大型的前端项目来说是比较好的选择。</li>
</ul>
<p>在工作之余了解了一下laravel，并阅读了部分模块的源码，对laravel有了一个比较基础的认识。laravel借鉴了很多其他语言的优秀框架的实现，包括container，provider这些概念，以及依赖注入的实现等等。laravel的编码非常规范，用到的一些设计模式和一些编程技巧，用很大的使用价值。即使不能使用到项目中，也建议有时间去了解一下，是非常好的学习资料。</p>
<h2 id="今后打算"><a href="#今后打算" class="headerlink" title="今后打算"></a>今后打算</h2><p>多学多看多动手，敢于尝试，从各个方面积极寻找可以提升工作效率的更好的手段。</p>
<h2 id="个人建议"><a href="#个人建议" class="headerlink" title="个人建议"></a>个人建议</h2><ul>
<li>线下小组分享的内容要讨论提取精华后运用到工作中去。</li>
<li>可以尝试将前后分离的实践</li>
<li>API通讯过程中可以采用其他的安全措施，目前RSA的加密方式，对于带参数调试的情况支持不够。</li>
<li>API版本与文档的管理</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.slpi1.com/20161015/php返回json数据，int型字段显示为string型的问题.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="slpi1">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="slpi1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/20161015/php返回json数据，int型字段显示为string型的问题.html" itemprop="url">php返回json数据，int型字段显示为string型的问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-15T20:36:00+08:00">
                2016-10-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>开发过程中遇到，同一个接口在不同环境下返回格式不一致的问题。由于前端使用TypeScript开发，对数据类型敏感，本来应该是int型的数据，接口返回格式表示却为string型，导致运行报错。</p>
<p>由于在本地测试没有问题，在服务端返回错误，基本确定为开发环境导致的错误。通过在网上搜索相关类型的问题，得出是 <code>mysql</code> 引擎返回数据时导致的问题。<br>可能导致该问题的原因有：</p>
<ul>
<li><code>PDO</code> 进行链接时的参数设置：<code>ATTR_EMULATE_PREPARES = false</code>, <code>ATTR_STRINGIFY_FETCHES = false</code></li>
<li><code>php</code> 扩展安装不正确：<code>php-mysql</code> 扩展换成 <code>php-mysqlnd</code></li>
</ul>
<p>本人遇到的情况属于第二种，第一种情况并未做进一步测试，替换成功后问题解决。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum remove php71w-mysql &amp;&amp; yum install -y php71w-mysqlnd</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.slpi1.com/20160819/sealtalk用户相关接口.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="slpi1">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="slpi1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/20160819/sealtalk用户相关接口.html" itemprop="url">用户相关接口</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-08-19T15:10:00+08:00">
                2016-08-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          sealtalk用户相关接口文档
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/20160819/sealtalk用户相关接口.html">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.slpi1.com/20160519/php的引用.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="slpi1">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="slpi1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/20160519/php的引用.html" itemprop="url">php 中的引用计数、写时复制、写时改变</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-05-19T10:21:00+08:00">
                2016-05-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>php 中的这三个概念涉及到php 变量的实现，<a href="http://www.laruence.com/2008/08/22/412.html" target="_blank" rel="noopener">zval结构</a>:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">typedef struct _zval_struct &#123;</span><br><span class="line">    zvalue_value value;  // 保存变量的值</span><br><span class="line">    zend_uint refcount;  // 变量引用数</span><br><span class="line">    zend_uchar type;     // 变量类型</span><br><span class="line">    zend_uchar is_ref;   // 是否引用</span><br><span class="line">&#125; zval;</span><br></pre></td></tr></table></figure></p>
<p>其中，<code>refcount、is_ref</code>是问题的主角。</p>
<h2 id="引用计数"><a href="#引用计数" class="headerlink" title="引用计数"></a>引用计数</h2><ul>
<li>例一<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">   $var = 1;</span><br><span class="line">   $var_dup = $var;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>在上述代码中，第一行创建一个变量$var，并为其赋值1。实际上是创建了一个zval 的数据结构，并将变量$var 与之关联，此时zval 的 refcount=1。第二行将变量$var 赋值给新的变量$var_dump，在这一步中，$var_dump实际上也是与前文中的zval 数据结构进行关联，refcount加一。引用计数在赋值的时候发生。这样处理的结果是可以节省内存开销。<br>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/20160519/php的引用.html#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.slpi1.com/20151005/php与curl.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="slpi1">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="slpi1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/20151005/php与curl.html" itemprop="url">php的curl使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2015-10-05T10:36:00+08:00">
                2015-10-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          php，curl
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/20151005/php与curl.html">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="slpi1" />
          <p class="site-author-name" itemprop="name">slpi1</p>
           
              <p class="site-description motion-element" itemprop="description">PHP,Laravel,thinkPHP,javascript,css</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">37</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">slpi1</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

</body>
</html>
